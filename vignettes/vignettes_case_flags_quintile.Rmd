---
title: "case_flags"
author: "Marlin"
date: '2022-07-27'
output: pdf_document
editor_options: 
  chunk_output_type: inline
---


```{r set up markdown settings, echo=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	echo = FALSE
)
```

```{r assemble case dataframe}
#TODO
#get all data frames to have the same names
#Separate classification from regression
#quantile 
#
#code for Case flag
#code for waste flag
#how to best explore the relationship
```

```{r create case data in right format}
library(DSIWastewater)
data(Case_data, package = "DSIWastewater")


Case_DF <- buildCaseAnalysisDF(Case_data)

Case_DF <- Case_DF[Case_DF$Site == "Madison",]

Case_DF <- Case_DF[Case_DF$date  >= as.Date("2021-02-01"),]
```

```{r create case flags}

#add pipe level comments
#break up pipes?
#create case flags
#add tokeep parameter
#current process:

#prep -> regression -> classification

#get 7 day slope of data
CaseRegressionOutput <- buildRegressionEstimateTable(DataMod = Case_DF,
                             RunOn = "FirstConfirmed.Per100K",
                             SplitOn = "Site",
                             DaysRegressed = 7,
                             PSigTest = FALSE)

CaseFlagOutput <- ClassifyCaseRegression(CaseRegressionOutput)
```

```{r}
data(WasteWater_data, package = "DSIWastewater")

baseWaste_data <- buildWasteAnalysisDF(WasteWater_data)

baseWaste_data <- baseWaste_data[baseWaste_data$date >= as.Date("2021-02-01"),]

baseWaste_data <- baseWaste_data[baseWaste_data$WWTP == "Madison MSD WWTF",]


windows <- c(14, 30, 60 , 90)

quants <- c(5:9)/10

#as.Date, as.Date.numeric
Quantiles_DF <- MakeQuantileColumns(baseWaste_data,
                                    quants, windows,
                                    "sars_cov2_adj_load_log10")

Quantiles_DF <- Quantiles_DF[,c("WWTP", "date",
                                "pastKavg.wwlog10",
                                "window", "quant", "ntile")]

CDCMethod <- buildRegressionEstimateTable(baseWaste_data,
                                          PSigTest=FALSE)

CDCMethod <- CDCMethod[,c("WWTP", "date",
                          "lmreg_sig",  "Catagory",
                          "modeled_percentchange")]

FULL_reg_DF <- dplyr::full_join(Quantiles_DF, CDCMethod,
                         by = c("WWTP", "date"))

FULL_reg_DF <- ClassifyQuantileFlagRegression(FULL_reg_DF)
```

```{r Merge flag data frames}
names(CaseFlagOutput)[names(CaseFlagOutput) == 'Site'] <- 'WWTP'
  
CaseFlags <- CaseFlagOutput[,c("WWTP", "date", "case_flag",
                    "case_flag_plus_comm.threshold",
                    "slope_switch_flag")]

FULL_reg_DF$WWTP <- ifelse(FULL_reg_DF$WWTP == "Madison MSD WWTF",
                           "Madison",
                           FULL_reg_DF$WWTP)
  
Full_wasteFlags <- FULL_reg_DF[,c("WWTP", "date", "window",
                          "quant", "cdc_flag", "flag_ntile",
                          "flag_ntile_pval")]

Full_Flag_DF <- dplyr::inner_join(Full_wasteFlags, CaseFlags,
                           by = c("WWTP", "date"))
Full_Flag_DF

```

```{r plot case and waste flags}
library(ggplot2)
library(dplyr)
#Two plot functions
#stacked plot
#single plot 
#have the ability to run on multiple sites
colorScheme <- scale_color_manual(values = c("Case flag" = "red",
                                "Waste flag" = "blue",
                                "Both" = "green",
                                "7 day average" = "deeppink")) 

A <- Case_DF%>%
  ggplot(aes(x = date))+
  geom_point(aes(y=FirstConfirmed.Per100K), size = .5) +
  geom_vline(aes(xintercept = date, color = "Case flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == .8, window == 90, flag_ntile == 0))+
  geom_vline(aes(xintercept = date, color = "Waste flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==0, 
                           quant == .8, window == 90, flag_ntile == 1))+
  geom_vline(aes(xintercept = date, color = "Both"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == .8, window == 90, flag_ntile == 1))+
  ylab("Case data") +
  ggtitle("Case data with slope_switch flags")+
  scale_y_continuous(limits = c(0, 700))+
  colorScheme

B <- baseWaste_data%>%
  ggplot(aes(x = date))+
  geom_point(aes(y=sars_cov2_adj_load_log10), size = .5) +
  geom_vline(aes(xintercept = date, color = "Case flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == .8, window == 90, flag_ntile == 0))+
  geom_vline(aes(xintercept = date, color = "Waste flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==0, 
                           quant == .8, window == 90, flag_ntile == 1))+
  geom_vline(aes(xintercept = date, color = "Both"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == .8, window == 90, flag_ntile == 1))+
  ylab("WasteData")+
  colorScheme

patchwork::wrap_plots(A,B, ncol = 1)

#give case data, waste data, flag data - output stacked scatter plot
#Stacked_plot_flag(baseWaste_DF, Case_DF, Full_Flag_DF)

#give case data, waste data, flag data - output single scatter plot
#Combo_plot_flag(baseWaste_DF, Case_DF, Full_Flag_DF)
```


```{r shiny view of the problem, eval = FALSE}
#in package
#createCaseflag
#createWasteflag
#call common regression code
#wastedata/some smoothing of waste data
#how well does the case flags/waste flags work
#for madison for state
#how well do they do, at predicting own goals, each other
colorScheme <- scale_color_manual(values = c("Case flag" = "red",
                                "Waste flag" = "blue",
                                "Both" = "green",
                                "7 day average" = "deeppink")) 

library(shiny)
windows <- c(14, 30, 60 , 90)
quants <- c(5:9)/10
ui <- fluidPage(
    selectInput(inputId = "Window", 
              label = "choose Wastewater Window", 
              choices = windows,
              selected = 90),
    selectInput(inputId = "quants", 
              label = "choose Wastewater quants", 
              choices = quants,
              selected = .8),
    dateRangeInput("daterange", "Select date range:", start = min(Full_Flag_DF$date), end = max(Full_Flag_DF$date),
                   min = min(Full_Flag_DF$date),
                   max = max(Full_Flag_DF$date),
                   startview = "year"),
    checkboxInput("isLogCase", "log case data", value = FALSE),
  plotOutput(outputId = "Flag_Compare_plot", width="100%")#, height="")

)

server <- function(input, output, session) {
  
  output$Flag_Compare_plot <- renderPlot({
    
    FlagDF <- Full_Flag_DF%>%
      filter(quant == input$quants, window == input$Window)
    
    A <- Case_DF%>%
      filter(date >= input$daterange[1] & date <= input$daterange[2])%>% #filter using date range
  ggplot(aes(x = date))+
  geom_point(aes(y=FirstConfirmed.Per100K), size = .5) +
  geom_line(aes(y=pastwk.sum.casesperday.Per100K/7, color = "7 day average"))+

  geom_vline(aes(xintercept = date, color = "Case flag"),
             data = filter(FlagDF, slope_switch_flag==1, 
                           flag_ntile == 0))+
  geom_vline(aes(xintercept = date, color = "Waste flag"),
             data = filter(FlagDF, slope_switch_flag==0, 
                           flag_ntile == 1))+
  geom_vline(aes(xintercept = date, color = "Both"),
             data = filter(FlagDF, slope_switch_flag==1, 
                           flag_ntile == 1))+
  ylab("Case data") +
  ggtitle("Case data with slope_switch flags")+
  colorScheme
    
    if(input$isLogCase){
      A <- A+scale_y_log10()
    }

B <- baseWaste_data%>%
  filter(date >= input$daterange[1] & date <= input$daterange[2])%>% #filter using date range
  ggplot(aes(x = date))+
  geom_point(aes(y=sars_cov2_adj_load_log10), size = .5) +
  geom_vline(aes(xintercept = date, color = "Case flag"),
             data = filter(FlagDF, slope_switch_flag==1, 
                           flag_ntile == 0))+
  geom_vline(aes(xintercept = date, color = "Waste flag"),
             data = filter(FlagDF, slope_switch_flag==0, 
                           flag_ntile == 1))+
  geom_vline(aes(xintercept = date, color = "Both"),
             data = filter(FlagDF, slope_switch_flag==1, 
                           flag_ntile == 1))+
  ylab("Waste Data")+
  colorScheme

patchwork::wrap_plots(A,B, ncol = 1)
  })
}

shinyApp(ui = ui, server = server)


```