---
title: "case_flags"
author: "Marlin"
date: '2022-07-27'
output: pdf_document
editor_options: 
  chunk_output_type: inline
---


```{r set up markdown settings, echo=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	echo = FALSE
)
```

```{r assemble case dataframe}
#TODO
#get all data frames to have the same names
#Separate classification from regression
#quantile 
#
#code for Case flag
#code for waste flag
#how to best explore the relationship

library(ggplot2)
library(dplyr)
library(zoo)
library(tidyr)
```

```{r create case data in right format}
library(DSIWastewater)
data(Case_data, package = "DSIWastewater")

Case_DF <- buildCaseAnalysisDF(Case_data)

Case_DF <- Case_DF[Case_DF$Site == "Madison",]

Case_DF <- Case_DF[Case_DF$date  >= as.Date("2021-02-01"),]

```

```{r create case flags}

#add pipe level comments
#break up pipes?
#create case flags
#add tokeep parameter
#current process:

#prep -> regression -> classification

#get 7 day slope of data
CaseFlagOutput <- buildRegressionEstimateTable(DataMod = Case_DF,
                             RunOn = "FirstConfirmed.Per100K",
                             SplitOn = "Site",
                             DaysRegressed = 7,
                             PSigTest = FALSE)

CaseFlagOutput <- CaseFlagOutput%>%
  rename(FirstConfirmed.Per100K = value)%>%
  #add case flags
  ClassifyCaseRegression()
```


```{r assemble wastewater dataframe}
data(WasteWater_data, package = "DSIWastewater")

baseWaste_data <- buildWasteAnalysisDF(WasteWater_data)%>%
  filter(date  >= as.Date("2021-02-01"))%>%
  filter(WWTP == "Madison MSD WWTF")
```


```{r waste flags}
PureQuantileApply <- function(DF, window, quant){
  RetDF <- DF%>%
    arrange(date)%>%
    mutate(ntile = rollapply(sars_cov2_adj_load_log10, 
                              width = window, FUN = quantile, 
                              probs  = quant, align = "right", 
                              na.rm=T, fill=NA, 
                              names = FALSE),
           quant = quant)
  return(RetDF)
}

GroupQuant <- function(DF, window, quants){
  RetDF <- DF%>%
    mutate(window = window)%>%
    lapply(quants, PureQuantileApply, DF = ., window = window)%>%
    bind_rows()
  return(RetDF)
}

WindowingFunc <- function(DF, windows, quants){
  mindate <- min(DF$date)
  maxdate <- max(DF$date)
  dateTOMERGEVec <- data.frame(date = seq(mindate, maxdate, 1))
  K = 3
  RetDF <- full_join(DF, dateTOMERGEVec)%>%
    lapply(windows, GroupQuant, DF = ., quants = quants)%>%
    bind_rows()%>%
    mutate(pastKavg.wwlog10 = rollmean(sars_cov2_adj_load_log10, K, align = "right", na.pad = T))
  return(RetDF)
}
```
  
```{r}
data(WasteWater_data, package = "DSIWastewater")

baseWaste_data <- buildWasteAnalysisDF(WasteWater_data)%>%
  filter(date  >= as.Date("2021-02-01"))%>%
  filter(WWTP == "Madison MSD WWTF")


windows <- c(14, 30, 60 , 90)
quants <- c(5:9)/10

Quantiles_DF <- baseWaste_data%>%
  split(baseWaste_data$WWTP)%>%
  lapply(WindowingFunc, quants = quants, windows = windows)%>%
  bind_rows()%>%
  filter(!is.na(sars_cov2_adj_load_log10))%>%
  select(WWTP, date, window, pastKavg.wwlog10, quant, ntile)

CDCMethod <- baseWaste_data%>%
  buildRegressionEstimateTable(PSigTest=FALSE)%>%
  select(WWTP, date,lmreg_sig,  Catagory)

pval = .3

FULL_reg_DF <- full_join(Quantiles_DF, CDCMethod, by = c("WWTP", "date"))%>%
  mutate(cdc_flag = case_when(Catagory == "major increase"~ 1,
                              TRUE ~ 0),
         flag_ntile = case_when(pastKavg.wwlog10 > ntile & cdc_flag ~ 1,
                              TRUE ~ 0),
         flag_ntile_pval = case_when(flag_ntile & lmreg_sig < pval ~ 1,
                              TRUE ~ 0))%>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.x), 0, .x)))
```


```{r Merge flag data frames}
CaseFlags <- CaseFlagOutput%>%
  rename(WWTP = Site)%>%
  select(WWTP, date, case_flag, case_flag_plus_comm.threshold, slope_switch_flag)

Full_wasteFlags <- FULL_reg_DF%>%
  mutate(WWTP = ifelse(WWTP == "Madison MSD WWTF","Madison",WWTP))%>%
  select(WWTP, date, window, quant, cdc_flag, flag_ntile, flag_ntile_pval)#%>%
  #pivot_wider(names_from = c(window, quant), values_from = c(flag_ntile, flag_ntile_pval))

Full_Flag_DF <- inner_join(Full_wasteFlags, CaseFlags, by = c("WWTP", "date"))
Full_Flag_DF
```

```{r plot case and waste flags}
A <- Case_DF%>%
  ggplot(aes(x = date))+
  geom_point(aes(y=FirstConfirmed.Per100K), size = .5) +
  geom_vline(aes(xintercept = date, color = "Case flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == .8, window == 90, flag_ntile == 0))+
  geom_vline(aes(xintercept = date, color = "Waste flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==0, 
                           quant == .8, window == 90, flag_ntile == 1))+
  geom_vline(aes(xintercept = date, color = "Both"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == .8, window == 90, flag_ntile == 1))+
  ylab("Case data") +
  ggtitle("Case data with slope_switch flags")+
  scale_y_continuous(limits = c(0, 700))+
  scale_y_log10()

B <- baseWaste_data%>%
  ggplot(aes(x = date))+
  geom_point(aes(y=sars_cov2_adj_load_log10), size = .5) +
  geom_vline(aes(xintercept = date, color = "Case flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == .8, window == 90, flag_ntile == 0))+
  geom_vline(aes(xintercept = date, color = "Waste flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==0, 
                           quant == .8, window == 90, flag_ntile == 1))+
  geom_vline(aes(xintercept = date, color = "Both"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == .8, window == 90, flag_ntile == 1))+
  ylab("WasteData")#+
  #scale_y_log10()
patchwork::wrap_plots(A,B, ncol = 1)
```


```{r shiny view of the problem, eval = FALSE}
#in package
#createCaseflag
#createWasteflag
#call common regression code
#wastedata/some smoothing of waste data
#how well does the case flags/waste flags work
#for madison for state
#how well do they do, at predicting own goals, each other


library(shiny)
windows <- c(14, 30, 60 , 90)
quants <- c(5:9)/10
ui <- fluidPage(
    selectInput(inputId = "Window", 
              label = "choose Wastewater Window", 
              choices = windows,
              selected = 90),
    selectInput(inputId = "quants", 
              label = "choose Wastewater quants", 
              choices = quants,
              selected = .8),
    dateRangeInput("daterange", "Select date range:", start = min(Full_Flag_DF$date), end = max(Full_Flag_DF$date), min = min(Full_Flag_DF$date), max = max(Full_Flag_DF$date), startview = "year"),
  plotOutput(outputId = "Flag_Compare_plot", width="100%")#, height="")

)

server <- function(input, output, session) {
  
  output$Flag_Compare_plot <- renderPlot({
    A <- Case_DF%>%
      filter(date >= input$daterange[1] & date <= input$daterange[2])%>% #filter using date range
  ggplot(aes(x = date))+
  geom_point(aes(y=FirstConfirmed.Per100K), size = .5) +
  geom_vline(aes(xintercept = date, color = "Case flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == input$quants, window == input$Window, flag_ntile == 0))+
  geom_vline(aes(xintercept = date, color = "Waste flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==0, 
                           quant == input$quants, window == input$Window, flag_ntile == 1))+
  geom_vline(aes(xintercept = date, color = "Both"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == input$quants, window == input$Window, flag_ntile == 1))+
  ylab("Case data") +
  ggtitle("Case data with slope_switch flags")+
  scale_y_continuous(limits = c(0, 700))+
  scale_y_log10()

B <- baseWaste_data%>%
  filter(date >= input$daterange[1] & date <= input$daterange[2])%>% #filter using date range
  ggplot(aes(x = date))+
  geom_point(aes(y=sars_cov2_adj_load_log10), size = .5) +
  geom_vline(aes(xintercept = date, color = "Case flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == input$quants, window == input$Window, flag_ntile == 0))+
  geom_vline(aes(xintercept = date, color = "Waste flag"),
             data = filter(Full_Flag_DF, slope_switch_flag==0, 
                           quant == input$quants, window == input$Window, flag_ntile == 1))+
  geom_vline(aes(xintercept = date, color = "Both"),
             data = filter(Full_Flag_DF, slope_switch_flag==1, 
                           quant == input$quants, window == input$Window, flag_ntile == 1))+
  ylab("WasteData")#+
  #scale_y_log10()
patchwork::wrap_plots(A,B, ncol = 1)
  })
}

shinyApp(ui = ui, server = server)


```