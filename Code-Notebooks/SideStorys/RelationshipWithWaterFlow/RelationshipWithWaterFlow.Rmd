---
params:
  BaseDir: "Z:/"
  ##BaseDir: "/Volumes/byandell/"
title: "Relationship with WaterFlow"
author: "Marlin"
date: "10/1/2021"
output: html_document
knit: (
  function(inputFile, encoding) { 
    FileComp = strsplit(inputFile,"/")[[1]];
    File = FileComp[length(FileComp)];
    File = substr(File,1,nchar(File)-4);
    pSubTitle <- paste0('RmdOutput/',Sys.Date(),"_",File);
    rmarkdown::render( 
      input       = inputFile, 
      encoding    = encoding, 
      output_file = pSubTitle) })
---

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = TRUE)
```

```{r Start enviroment, include=FALSE}
library(ggpubr)
library(forecast)
library(lmtest)
library(lubridate)
library(limma)
library(zoo)
library(dplyr)
library(readxl)
library(stringr)

#Data Files and prep work
source("../../../lib/GenPlotMaking.R")
source("../../../lib/DataProccess.R")
source("../../../lib/HelperFunctions.R")
source("../../../lib/DataPathName.R")
```

```{r Data processing, echo=FALSE}
BaseDir <- params$BaseDir

LIMSFullDF <- ParseData(LIMSWastePath(BaseDir))%>%
  select(Date,Site, N1,N1Error,FlowRate,Pop)
```

"Files Used: "

`r LIMSWastePath(BaseDir)`


On a first pass FlowRate can be used for three purposes.

1) Normalize data across sites.

2) Normalize data within sites

The below show that it is largely useless to use flow to normalize across site because it strongly correlates with population.

```{r pop vs Flow, warning=FALSE}
LIMSFullDF%>%
  filter(!str_detect(Site, "^MMSD"))%>%
  filter(Site!="Madison-P7-SE and P18-NE")%>%
  mutate(FlowRate=as.numeric(FlowRate))%>%
  select(FlowRate,!FlowRate)%>%
  group_by(Site)%>%
  summarise(FlowRate=mean(FlowRate,na.rm=TRUE),Pop=mean(Pop,na.rm=TRUE))%>%
  ggplot()+
  geom_point(aes(x=Pop,y=FlowRate))+
  ggtitle("Nearly Perfect linear relation between Pop and Flowrate")
```


Within this plot show that the day to day variance is much smaller then the Site wide variance so any data process would need to account for that.

```{r Site vs FlowRate}
LIMSFullDF%>%
  ggplot()+
  geom_jitter(aes(x=Site,y=FlowRate))+
  ggtitle("Flowrate grouped by Site")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

When the flow rate is adjusted to have a constant mean and standard deviation no pattern emerges between the relationship between N1 and Flow. 

```{r N1 vs FlowRate adjusted}

LIMSFullDF%>%
  group_by(Site)%>%
  mutate(MeanFlowRate=mean(FlowRate,na.rm=TRUE),sdFlowRate=sd(FlowRate,na.rm=TRUE))%>%
  mutate(FlowRate=(FlowRate-MeanFlowRate)/sdFlowRate)%>%
  ggplot()+
  scale_x_log10()+
  geom_point(aes(x=N1,y=FlowRate),alpha=.1)
```