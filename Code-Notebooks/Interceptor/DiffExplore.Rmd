---
title: "DiffExplore"
author: "Marlin"
date:  "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output:
  #pdf_document: default
  html_document:
    df_print: paged
params:
  BaseDir: Z:/
  #~/Box/DSI/Projects/wastewater/RD/
knit: (
  function(inputFile, encoding) { 
    FileComp = strsplit(inputFile,"/")[[1]];
    File = FileComp[length(FileComp)];
    File = substr(File,1,nchar(File)-4);
    pSubTitle <- paste0('RmdOutput/',Sys.Date(),"_",File);
    rmarkdown::render( 
      input       = inputFile, 
      encoding    = encoding, 
      output_file = pSubTitle) })
  
         
editor_options:
  chunk_output_type: inline
---



```{r}
library(dplyr)
library(lubridate)
library(zoo)
library(ggplot2)
library(limma)
library(ggpubr)
library(grid)
library(plotly)

#Data Files and prep work
source("../../lib/DataProccess.R")
source("../../lib/NormFuncs.R")
source("../../lib/OutlierDetectionFuncs.R")
source("../../lib/DataPathName.R")
BaseDir <- params$BaseDir#get the root of the directory where the data is stored
```

```{r}
SiteNames <- c("Madison","MMSD-P11","MMSD-P18","MMSD-P2","MMSD-P7","MMSD-P8")

#Importing the Madison waste water data
LIMSFullDF <- ParseData(LIMSWastePath(BaseDir))%>%
  filter(Site %in% SiteNames)%>%
  mutate(N1Pure = ifelse(is.na(N1),N1,N1),
         N1Pure = ifelse(is.na(N1),N1,N1),
         GeoMeanN12 = exp((log(N1Pure)+log(N1Pure))/2))%>%
  mutate(SC2_mass = (3.785*1e6)*FlowRate*N1)%>%
  select(Date, Site, N1, BCoV , N2 , SC2_mass, PMMoV,
         GeoMeanN12,FlowRate,temperature,equiv_sewage_amt, everything())


DifDF <- LIMSFullDF%>%
  filter(!is.na(N1))%>%
  group_by(Site)%>%
  arrange(Date)%>%
  mutate(LeadN1 = lead(N1) - N1,
         LagN1 = lag(N1) - N1,
         RankHighN1 = rank(LeadN1),
         RankLowN1 = rank(LagN1),
         LeadN2 = lead(N2) - N2,
         LagN2 = lag(N2) - N2,
         RankHighN2 = rank(LeadN2),
         RankLowN2 = rank(LagN2))%>%
  select(Site,Date,LeadN1,LagN1,RankHighN1,RankLowN1,RankHighN2,RankLowN2,everything())%>%
  arrange(Site,desc(RankHighN1))

DifRatDF <- LIMSFullDF%>%
  filter(!is.na(N1))%>%
  group_by(Site)%>%
  arrange(Date)%>%
  mutate(LeadN1 = lead(N1)/N1,
         LagN1 = lag(N1)/N1,
         RankHighN1 = rank(LeadN1),
         RankLowN1 = rank(LagN1),
         LeadN2 = lead(N2)/N2,
         LagN2 = lag(N2)/N2,
         RankHighN2 = rank(LeadN2),
         RankLowN2 = rank(LagN2))%>%
  select(Site,Date,LeadN1,LagN1,RankHighN1,RankLowN1,RankHighN2,RankLowN2,everything())%>%
  arrange(Site,desc(RankHighN1))

```

"Files Used: "

`r LIMSWastePath("")`

```{r}
hist((DifDF$LagN1))
hist(log(DifDF$LagN1))


hist((DifRatDF$LagN1))
hist(log(DifRatDF$LagN1))

```


```{r}
#DifRatDF
#DifDF
hist((DifDF$LagN1))
hist((DifRatDF$LagN1))

DiffPlot <- DifDF%>%
  ggplot()+
  geom_point(aes(x = Date,y = LagN1, color = LagN2))
ggplotly(DiffPlot)

DiffPlot <- DifRatDF%>%
  ggplot()+
  geom_point(aes(x = Date,y = log(LagN1), color = LagN2))
ggplotly(DiffPlot)


DifDF%>%
  ggplot()+
  geom_point(aes(x = log(PMMoV), y = LagN1,color = Site))+
  facet_wrap(~Site, scales = "free")
  
  DifDF%>%
  ggplot()+
  geom_point(aes(x = equiv_sewage_amt, y = LagN1,color = Site))#+
  #facet_wrap(~Site, scales = "free")
#PMMoV, FlowRate, equiv_sewage_amt
#

DifDF%>%
  #filter(Site != "Madison")%>%
  ggplot()+
  geom_point(aes(x = N1Error,y = RankLowN1))+
  facet_wrap(~Site, scales = "free")

#Come up with list top 10, 20, 50
```


```{r Interactive highlighting}
#Create GGPlotly object with consistent scale for alpha, size, color
GGPlotlyWithScaling <- function(GGPlotObject, FactorSize){
  AlphaScalling <- scale_alpha_manual(values = seq(.5,1, length.out = FactorSize))
  SizeScalling <- scale_size_manual(values = seq(1,2, length.out = FactorSize))
  ColorScalling <- scale_color_manual(values = 
                                  c("#fee391", "#fec44f", "#fe9929",
                                  "#d95f0e", "#993404", "#6f2f04")[1:FactorSize])
  PlotlyObject <- GGPlotObject+
    AlphaScalling+
    SizeScalling+
    ColorScalling
  return(ggplotly(PlotlyObject))
}

#Helper Function To create bins
SumQuint <- function(Vec,Thresh){
  return(sum(Vec>Thresh))
}

#Break Data into bins based on ranking and given threshold
QuintileBound <- function(DF,VecName,Threshold,Name){
  ReturnedDF <- DF%>%
    group_by(Site)%>%
    mutate(TempRanking = rank(!!sym(VecName))/n(),
           !!Name := factor(sapply(TempRanking, SumQuint, Thresh = Threshold)))
  ReturnedDF <- ReturnedDF%>%
    select(-TempRanking)%>%
    select(Date,Site,!!Name,everything())
  return(ReturnedDF)
}

#Generate two plotly objects to view the Method 
#and a data table communicating classes
PlotlyView <- function(DF, DefaultVar,ChangeVar, FlagMethod,...){
  #Creates the bin from given function
  MainDF <- FlagMethod(DF, VecName = ChangeVar, Name = "FlagScheme", ...)
  
  #Create shared GGplot object that both use
  CorePlot <- MainDF%>%
    ggplot(aes(x = Date))
  
  #Create plot where The scheme is plotted
  DiffPlot <- CorePlot+
    geom_point(aes(y = !!sym(ChangeVar), color = FlagScheme,
                   alpha = FlagScheme, size = FlagScheme))+
    facet_wrap(~Site)
  
  #Needed for correct manual scaling in GGPlotlyWithScaling
  FactorSize <- length(unique(MainDF[["FlagScheme"]]))
  
  #Create plot where The CoreVector is plotted
  DiffPlotNorm <- CorePlot+
    geom_point(aes(y = !!sym(DefaultVar), color = FlagScheme,
                   alpha = FlagScheme, size = FlagScheme))+
    facet_wrap(~Site)
  
  #Return The Two plots
  print(GGPlotlyWithScaling(DiffPlot, FactorSize))
  print(GGPlotlyWithScaling(DiffPlotNorm, FactorSize))
  
  #Create DataFrame showing The bounds for the binning
  DFRange <- MainDF%>%
    group_by(FlagScheme, Site)%>%
    summarise(MinBound = min(!!sym(ChangeVar), na.rm = TRUE),
              MaxBound = max(!!sym(ChangeVar), na.rm = TRUE),
              NumInBin = n())
  return(DFRange)
}



DiffGen <- LIMSFullDF%>%
  filter(!is.na(N1), Site != "Madison")%>%
  group_by(Site)%>%
  arrange(Date)%>%
  mutate(
          DiffLeadN1 = lead(N1) - N1,
          RatLeadN1 = lead(N1)/N1,
          ChangeLeadN1 = abs(lead(N1) - N1),
          ChangeLagN1 = abs(lag(N1) - N1),
          ChangeMinN1 = pmin(ChangeLeadN1,ChangeLagN1)
          )%>%
  select(Date,Site,N1,ChangeLeadN1,DiffLeadN1,RatLeadN1, ChangeMinN1)%>%
  arrange(Site, Date)

BreakUsed <- c(.2,.4,.6,.8,.9)

PlotlyView(DiffGen, "N1", "DiffLeadN1", QuintileBound, Threshold = BreakUsed)
PlotlyView(DiffGen, "N1", "RatLeadN1", QuintileBound, Threshold = BreakUsed)
PlotlyView(DiffGen, "N1", "ChangeLeadN1", QuintileBound, Threshold = BreakUsed)
PlotlyView(DiffGen, "N1", "ChangeMinN1", QuintileBound, Threshold = BreakUsed)


```