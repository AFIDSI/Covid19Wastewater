---
title: "WasteWater Analysis 2.0"
author: "Steve Goldstein and Marlin Lee"
output: slidy_presentation
---


```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE,warning = FALSE)
knitr::opts_chunk$set(fig.width=8, fig.height=5) 
library(ggpubr)
library(dplyr)
library(limma)

#Data Files and prep work
source("../../Scripts/GenPlotMaking.R")
source("../../Scripts/WasteWaterDataProccess.R")
source("../../Scripts/CassesDataProccess.R")
source("../../Scripts/HelperFunctions.R")


source("../../Scripts/WasteShiny/PrepData.R", local = TRUE)

```



```{r start up, include=FALSE}

HFGPop=read.csv("../../../UntrackedData/HFGPop.csv.txt")%>%
  select(Site=wwtp_name,Population=pop_served)


#Preset for graphing
ConfigOption=list(
      myseed=1234567890,
      XAxisLabSiz=10,
      YAxisLabSiz=10,
      GenFontSiz=12,
      alphaPoint=.7,
      PointSize=2,
      alphaWeek=.2)
    
```




```{r, include=FALSE}
DayRolling=7


LatCaseDFRoll=RollPerPos(LatCaseDF,"Cases","Tests",Facet="Site",n=DayRolling)%>%
  select(Date,Site,Cases,Per_pos)#%>%
  #mutate(Date=Date-DayRolling/2)

CasePlotMaking = function(SiteS,Method="Cases"){
  SiteCases=LatCaseDF%>%
    filter(Site==SiteS)

  SiteCasesRoll=LatCaseDFRoll%>%
    filter(Site==SiteS)
  
  LIMSSiteDF=LIMSFullDF%>%
   filter(Site==SiteS)


  Date_lim_long=c(min(LIMSSiteDF$Date),max(LIMSSiteDF$Date))
  
  CasePlot <- Buildplot_gen(
      Method,
      MainDF=SiteCases,
      Loc="Site",
      LineDF=SiteCasesRoll,
      Xfreq="30 days",
      DateLimits=Date_lim_long,
      Standards=ConfigOption,
      AxisPos="bottom",
      LineColor="red",
      Colplot=TRUE) #+ theme(ConfigOption)
  return(CasePlot)
}



LIMSFullDF%>%
  filter(Date<mdy("12/1/2020"))%>%
  arrange(Site)%>%
  group_by(Site)%>%
  summarize(n())
  

```

```{r Loess Model, include=FALSE}
LoessGenerater <- function(Data,weights,Span,min,max){
  if(weights=="Constant"){
    WeightList=rep(1,dim(Data)[1])
  } else if(weights=="N/NSE"){
    WeightList=Data$Indy/Data$Dep
  }
  
  
  loessModel=loessFit(y=Data$Indy,
                         x=Data$Date,
                         weights=WeightList,
                         span=Span,
                         min.weight=min,
                         max.weight=max,
                         iterations=10)
  return(loessModel$fitted)
}



LoessSmoothPlot <- function(SiteS="Madison",
                            Data=LIMSFullDF,
                            Independent="N1",Dependent="N1Error",
                            weights=c("Constant","N/NSE"),
                            Span=.3,min=1e-5,max=1e5,
                            BoxWidth=.5,
                            HasNo=F, Title=T,FullLim=F,SiteLab=T,NoLabel=F){

  LimitLIMSDF=Data%>%
      filter(Site==SiteS)%>%
      mutate(Indy=!!sym(Independent),
             Dep=!!sym(Dependent))%>%
      filter(!is.na(Dep),
             !is.na(Indy),
             Dep>0,
             Indy>0)

    
    LimitLIMSDF$Pred1 <- LoessGenerater(LimitLIMSDF,weights=weights[[1]],Span=Span,min = min,max = max)
    LimitLIMSDF$PredSE <- LoessGenerater(LimitLIMSDF,weights=weights[[2]],Span=Span,min = min,max = max)
    LoessPlot=LimitLIMSDF%>%
      mutate(ErrorMin=Indy-Dep,ErrorMax=Indy+Dep)%>%
          mutate(ErrorMin=ifelse(ErrorMin>0,ErrorMin,0))%>%
          ggplot()+
          aes(x=Date)+
          geom_rect(aes(ymin=ErrorMin,ymax=ErrorMax,xmin=Date-BoxWidth,xmax=Date+BoxWidth),color="black",alpha=.25)+
          geom_rect(aes(ymin=Indy,ymax=Indy,xmin=Date-BoxWidth,xmax=Date+BoxWidth),color="black",alpha=.25)+
          geom_line(aes(y=Pred1,color="1"),size=1.25)+
          geom_line(aes(y=PredSE,color=paste0(Independent,"/",Dependent)),size=1.25)
    if(SiteLab){
      LoessPlot=LoessPlot+facet_wrap(~Site)
    }
    LoessPlot=LoessPlot+
          labs(title="", y=paste0(Independent," (GC/L)"),
               color="Weights Used")+
      #Header_theme(ConfigOption)+
        theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
              axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
              plot.margin = unit(c(0,0,0,0), "cm"))+ 
      theme(legend.position = "bottom")
    
    #Formatting code
    
    PlaceHolder=""
    if(HasNo){
      PlaceHolder="no"
    }
    
    if(Title){
      LoessPlot=LoessPlot+
        ggtitle(paste0("Weighted loess smoothing with ",PlaceHolder," truncation 
                     loessFit(",Independent, " ~ Date, span=",Span,")"))
    }
    if(FullLim){
      XVar=LIMSFullDF$Date
      YVar=pull(LIMSFullDF,Independent)
      XLim <- c(min(XVar),max(XVar))
      YLim <- c(min(YVar[YVar!=0]),max(YVar))
      LoessPlot <- LoessPlot+
        scale_x_date(limits = XLim)+
        scale_y_log10(limits = YLim)
    }else{
      LoessPlot <- LoessPlot+
        scale_y_log10()
    }
    if(NoLabel){
      LoessPlot <- LoessPlot + 
        labs(title="",x="",y="")
        # theme(axis.title.x=element_blank(),
        #     axis.title.y=element_blank())
    }
    return(LoessPlot)
}
#ts.intersect
#ccf
#library(lmtest)
#LIMSMadDF=LIMSFullDF%>%
#  filter(Site=="Madison")
#grangertest(formula=log(N1)~log(N2),data=LIMSMadDF)

```


```{r unused, include=FALSE}
  
# N1PlotGraphic=Buildplot_gen(
#   "N1",
#   MainDF=RelWasteData,
#   LineDF =meanOfN1,
#   Loc="Site",
#   YLabel = "N1 (GC/L)",
#   log_scale=T,
#   ColorType="Filter replicates",
#   DateLimits=Date_lim_HFG,
#   RMOutliers=T,
#   AxisPos="bottom",
#   Standards=ConfigOption,
#   Xfreq="14 days",
#   nrow=2)+ 
#   Header_theme(ConfigOption)+
#       theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
#             axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
#             plot.margin = unit(c(.5,0,0,0), "cm"))+
#   xlab("")
# 
# N1PlotGraphic

```

---

To give some measure of the variation of the data we look at the high frequency data. It shows that outliers often clump with the other filter replicates


```{r HFD VarPrep, echo=FALSE}
SiteOptions2=c("Kenosha","Madison", "Sun Prairie","Wausau")
LimitedHFData=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  group_by(Site,Date,`Filter replicates`)%>%
  mutate(n=n())%>%
  filter(n==3)%>%
  ungroup()%>%
  select(-n)
meanOfN1=LimitedHFData%>%
  group_by(Site,Date)%>%
  summarise(N1=exp(mean(log(N1),na.rm=T)))%>%
  select(Date,Site,N1)%>%
  mutate(lower=N1-2*0.2199*N1)%>%
  mutate(Upper=N1+2*0.2199*N1)
```

```{r HFD variance,echo=TRUE}

N1PlotGraphic <- ggplot()+
  geom_jitter(aes(x=Date,y=N1,color=`Filter replicates`),width=.2,data=LimitedHFData)+
  geom_line(aes(x=Date,y=N1,linetype ="geometric mean of 9 daily replicates"),
            size=1,data=meanOfN1)+
  facet_wrap(~Site)+
  scale_y_log10()
```

```{r HFD variance Fin,fig.height = 6,fig.width = 12,echo=FALSE}
N1PlotGraphic+
  theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
     axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
     plot.margin = unit(c(.5,0,0,0), "cm"))+
  labs(title="High frequency filter and well replicates have low variance",y="N1 (GC/L)",x="",linetype="")
```

---

PMMoV and percent bovine coronavirus recovery use is unclear.
Unusual PMMoV and percent BCoV do not seem to relate to unusual N1 values.

```{r PMMoV gen, echo=TRUE}
PMMoVUseDF=LimitedHFData%>%
  mutate(`PMMoV Level`=ifelse(PMMoV<1*10^7,"Low","Medium"))%>%
  mutate(`PMMoV Level`=ifelse(PMMoV>1*10^8,"High",`PMMoV Level`))%>%
  mutate(`PMMoV Level`=factor(`PMMoV Level`,levels=c("High","Medium","Low")))
```

```{r fig.height = 6,fig.width = 12,echo=FALSE}
PMMoVN1 <- PMMoVUseDF%>%
  ggplot()+aes(x=PMMoV,y=N1,color=`PMMoV Level`)+
  geom_point()+
  scale_y_log10()+
  scale_x_log10()+
  facet_wrap(~Site,nrow=1)+
  labs(title="High PMMoV levels do not clearly relate to high N1 Levels",
      x="PMMoV (GC/L)",
      y="N1 (GC/L)")


DateN1 <- PMMoVUseDF%>%
  ggplot()+aes(x=Date,y=N1,color=`PMMoV Level`)+
  geom_jitter(height=0,width=.1)+
  scale_y_log10()+
  facet_wrap(~Site,nrow=1)

ggarrange(PMMoVN1,DateN1,nrow=2,align="hv",common.legend = TRUE,legend="right")

```

---

```{r Per_Bcov gen, fig.height = 6,fig.width = 10,echo=TRUE}
BCoVUseDF=LimitedHFData%>%
  filter(N1<2e6)%>%
  mutate(`% BCoV Rec`=ifelse(Pct_BCoV<.5,"Low","Medium"))%>%
  mutate(`% BCoV Rec`=ifelse(Pct_BCoV>10,"High",`% BCoV Rec`))%>%
  mutate(`% BCoV Rec`=factor(`% BCoV Rec`,levels=c("High","Medium","Low")))


```

```{r Per_Bcov, fig.height = 6,fig.width = 12,echo=FALSE}
BCoVN1 <- BCoVUseDF%>%
  ggplot()+aes(x=Pct_BCoV,y=N1,color=`% BCoV Rec`)+
  geom_point()+
  labs(x="% BCoV Rec",title="N1 Vs %Bcov recovery")+
  facet_wrap(~Site,nrow=1)


DateN1BC <- BCoVUseDF%>%
  ggplot()+aes(x=Date,y=N1,color=`% BCoV Rec`)+
  geom_jitter(height=0,width=.1)+
  scale_y_log10()+
  ylab("N1 (GC/L)")+
  facet_wrap(~Site,nrow=1)

ggarrange(BCoVN1,DateN1BC,nrow=2,align="hv",common.legend = TRUE,legend="right")
```


---

Due to the large variations of the N1 concentration we have tried to create a smoothed version of the data set that captures the underlying shifts of the data. Below is our best attempt at smoothing the N1 concentration data. It shows relation to case data given the spread of shedding of N1. This relationship holds for N2 as well.


```{r,echo=TRUE}

N1Plot <- LoessSmoothPlot(SiteS="Madison",Span=.1,min=0,max=120,weights=c("Constant","N/NSE"),
                          Title = F,FullLim=F,SiteLab=F) 

CasePlot <- CasePlotMaking("Madison")


```

```{r,echo=FALSE}

N1Plot <- N1Plot+
  theme()+xlab("Madison Longitudinal Data")+theme(
        axis.title.y = element_text(size=12)) 

PerPosPlot <- CasePlotMaking("Madison",Method="Per_pos")

CasePlot <- CasePlot+theme(
        axis.title.y = element_text(size=12)) 

ArrangePlot <- ggarrange(CasePlot,N1Plot,nrow=2,common.legend = TRUE ,align ="hv",legend="right",heights=c(1,1.3))
annotate_figure(ArrangePlot,top = text_grob("Weighted loess smoothing of N1 compared to cases", color = "black", face = "bold", size = 16))

```

---

To use standard Error measurements in our smoothing we needed to have it be an unbiased estimate given the concentration. A strong correlation between N1 and N1Error means it needs to be controlled for. Using standard error normalized by N1 gave a meaningful measurement of the consistency of the data.


```{r SE Pred N1 Prep, echo=FALSE}
# ***No strong relationship existed between the modified standard error and other predictors #like Percent bovine recovery and PMMoV***


#ToDo: add custom Weighting
#How to deal with -N2Errors
SimpleNErrorNModel <- function(Independent,Dependent,...){
  TempDF <- LIMSFullDF%>%
    mutate(Indy=!!sym(Independent),
           Dep=!!sym(Dependent))%>%
    filter(!is.na(Dep),
           !is.na(Indy),
           Dep>0,
           Indy>0)
  UnWeightedModelFull2 <- lm(Dep~Indy-1,weights=Indy/Dep,data=TempDF)
  
  TempDF%>%
    mutate(FullDataPredict=predict.lm(UnWeightedModelFull2,.))%>%
    ggplot()+aes(x=Indy)+
    geom_point(aes(y=Dep),size=1)+
    geom_smooth(aes(y=Dep),method="lm",se=F,formula=y~0+x)+
    #geom_point(aes(y=FullDataPredict,color="Predicted"),size=1)+
    scale_x_log10()+
    scale_y_log10()+
    labs(title="lm(N1Error ~ N1 - 1)",
         x=Dependent,
         y=Independent)+
    theme(aspect.ratio=1)
}
```


```{r SE Pred N1 Gen, echo=TRUE}

N1ErrorN1Plot <- SimpleNErrorNModel(Independent="N1",Dependent="N1Error")

```

```{r SE Pred N1 fin, echo=FALSE}

N1ErrorN1Plot+
      theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(0,0,0,0), "cm"))
```



---


Below are the two versions of the smoothed data capturing different scales of its variations. The boxes are the concentration measured plus or minus the standard error. This gives some measure of how weighted the point is.



```{r SmoothPlot, echo = TRUE}
LowSpanPlot <- LoessSmoothPlot(SiteS="Madison",Span=.1, weights=c("Constant","N/NSE"),
                               min=0,max=120)

HighSpanPlot <- LoessSmoothPlot(SiteS="Madison",Span=.3, weights=c("Constant","N/NSE"),
                                min=0,max=120)

```

```{r SmoothPlot Fin, echo = FALSE,fig.height=3}

LowSpanPlot+
      theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(0,0,0,0), "cm"))+ theme(plot.title = element_text(size=16))+
      xlab("")

HighSpanPlot+
      theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(0,0,0,0), "cm"))+ theme(plot.title = element_text(size=16))+
      xlab("")

```

---

This smoothing model offers similar residuals for N1 and N2 with the residuals agreeing after December. This indicates that the data is being cleaned and some older data points have greater day to day variation then the best sample of the filter.


```{r data quality prep, echo = FALSE}
MadLIMS <- LIMSFullDF%>%
  filter(Site=="Madison")%>%
  filter(N1>0)%>%
  filter(N2>0)%>%
  filter(!is.na(N1),!is.na(N2))%>%
  mutate(Date=as.numeric(Date))

N1Mod <- loess(log(N1)~Date,span=.2,data=MadLIMS)
N2Mod <- loess(log(N2)~Date,span=.2,data=MadLIMS)


MadLIMS$ResidN1 <- resid(N1Mod)
  
MadLIMS$ResidN2 <- resid(N2Mod)

MadLIMS <- MadLIMS%>%
  mutate(Date=as.Date(Date,origin="1970-01-01"))
```

```{r data quality, echo = TRUE}
MadLIMS%>%
  ggplot(aes(x=Date))+
  geom_segment(aes(y=ResidN1,yend=ResidN2,xend=Date),alpha=.2)+
  geom_point(aes(y=(ResidN1),color="N1"),size=1)+
  geom_point(aes(y=(ResidN2),color="N2"),size=1)+
  labs(title="Residuals of N1 and N2 loess smoothing",
       x="",y="Residuals")


MadLIMS%>%
  ggplot(aes(x=Date))+
  geom_point(aes(y=(ResidN1)-(ResidN2)),size=1)+
  labs(title="",
       x="",y="N1 Residual - N2 Residual")

```


---


This is method is extended for the interceptors. Data from before January is missing due to it not being in the LIMS system. older version of that data is not used because it is missing the standard error for N1 and includes data that has been reran


```{r, echo=TRUE,include=TRUE}

MapList=lapply(c("Madison","MMSD-P2","MMSD-P7","MMSD-P8","MMSD-P11","MMSD-P18"),
               LoessSmoothPlot,
               Span=.3,max=20,weights=c("Constant","N/NSE"),
               Title=F,FullLim=T,NoLabel=T)
```

```{r, echo=FALSE,include=TRUE,fig.height=8,fig.width=12}
SixPlots=ggarrange(plotlist = MapList, nrow=2,ncol=3, common.legend = T,legend="bottom",align="hv")
annotate_figure(SixPlots,top = text_grob("Weighted loess smoothing with truncation
     loessFit(N1 ~ Date, span=.3)", color = "black", face = "bold", size = 18))

```

---

Also extended to UW data. This offers the clearest image that N1 has a wider distribution than cases.

```{r, warning=FALSE,echo=FALSE}
N1CaseCompDorms <- function(SiteS,Span=.5,Max=20,Weights=c("Constant","N/NSE")){

  MinConc=min(LIMSFullDF$Date)
  MaxConc=max(LIMSFullDF$Date)
  
  FallRange=c(MinConc,mdy("12/11/2020"))
  SpringRange=c(mdy("1/25/2021"),MaxConc)
  
  FallData=LIMSFullDF%>%
    filter(Date >= FallRange[1] & Date <= FallRange[2])
  
  N1PlotFall <- LoessSmoothPlot(SiteS=SiteS,Data=FallData,weights=Weights,Span=Span,max=Max, Title=F,FullLim=F,NoLabel=T,SiteLab=F)+
    labs(title="Fall Semester",x="",y="N1 (GC/L)")
    theme(plot.margin = unit(c(0,-1,0,0), "cm"))
  
  SpringData=LIMSFullDF%>%
    filter(Date >= SpringRange[1] & Date <= SpringRange[2])
  
  N1PlotSpring <- LoessSmoothPlot(SiteS=SiteS,Data=SpringData,weights=Weights,Span=Span,max=Max, Title=F,FullLim=F,NoLabel=T,SiteLab=F)+
    labs(title="Spring Semester",x="",y="")
    theme(axis.text.y = element_blank())+
    theme(plot.margin = unit(c(0,-1,0,-1), "cm"))

  
  CasePlotFull=CasePlotMaking(SiteS,Method="Cases")
  
  CasePlotSpring <- CasePlotFull+
    coord_cartesian(xlim=SpringRange)+
    ylab("")+
    theme(axis.text.y = element_blank())+
    theme(plot.margin = unit(c(0,-1,0,-1), "cm"))
  
  CasePlotFall <- CasePlotFull+
    coord_cartesian(xlim=FallRange)+
    ylab("Cases")+
    theme(plot.margin = unit(c(0,-1,0,0), "cm"))
  
ArrangePlot=ggarrange(N1PlotFall,N1PlotSpring,CasePlotFall,CasePlotSpring,
                      common.legend = TRUE,
                      align ="hv", legend="bottom")
TitleText=text_grob(paste("Case concentration comparison for",SiteS),
                    color = "black", face = "bold", size = 14)
  annotate_figure(ArrangePlot,top = TitleText)
}

```

```{r, warning=FALSE,fig.height=6,fig.width=12,echo=TRUE}

N1CaseCompDorms(SiteS="UW-Sellery",Span=.5,Max=25,Weights=c("Constant","N/NSE"))

N1CaseCompDorms(SiteS="UW-LakeShore",Span=.5,Max=25,Weights=c("Constant","N/NSE"))

```