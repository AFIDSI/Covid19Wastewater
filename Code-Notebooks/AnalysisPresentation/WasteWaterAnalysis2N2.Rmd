---
title: "WasteWater Analysis 2.0 with N2"
author: "Steve Goldstein and Marlin Lee"
output:
  html_document: default
  pdf_document: default
---


```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE,warning = FALSE)
knitr::opts_chunk$set(fig.width=8, fig.height=5) 
library(ggpubr)
library(dplyr)
library(limma)

#Data Files and prep work
source("../../Scripts/GenPlotMaking.R")
source("../../Scripts/WasteWaterDataProccess.R")
source("../../Scripts/CasesDataProccess.R")
source("../../Scripts/HelperFunctions.R")


source("../../Scripts/WasteShiny/PrepData.R", local = TRUE)

```



```{r start up, include=FALSE}

HFGPop=read.csv("../../../UntrackedData/HFGPop.csv.txt")%>%
  select(Site=wwtp_name,Population=pop_served)


#Preset for graphing
ConfigOption=list(
      myseed=1234567890,
      XAxisLabSiz=10,
      YAxisLabSiz=10,
      GenFontSiz=12,
      alphaPoint=.7,
      PointSize=2,
      alphaWeek=.2)
    
```




```{r, include=FALSE}
DayRolling=7


LatCaseDFRoll=RollPerPos(LatCaseDF,"Cases","Tests",Facet="Site",n=DayRolling)%>%
  select(Date,Site,Cases,Per_pos)#%>%
  #mutate(Date=Date-DayRolling/2)

CasePlotMaking = function(SiteS,Method="Cases"){
  SiteCases=LatCaseDF%>%
    filter(Site==SiteS)

  SiteCasesRoll=LatCaseDFRoll%>%
    filter(Site==SiteS)
  
  LIMSSiteDF=LIMSFullDF%>%
   filter(Site==SiteS)


  Date_lim_long=c(min(LIMSSiteDF$Date),max(LIMSSiteDF$Date))
  
  CasePlot <- Buildplot_gen(
      Method,
      MainDF=SiteCases,
      Loc="Site",
      LineDF=SiteCasesRoll,
      Xfreq="30 days",
      DateLimits=Date_lim_long,
      Standards=ConfigOption,
      AxisPos="bottom",
      LineColor="red",
      Colplot=TRUE) #+ theme(ConfigOption)
  return(CasePlot)
}



LIMSFullDF%>%
  filter(Date<mdy("12/1/2020"))%>%
  arrange(Site)%>%
  group_by(Site)%>%
  summarize(n())
  

```

```{r Loess Model, include=FALSE}
LoessGenerater <- function(Data,weights,Span,min,max){
  if(weights=="Constant"){
    WeightList=rep(1,dim(Data)[1])
  } else if(weights=="N/NSE"){
    WeightList=Data$Indy/Data$Dep
  }
  
  
  loessModel=loessFit(y=Data$Indy,
                         x=Data$Date,
                         weights=WeightList,
                         span=Span,
                         min.weight=min,
                         max.weight=max,
                         iterations=10)
  return(loessModel$fitted)
}



LoessSmoothPlot <- function(SiteS="Madison",
                            Data=LIMSFullDF,
                            Independent="N2",Dependent="N2Error",
                            weights=c("Constant","N/NSE"),
                            Span=.3,min=1e-5,max=1e5,
                            BoxWidth=.5,
                            HasNo=F, Title=T,FullLim=F,SiteLab=T,NoLabel=F){

  LimitLIMSDF=Data%>%
      filter(Site==SiteS)%>%
      mutate(Indy=!!sym(Independent),
             Dep=!!sym(Dependent))%>%
      filter(!is.na(Dep),
             !is.na(Indy),
             Dep>0,
             Indy>0)

    
    LimitLIMSDF$Pred1 <- LoessGenerater(LimitLIMSDF,weights=weights[[1]],Span=Span,min = min,max = max)
    LimitLIMSDF$PredSE <- LoessGenerater(LimitLIMSDF,weights=weights[[2]],Span=Span,min = min,max = max)
    LoessPlot=LimitLIMSDF%>%
      mutate(ErrorMin=Indy-Dep,ErrorMax=Indy+Dep)%>%
          mutate(ErrorMin=ifelse(ErrorMin>0,ErrorMin,0))%>%
          ggplot()+
          aes(x=Date)+
          geom_rect(aes(ymin=ErrorMin,ymax=ErrorMax,xmin=Date-BoxWidth,xmax=Date+BoxWidth),color="black",alpha=.25)+
          geom_rect(aes(ymin=Indy,ymax=Indy,xmin=Date-BoxWidth,xmax=Date+BoxWidth),color="black",alpha=.25)+
          geom_line(aes(y=Pred1,color="1"),size=1.25)+
          geom_line(aes(y=PredSE,color=paste0(Independent,"/",Dependent)),size=1.25)
    if(SiteLab){
      LoessPlot=LoessPlot+facet_wrap(~Site)
    }
    LoessPlot=LoessPlot+
          labs(title="", y=paste0(Independent," (GC/L)"),
               color="Weights Used")+
      #Header_theme(ConfigOption)+
        theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
              axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
              plot.margin = unit(c(0,0,0,0), "cm"))+ 
      theme(legend.position = "bottom")
    
    #Formatting code
    
    PlaceHolder=""
    if(HasNo){
      PlaceHolder="no"
    }
    
    if(Title){
      LoessPlot=LoessPlot+
        ggtitle(paste0("Weighted loess smoothing with ",PlaceHolder," truncation 
                     loessFit(",Independent, " ~ Date, span=",Span,")"))
    }
    if(FullLim){
      XVar=LIMSFullDF$Date
      YVar=pull(LIMSFullDF,Independent)
      XLim <- c(min(XVar),max(XVar))
      YLim <- c(min(YVar[YVar!=0]),max(YVar))
      LoessPlot <- LoessPlot+
        scale_x_date(limits = XLim)+
        scale_y_log10(limits = YLim)
    }else{
      LoessPlot <- LoessPlot+
        scale_y_log10()
    }
    if(NoLabel){
      LoessPlot <- LoessPlot + 
        labs(title="",x="",y="")
        # theme(axis.title.x=element_blank(),
        #     axis.title.y=element_blank())
    }
    return(LoessPlot)
}
#ts.intersect
#ccf
#library(lmtest)
#LIMSMadDF=LIMSFullDF%>%
#  filter(Site=="Madison")
#grangertest(formula=log(N2)~log(N2),data=LIMSMadDF)

```


```{r unused, include=FALSE}
  
# N2PlotGraphic=Buildplot_gen(
#   "N2",
#   MainDF=RelWasteData,
#   LineDF =meanOfN2,
#   Loc="Site",
#   YLabel = "N2 (GC/L)",
#   log_scale=T,
#   ColorType="Filter replicates",
#   DateLimits=Date_lim_HFG,
#   RMOutliers=T,
#   AxisPos="bottom",
#   Standards=ConfigOption,
#   Xfreq="14 days",
#   nrow=2)+ 
#   Header_theme(ConfigOption)+
#       theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
#             axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
#             plot.margin = unit(c(.5,0,0,0), "cm"))+
#   xlab("")
# 
# N2PlotGraphic

```



To give some measure of the variation of the data we look at the high frequency data. It shows that outliers often clump with the other filter replicates


```{r HFD VarPrep, echo=FALSE}
SiteOptions2=c("Kenosha","Madison", "Sun Prairie","Wausau")
LimitedHFData=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  group_by(Site,Date,`Filter replicates`)%>%
  mutate(n=n())%>%
  filter(n==3)%>%
  ungroup()%>%
  select(-n)
meanOfN2=LimitedHFData%>%
  group_by(Site,Date)%>%
  summarise(N2=exp(mean(log(N2),na.rm=T)))%>%
  select(Date,Site,N2)%>%
  mutate(lower=N2-2*0.2199*N2)%>%
  mutate(Upper=N2+2*0.2199*N2)
```

```{r HFD variance,echo=TRUE}

N2PlotGraphic <- ggplot()+
  geom_jitter(aes(x=Date,y=N2,color=`Filter replicates`),width=.2,data=LimitedHFData)+
  geom_line(aes(x=Date,y=N2,linetype ="geometric mean of 9 daily replicates"),
            size=1,data=meanOfN2)+
  facet_wrap(~Site)+
  scale_y_log10()
```
```{r HFD variance Fin,fig.height=6,fig.width=15,echo=FALSE}
N2PlotGraphic+
  theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
     axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
     plot.margin = unit(c(.5,0,0,0), "cm"))+
  labs(title="High frequency filter and well replicates have low variance",y="N2 (GC/L)",x="",linetype="")
```

PMMoV and percent bovine coronavirus recovery use is unclear.
Unusual PMMoV and percent BCoV do not seem to relate to unusual N2 values.

```{r PMMoV gen, echo=TRUE}
PMMoVUseDF=LimitedHFData%>%
  mutate(`PMMoV Level`=ifelse(PMMoV<1*10^7,"Low","Medium"))%>%
  mutate(`PMMoV Level`=ifelse(PMMoV>1*10^8,"High",`PMMoV Level`))%>%
  mutate(`PMMoV Level`=factor(`PMMoV Level`,levels=c("High","Medium","Low")))
```

```{r fig.height = 6,fig.width = 10,echo=FALSE}
PMMoVN2 <- PMMoVUseDF%>%
  ggplot()+aes(x=PMMoV,y=N2,color=`PMMoV Level`)+
  geom_point()+
  scale_y_log10()+
  scale_x_log10()+
  facet_wrap(~Site,nrow=1)+
  labs(title="High PMMoV levels do not clearly relate to high N2 Levels",
      x="PMMoV (GC/L)",
      y="N2 (GC/L)")


DateN2 <- PMMoVUseDF%>%
  ggplot()+aes(x=Date,y=N2,color=`PMMoV Level`)+
  geom_jitter(height=0,width=.1)+
  scale_y_log10()+
  facet_wrap(~Site,nrow=1)

ggarrange(PMMoVN2,DateN2,nrow=2,align="hv")

```

```{r Per_Bcov gen, fig.height = 6,fig.width = 10,echo=TRUE}
BCoVUseDF=LimitedHFData%>%
  filter(N2<2e6)%>%
  mutate(`% BCoV Rec`=ifelse(Pct_BCoV<.5,"Low","Medium"))%>%
  mutate(`% BCoV Rec`=ifelse(Pct_BCoV>10,"High",`% BCoV Rec`))%>%
  mutate(`% BCoV Rec`=factor(`% BCoV Rec`,levels=c("High","Medium","Low")))


```

```{r Per_Bcov, fig.height = 6,fig.width = 10,echo=FALSE}
BCoVN2 <- BCoVUseDF%>%
  ggplot()+aes(x=Pct_BCoV,y=N2,color=`% BCoV Rec`)+
  geom_point()+
  labs(x="% BCoV Rec",title="N2 Vs %Bcov recovery")+
  facet_wrap(~Site,nrow=1)


DateN2BC <- BCoVUseDF%>%
  ggplot()+aes(x=Date,y=N2,color=`% BCoV Rec`)+
  geom_jitter(height=0,width=.1)+
  scale_y_log10()+
  ylab("N2 (GC/L)")+
  facet_wrap(~Site,nrow=1)

ggarrange(BCoVN2,DateN2BC,nrow=2,align="hv")
```




Due to the large variations of the N2 concentration we have tried to create a smoothed version of the data set that captures the underlying shifts of the data. Below is our best attempt at smoothing the N2 concentration data. It shows relation to case data given the spread of shedding of N2. This relationship holds for N2 as well.


```{r,echo=TRUE}

N2Plot <- LoessSmoothPlot(SiteS="Madison",Span=.1,min=0,max=120,weights=c("Constant","N/NSE"),
                          Title = F,FullLim=F,SiteLab=F) 

CasePlot <- CasePlotMaking("Madison")


```

```{r,echo=FALSE}

N2Plot <- N2Plot+
  theme()+xlab("Madison Longitudinal Data")+theme(
        axis.title.y = element_text(size=12)) 

PerPosPlot <- CasePlotMaking("Madison",Method="Per_pos")

CasePlot <- CasePlot+theme(
        axis.title.y = element_text(size=12)) 

ArrangePlot <- ggarrange(CasePlot,N2Plot,nrow=2,common.legend = TRUE ,align ="hv",legend="right",heights=c(1,1.3))
annotate_figure(ArrangePlot,top = text_grob("Weighted loess smoothing of N2 compared to cases", color = "black", face = "bold", size = 16))

```



To use standard Error measurements in our smoothing we needed to have it be an unbiased estimate given the concentration. A strong correlation between N2 and N2Error means it needs to be controlled for. Using standard error normalized by N2 gave a meaningful measurement of the consistency of the data.


```{r SE Pred N2 Prep, echo=FALSE}
# ***No strong relationship existed between the modified standard error and other predictors #like Percent bovine recovery and PMMoV***


#ToDo: add custom Weighting
#How to deal with -N2Errors
SimpleNErrorNModel <- function(Independent,Dependent,...){
  TempDF <- LIMSFullDF%>%
    mutate(Indy=!!sym(Independent),
           Dep=!!sym(Dependent))%>%
    filter(!is.na(Dep),
           !is.na(Indy),
           Dep>0,
           Indy>0)
  UnWeightedModelFull2 <- lm(Dep~Indy-1,weights=Indy/Dep,data=TempDF)
  
  TempDF%>%
    mutate(FullDataPredict=predict.lm(UnWeightedModelFull2,.))%>%
    ggplot()+aes(x=Indy)+
    geom_point(aes(y=Dep),size=1)+
    geom_smooth(aes(y=Dep),method="lm",se=F,formula=y~0+x)+
    #geom_point(aes(y=FullDataPredict,color="Predicted"),size=1)+
    scale_x_log10()+
    scale_y_log10()+
    labs(title="lm(N2Error ~ N2 - 1)",
         x=Dependent,
         y=Independent)+
    theme(aspect.ratio=1)
}
```


```{r SE Pred N2 Gen, echo=TRUE}

N2ErrorN2Plot <- SimpleNErrorNModel(Independent="N2",Dependent="N2Error")

```

```{r SE Pred N2 fin, echo=FALSE}

N2ErrorN2Plot+
      theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(0,0,0,0), "cm"))
```






Below are the two versions of the smoothed data capturing different scales of its variations. The boxes are the concentration measured plus or minus the standard error. This gives some measure of how weighted the point is.



```{r SmoothPlot, echo = TRUE}
LowSpanPlot <- LoessSmoothPlot(SiteS="Madison",Span=.1, weights=c("Constant","N/NSE"),
                               min=0,max=120)

HighSpanPlot <- LoessSmoothPlot(SiteS="Madison",Span=.3, weights=c("Constant","N/NSE"),
                                min=0,max=120)

```

```{r SmoothPlot Fin, echo = FALSE,fig.height=6}

LowSpanPlot+
      theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(0,0,0,0), "cm"))+ theme(plot.title = element_text(size=16))+
      xlab("")

HighSpanPlot+
      theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(0,0,0,0), "cm"))+ theme(plot.title = element_text(size=16))+
      xlab("")

```

This smoothing model offers similar residuals for N1 and N2 with the residuals agreeing after December. This indicates that the data is being cleaned and some older data points have greater day to day variation then the best sample of the filter.


```{r data quality prep, echo = FALSE}
MadLIMS <- LIMSFullDF%>%
  filter(Site=="Madison")%>%
  filter(N1>0)%>%
  filter(N2>0)%>%
  filter(!is.na(N1),!is.na(N2))%>%
  mutate(Date=as.numeric(Date))

N1Mod <- loess(log(N1)~Date,span=.2,data=MadLIMS)
N2Mod <- loess(log(N2)~Date,span=.2,data=MadLIMS)


MadLIMS$ResidN1 <- resid(N1Mod)
  
MadLIMS$ResidN2 <- resid(N2Mod)

MadLIMS <- MadLIMS%>%
  mutate(Date=as.Date(Date,origin="1970-01-01"))
```

```{r data quality, echo = TRUE}
MadLIMS%>%
  ggplot(aes(x=Date))+
  geom_segment(aes(y=ResidN1,yend=ResidN2,xend=Date),alpha=.2)+
  geom_point(aes(y=(ResidN1),color="N1"),size=1)+
  geom_point(aes(y=(ResidN2),color="N2"),size=1)+
  labs(title="Residuals of N1 and N2 loess smoothing",
       x="",y="Residuals")


MadLIMS%>%
  ggplot(aes(x=Date))+
  geom_point(aes(y=(ResidN1)-(ResidN2)),size=1)+
  labs(title="",
       x="",y="N1 Residual - N2 Residual")

```


This is method is extended for the interceptors. Data from before January is missing due to it not being in the LIMS system. older version of that data is not used because it is missing the standard error for N2 and includes data that has been reran


```{r, echo=TRUE,include=TRUE}

MapList=lapply(c("Madison","MMSD-P2","MMSD-P7","MMSD-P8","MMSD-P11","MMSD-P18"),
               LoessSmoothPlot,
               Span=.3,max=20,weights=c("Constant","N/NSE"),
               Title=F,FullLim=T,NoLabel=T)
```

```{r, echo=FALSE,include=TRUE,fig.height=18,fig.width=14}
SixPlots=ggarrange(plotlist = MapList, nrow=3,ncol=2, common.legend = T,legend="bottom",align="hv")
annotate_figure(SixPlots,top = text_grob("Weighted loess smoothing with truncation
     loessFit(N2 ~ Date, span=.3)", color = "black", face = "bold", size = 18))

```




```{r Missing LIMS, warning=FALSE,fig.height=18,echo=FALSE,include=FALSE}
#LIMS data given does not include all the interceptor data. Older data given does not have N2 Error.

# LIMS data given does not include all the interceptor data. Older data given does not have N2 Error.
```

Also extended to UW data. This offers the clearest image that N2 has a wider distribution than cases.

```{r, warning=FALSE,echo=FALSE}
N2CaseCompDorms <- function(SiteS,Span=.5,Max=20,Weights=c("Constant","N/NSE")){

  MinConc=min(LIMSFullDF$Date)
  MaxConc=max(LIMSFullDF$Date)
  
  FallRange=c(MinConc,mdy("12/11/2020"))
  SpringRange=c(mdy("1/25/2021"),MaxConc)
  
  FallData=LIMSFullDF%>%
    filter(Date >= FallRange[1] & Date <= FallRange[2])
  
  N2PlotFall <- LoessSmoothPlot(SiteS=SiteS,Data=FallData,weights=Weights,Span=Span,max=Max, Title=F,FullLim=F,NoLabel=T,SiteLab=F)+
    labs(title="Fall Semester",x="",y="N2 (GC/L)")
    theme(plot.margin = unit(c(0,-1,0,0), "cm"))
  
  SpringData=LIMSFullDF%>%
    filter(Date >= SpringRange[1] & Date <= SpringRange[2])
  
  N2PlotSpring <- LoessSmoothPlot(SiteS=SiteS,Data=SpringData,weights=Weights,Span=Span,max=Max, Title=F,FullLim=F,NoLabel=T,SiteLab=F)+
    labs(title="Spring Semester",x="",y="")
    theme(axis.text.y = element_blank())+
    theme(plot.margin = unit(c(0,-1,0,-1), "cm"))

  
  CasePlotFull=CasePlotMaking(SiteS,Method="Cases")
  
  CasePlotSpring <- CasePlotFull+
    coord_cartesian(xlim=SpringRange)+
    ylab("")+
    theme(axis.text.y = element_blank())+
    theme(plot.margin = unit(c(0,-1,0,-1), "cm"))
  
  CasePlotFall <- CasePlotFull+
    coord_cartesian(xlim=FallRange)+
    ylab("Cases")+
    theme(plot.margin = unit(c(0,-1,0,0), "cm"))
  
ArrangePlot=ggarrange(N2PlotFall,N2PlotSpring,CasePlotFall,CasePlotSpring,
                      common.legend = TRUE,
                      align ="hv", legend="bottom")
TitleText=text_grob(paste("Case concentration comparison for",SiteS),
                    color = "black", face = "bold", size = 14)
  annotate_figure(ArrangePlot,top = TitleText)
}

```

```{r, warning=FALSE,fig.height=8,echo=TRUE}

N2CaseCompDorms(SiteS="UW-Sellery",Span=.5,Max=25,Weights=c("Constant","N/NSE"))

N2CaseCompDorms(SiteS="UW-LakeShore",Span=.5,Max=25,Weights=c("Constant","N/NSE"))

```




```{r, warning=FALSE,fig.height=12,include=FALSE}
#Per_pos
N2CaseComp <- function(SiteS){
  N2Plot=LoessSmoothPlot(SiteS=SiteS,Data=LIMSFullDF,Span=.3,max=20, Title=F,FullLim=F,NoLabel=T)+
  theme()
  
  CasePlot=CasePlotMaking(SiteS,Method="Cases")
ArrangePlot=ggarrange(N2Plot,CasePlot,nrow=2,common.legend = TRUE ,align ="hv",legend="bottom")
TitleText=text_grob("Weighted loess smoothing compared to cases)", color = "black", face = "bold", size = 14)
  annotate_figure(ArrangePlot,top = TitleText)
}


# N2CaseComp("MMSD-P2")
# N2CaseComp("MMSD-P7")
# N2CaseComp("MMSD-P8")
# N2CaseComp("MMSD-P11")
# N2CaseComp("MMSD-P18")
#HFD second half
#Lims older data
```



```{r, echo=FALSE,include=FALSE}
# PMMoV and percent bovine coronavirus recovery use is still unclear. Data shows very week and inconsistent trend.

PMMoVN1Relation <- function(Sites){
  LIMSFullDF%>%
  filter(Site==Sites)%>%
  ggplot()+
  aes(x=N1)+
  #scale_colour_viridis_b()+
  geom_point(aes(y=PMMoV))+
  scale_y_log10()+
  scale_x_log10()+
  facet_wrap(~Site)
}
BCoVN1Relation <- function(Sites){
  LIMSFullDF%>%
  filter(Site==Sites)%>%
  ggplot()+
  aes(x=N1)+
  #scale_colour_viridis_b()+
  geom_point(aes(y=BCoV))+
  scale_y_log10()+
  scale_x_log10()+
  facet_wrap(~Site)
}

BCPMMN1Relation <- function(Sites){
  P1=BCoVN1Relation(Sites)
  B1=PMMoVN1Relation(Sites)
  FinPlot=ggarrange(P1,B1,nrow=2,align="hv")
  return(FinPlot)
}

Sites=c("UW-LakeShore","MMSD-P8","MMSD-P2","MMSD-P11","Madison","MMSD-P7","MMSD-P18","Hudson","Kenosha","Wausau","Oshkosh")
  
#unique(LIMSFullDF$Site)

#lapply(Sites,BCPMMN1Relation)

#lapply(Sites,PMMoVN1Relation)
# LIMSFullDF%>%
#   group_by(Site)%>%
#   summarise(n=n(),Min=min(Date),Dur=max(Date)-min(Date),MeanP=mean(Pop,na.rm=TRUE))%>%
#   arrange(desc(MeanP))
# 
# LatWasteDF%>%
#   group_by(Site)%>%
#   summarise(n=n(),Min=min(Date),Dur=max(Date)-min(Date))


```



