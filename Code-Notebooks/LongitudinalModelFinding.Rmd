---
title: "Lat Model Work"
author: "Marlin"
date: "5/17/2021"
output: html_document
---

```{r}

library(ggpubr)
library(dplyr)
source("../Scripts/GenPlotMaking.R")
source("../Scripts/WasteWaterDataProccess.R")
source("../Scripts/CassesDataProccess.R")
source("../Scripts/HelperFunctions.R")
LatWasteFN <- "../../UntrackedData/WW SARS-COV-2 Data V5.xlsx"
LatSpringCaseFN="../../UntrackedData/SpringSemester_CasesByDorm.tsv"
LatFallCaseFN="../../UntrackedData/Oct2020toEndFall_CasesByDorm.tsv"
CovidFileName = "../../UntrackedData/MMSD_Cases.csv"
```

```{r}
LatCaseDormsDF=CovidDataDorms(LatSpringCaseFN,LatFallCaseFN)%>%
  mutate(Per_pos=100*Cases/Tests)%>%
  select(-negitive_tests)



covidData=CovidData(CovidFileName)%>%
  mutate(Per_pos=100*Cases/Tests)%>%
  select(Date,Site,Cases,Tests,Per_pos)
LatCaseDF=rbind(covidData,LatCaseDormsDF)

Fullday=data.frame(Date=seq.Date(min(LatCaseDF$Date),max(LatCaseDF$Date),1))
LatCaseDF=full_join(LatCaseDF,Fullday,by=c("Date"))%>%
  arrange(Site,Date)%>%
  group_by(Site)%>%
  mutate(rollingPer_pos=RollPerPos(Cases,Tests))%>%
  ungroup()

LatWasteDF=WasteWater(LatWasteFN)%>%
  mutate(Date=as.Date(Date))%>%
  mutate(GeoMean=(N1*N2)^.5)%>%
  filter(!is.na(Date),!is.na(N1))%>%
  filter(Date<mdy("6/5/2021"))

MMSDData=full_join(LatWasteDF,LatCaseDF,by=c("Site","Date"))%>%
  filter(!is.na(Site),!is.na(Date))

MMSDData%>%ggplot()+aes(x=GeoMean/(PMMoV))+
  geom_point(aes(y=Cases),color="Red")+facet_wrap(~Site,scales = "free_y")+scale_x_log10()



```

```{r}
cor.df=NA
for (i in -14:14){
  if(i!=-14){
    cor.df=cor.df%>%
      select(-Site)}
  TempLatCaseDF=LatCaseDF%>%
    mutate(Date=Date+i)
  MMSDDF=full_join(LatWasteDF,TempLatCaseDF,by=c("Site","Date"))%>%
   filter(!is.na(Site),!is.na(Date))
  TVec=MMSDDF%>%
    group_by(Site)%>%
    summarize("{i}":= abs(cor(x = GeoMean, y = rollingPer_pos/PMMoV, use = "pairwise.complete.obs")))
  
  cor.df=cbind(cor.df,TVec)
}
cor.df=cor.df%>%
  select(-cor.df)%>%
  select(Site,!Site)%>%
  pivot_longer('-14':'14')%>%
  group_by(Site)%>%
  mutate(bestCase=max(value))%>%
  mutate(bestAlpha=ifelse(value==bestCase,1,0))
cor.df$name=factor(cor.df$name, levels=c('-14':'14'))
cor.df%>%
  ggplot(aes(y=Site, x=name)) + 
  geom_tile(aes(fill= value)) + geom_tile(aes(fill= bestCase,alpha=bestAlpha),fill = "red") + theme(axis.text.x = element_text(angle = 90))
```