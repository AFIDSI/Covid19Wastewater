---
params:
  BaseDir: "Z:/"
title: "Covariants"
author: "Marlin"
date: "1/18/2022"
output: html_document
---
```{r set up markdown settings, echo=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE
)
```


```{r Start enviroment, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(lmtest)
library(lubridate)
library(limma)
library(tidyr)
library(plotly)
library(gridExtra)
library(data.table)
library(formattable)

#Data Files and prep work
source("../../lib/DataProccess.R")
source("../../lib/NormFuncs.R")
source("../../lib/OutlierDetectionFuncs.R")

source("../../lib/DataPathName.R")
BaseDir <- params$BaseDir#get the root of the directory where the data is stored
```

```{r helpful data manipulations, include = FALSE}


#Custom_color_scale
ColorRule <- scale_color_manual(values = c("N1" = "#F8766D",
                                           "Cases"="#00BFC4",
                                           "Seven Day MA Cases" = "#4057A2",
                                           "SLDCases"="#800080",
                                           "loessN1" = "#D6544B"))

NameingRule <- c("N1" = "N1",
                "Cases"="Cases",
                "SevenDayMACases" = "Seven Day MA Cases",
                "SLDCases"="SLDCases",
                "loessN1" = "loessN1")
```

# Data: The first look

The two data sets used in this analysis are the Madison case data sourced from the Wisconsin DHS and wastewater  concentration data produced by the Wisconsin State Laboratory of Hygiene. This wastewater data has entries every couple of days from November 15 2020 to June 24 2021.

"Files Used: "

`r LIMSCasePath(BaseDir)`

`r LIMSWastePath(BaseDir)`


```{r DF Set Up, echo=FALSE}
#directy current
#simbolic link. shortcut to most recent
#might not work with reserch drive
#Include Hash of git commit
#Include some summary of the data. Sanity check
#Dimintion if rectangular, number of unique values in each column
#header 


#Importing the Madison case data
LatCaseDF <- ParseData(LIMSCasePath(BaseDir))%>% 
  rename(Cases = FirstConfirmed)%>%
  #filter(Site == "Madison")%>%
  mutate(SevenDayMACases = rollapply(data = Cases, width = 7, FUN = mean, 
                            na.rm = TRUE,fill=NA))%>%
  filter(Date>ymd("2020-9-10"))%>%
  select(Date, Site, Cases,SevenDayMACases,everything())

#Importing the Madison waste water data
LIMSFullDF <- ParseData(LIMSWastePath(BaseDir))%>%
  #filter(Site == "Madison")%>%
  mutate(N1Pure = ifelse(is.na(N1),N2,N1),
         N2Pure = ifelse(is.na(N2),N1,N2),
         GeoMeanN12 = exp((log(N1Pure)+log(N2Pure))/2))%>%
  select(Date, Site, N1, BCoV , N2 , PMMoV,
         GeoMeanN12,FlowRate,temperature,equiv_sewage_amt,everything())

#joining the two data frames together
FullDF <- full_join(LatCaseDF,LIMSFullDF, by = c("Date","Site"))

#what does the data look like? 
FullDF%>%
head()%>%
formattable()

```

The case data has a strong weekend effect so for this section we look at a seven day smoothing of cases. The simple display of the data shows the core components of this story. First that wastewater data is very noisy. And that there is a hint of a relationship between the two signals.

```{r BaseRelationship}
FirstImpressionDF <- FullDF%>%
  NoNa("N1","Cases")

FirstImpression <- FirstImpressionDF%>%#Removing outliers
  ggplot(aes(x=Date))+#Data depends on time
  geom_line(aes(y=N1, color="N1",info=N1))+#compares N1 to Cases
  geom_line(aes(y=MinMaxFixing(PMMoV,N1), color="PMMoV",info=PMMoV))+
  geom_line(aes(y=MinMaxFixing(FlowRate,N1), color="FlowRate",info=FlowRate))+
  geom_line(aes(y=MinMaxFixing(BCoV,N1), color="BCoV",info=BCoV))+
  #geom_line(aes(y=MinMaxFixing(temperature,N1), color="temperature",info=temperature))+
  #geom_line(aes(y=MinMaxFixing(tss,N1), color="tss",info=tss))+
  geom_line(aes(y=MinMaxFixing(equiv_sewage_amt,N1), color="equiv_sewage_amt",info=equiv_sewage_amt))+
  geom_line(aes(y=MinMaxFixing(SevenDayMACases,N1), color="Seven Day MA Cases",info=Cases))+
  geom_line(aes(y=MinMaxFixing(N2,N1), color="N2",info=N2))+
  labs(y="N1")



ggplotly(FirstImpression)


#To remove weekend effects we are looking at the 7 day smoothing of cases.
```



```{r outlierDetection}
DaySmoothed=21#Very wide smoothing to find where the data strong deviate from trend

ErrorMarkedDF <- FullDF%>%#Remove older Var data that clearly has no relationship to Cases
  mutate(EarlyOutlier = ifelse(Date < mdy("11/20/2020"),TRUE,FALSE))#replace old. 
#"11/20/2020"
#"1/1/2021"

ErrorMarkedDF$DetectedOutlierN1 <- IdentifyOutliers(ErrorMarkedDF$N1)
ErrorMarkedDF$DetectedOutlierN2 <- IdentifyOutliers(ErrorMarkedDF$N2)  
ErrorMarkedDF$DetectedOutlierGeo <- IdentifyOutliers(ErrorMarkedDF$GeoMeanN12)
ErrorMarkedDF$DetectedOutlierPMMOV <- IdentifyOutliers(ErrorMarkedDF$PMMoV)
ErrorMarkedDF$DetectedOutlierBCOv <- IdentifyOutliers(ErrorMarkedDF$BCoV)

ErrorRemovedDF <- ErrorMarkedDF%>%
  mutate(PotentialOutlier = Date>mdy("03/31/2021")&mdy("05/12/2021")>Date)%>%
         select(-EarlyOutlier)#Removing unneeded calculated columns


ErrorMarkedDF%>%
  select(-EarlyOutlier)%>%
  #filter(DetectedOutlierN1|DetectedOutlierN2|DetectedOutlierGeo)%>%
  mutate(NumberOfOutliers = DetectedOutlierN1+DetectedOutlierN2+DetectedOutlierGeo)%>%
  group_by(NumberOfOutliers)%>%
  summarize(n())

ErrorMarkedDF%>%
  select(-EarlyOutlier)%>%
  summarize(N1 = sum(DetectedOutlierN1), N2 = sum(DetectedOutlierN2), Geo = sum(DetectedOutlierGeo), N12 =sum(DetectedOutlierN1*DetectedOutlierN2), N1Geo =sum(DetectedOutlierN1*DetectedOutlierGeo), N2Geo =sum(DetectedOutlierN2*DetectedOutlierGeo), AllVars =sum(DetectedOutlierN1*DetectedOutlierN2*DetectedOutlierGeo))


OutlierComp <- ErrorMarkedDF%>%
  filter(DetectedOutlierN1|DetectedOutlierN2|DetectedOutlierGeo)%>%
  mutate(Name = "",Name = paste(Name,ifelse(DetectedOutlierN1,"N1","")),
         Name = paste(Name,ifelse(DetectedOutlierN2,"N2","")),
         Name = paste(Name,ifelse(DetectedOutlierGeo,"Geo","")))%>%
  ggplot(aes(x=Date))+
  geom_point(aes(y=N1,shape="N1",color=Name))+
  geom_point(aes(y=N2,shape="N2",color=Name))+
  geom_point(aes(y=GeoMeanN12,shape="Geo",color=Name))
ggplotly(OutlierComp)
#,info1=N1,info2=GeoMeanN12

OutlierComp <- ErrorMarkedDF%>%
  filter(DetectedOutlierN1|DetectedOutlierPMMOV|DetectedOutlierBCOv)%>%
  mutate(Name = "",Name = paste(Name,ifelse(DetectedOutlierN1,"N1","")),
         Name = paste(Name,ifelse(DetectedOutlierPMMOV,"PMMoV","")),
         Name = paste(Name,ifelse(DetectedOutlierBCOv,"BCoV","")))%>%
  ggplot(aes(x=Date))+
  geom_point(aes(y=N1,color=Name,info1=PMMoV,info2=BCoV))
ggplotly(OutlierComp)

#ErrorMarkedDF%>%
#  select(-EarlyOutlier)%>%
#  write.csv(file="OutlierFlagDF")
```

```{r}
#wwtp_comments
#analytical_comments
#ErrorRemovedDF%>%
#  filter(!is.na(analytical_comments))
```




```{r covariants outliers, eval=FALSE}

CoVarGraphic <- ErrorRemovedDF%>%
  ggplot()+#LargeError
  aes(y = N1,color=DetectedOutlier,info = Date)
#PotentialOutlier#DetectedOutlier
CoVarGraphicPMMoV <- CoVarGraphic+
  geom_point(aes(x = PMMoV))
#Outliers
#26203622#29931423
#149752.0#461781.5
#Potintial outlier
#26463265#30048370
#172041.0#98442.5
CoVarGraphicFlowRate <- CoVarGraphic+
  geom_point(aes(x = FlowRate))
CoVarGraphicBCoV <- CoVarGraphic+
  geom_point(aes(x = BCoV))
CoVarGraphicequiv_sewage_amt <- CoVarGraphic+#temperature,equiv_sewage_amt
  geom_point(aes(x = equiv_sewage_amt))
#PMMoV,FlowRate,BCoV,temperature,equiv_sewage_amt
ggplotly(CoVarGraphicPMMoV)
ggplotly(CoVarGraphicBCoV)
ggplotly(CoVarGraphicFlowRate)
ggplotly(CoVarGraphicequiv_sewage_amt)

ErrorRemovedDF%>%
  group_by(DetectedOutlier)%>%
  summarize(median(PMMoV,na.rm = TRUE),sd(PMMoV,na.rm = TRUE),
            median(N1,na.rm = TRUE),sd(N1,na.rm = TRUE))


AA <- ErrorRemovedDF%>%
  ggplot(aes(x=Date,y=equiv_sewage_amt))+
  geom_point()
ggplotly(AA)
```


```{r, eval=FALSE}


summary(lm(DetectedOutlier ~ PMMoV ,data = ErrorMarkedDF))

library(rpart)
fit <- rpart(DetectedOutlier ~ PMMoV + N1,
   method="class", data=ErrorMarkedDF)

printcp(fit)
plotcp(fit)
summary(fit)
plot(fit)
text(fit, use.n=TRUE, all=TRUE, cex=.5)

CoVarGraphicPMMoV <- CoVarGraphic+
  geom_point(aes(x = PMMoV))+
  geom_hline(yintercept = 5.61e5)+
  geom_vline(xintercept = 2.82e7)
ggplotly(CoVarGraphicPMMoV)


ErrorMarkedDF%>%
  ggplot(aes(x = DetectedOutlier, y = log(PMMoV))) +
        geom_boxplot()


t.test(PMMoV ~ DetectedOutlier, data = ErrorMarkedDF)

#26203622#29931423
#149752.0#461781.5
```


```{r Use smoothing to look for covariant trends}
LoessFunc <- function(DF,SpanConstant = .01,Var="N1"){
  MainDF <- DF
  MainDF[[paste0("loess",Var)]] <- loessFit(y=(MainDF[[Var]]), 
                      x=MainDF$Date, #create loess fit of the data
                      span=SpanConstant, #span of .2 seems to give the best result, not rigorously chosen
                      iterations=2)$fitted#2 iterations remove some bad patterns
  return(MainDF)
}



ErrorCompPlot <- function(ErrorVar="N1",CompVar="N2"){
  ErrorPlotDF <- ModFullDF
    NoLogPlot <- ErrorPlotDF%>%
      ggplot(aes(y=TrendError,x=!!sym(CompVar),info=Date))+
      geom_point()
    
    LogPlot <- ErrorPlotDF%>%
      ggplot(aes(y=TrendError,x=!!sym(CompVar),info=Date))+
      geom_point()+
      scale_y_log10()+
      scale_x_log10()
    #print(ggplotly(NoLogPlot))
    #print(ggplotly(LogPlot))
    print((NoLogPlot))
    print((LogPlot))
    Formula <- as.formula(
        paste("TrendError", 
        paste(CompVar, collapse = " + "), 
        sep = " ~ "))

    fit <- lm(Formula, data = ErrorPlotDF)
    print(summary(fit)$coefficients[,4]) 
    print(summary(fit)$r.squared)
  return()
}

ModFullDF <- FullDF%>%
    group_split(Site) %>%
    purrr::map_dfr(LoessFunc,Var = "N1")%>%
    filter(!is.na(!!sym(paste0("loess", "N1"))))%>%
    mutate(TrendError = abs(N1-!!sym(paste0("loess","N1"))))%>%
    group_by(Site)%>%
    filter(mean(TrendError)!=0,
           !is.na(TrendError))

#names(LoessN1Messurement)
for (Name in names(ModFullDF)){
  Entries = length(!is.na(unique(ModFullDF[[Name]])))
  print(paste0("Number of entries: ", Entries))
  if(Entries>5){
    print(paste0("Explain Var: ", Name))
    try(
      
    ErrorCompPlot(CompVar = Name)
  )
  }
}

```

