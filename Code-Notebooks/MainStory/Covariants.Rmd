---
params:
  BaseDir: "Z:/"
title: "Covariants"
author: "Marlin"
date: "1/18/2022"
output: html_document
---
```{r set up markdown settings, echo=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE
)
```


```{r Start enviroment, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(lmtest)
library(lubridate)
library(limma)
library(tidyr)
library(plotly)
library(gridExtra)
library(data.table)
library(formattable)

#Data Files and prep work
source("../../lib/DataProccess.R")
```

```{r helpful data manipulations, include = FALSE}
#returns vector of the min and max of function
MinMaxCollector <- function(Vec){
  if(is.na(Vec)){
    return(NA)
  }
  return(range(Vec, na.rm = TRUE))
}

#normalizes data to be between 0 and 1. 
#Not used significantly in newest build
MinMaxNormalization <- function(Vec,minMax=NA){#normalizes the data to range from 0 and 1
    if(all(!is.na(minMax))){
      normVec <- (Vec-minMax[1])/minMax[2]
    }else{
      normVec <- (Vec-min(Vec,na.rm=TRUE))/max(Vec,na.rm=TRUE)
    }
    return(normVec)
}

#Makes First Vector have the same min and max as the second one.
MinMaxFixing <- function(Vec, Bar, SubVec=NA){
  NormVec = MinMaxNormalization(Vec,MinMaxCollector(SubVec))
  BarRange = MinMaxCollector(Bar)
  RefitVec = NormVec*(BarRange[2]-BarRange[1])+BarRange[1]
  return(RefitVec)
}

NoNa <- function(DF,...){#Removes NA from the reverent columns
  ColumnNames <- c(...)
  NoNaDF <- DF%>%
    filter(
      across(
      .cols = ColumnNames,
      .fns = ~ !is.na(.x))
      )
  return(NoNaDF)
}

FillNA <- function(DF,...){#Fills NA with previous values
  ColumnNames <- c(...)
  NoNaDF <- DF%>%
    fill(ColumnNames)
  return(NoNaDF)
}

MedianMean <- function(Vec){# take the mean drooping the highest and lowest values
  RemoveBorderPoints <- replace(Vec, c(which.min(Vec), which.max(Vec)), NA)
  MeanValue <- mean(RemoveBorderPoints, na.rm = TRUE)
  return(MeanValue)
}

#Custom_color_scale
ColorRule <- scale_color_manual(values = c("N1" = "#F8766D",
                                           "Cases"="#00BFC4",
                                           "Seven Day MA Cases" = "#4057A2",
                                           "SLDCases"="#800080",
                                           "loessN1" = "#D6544B"))

NameingRule <- c("N1" = "N1",
                "Cases"="Cases",
                "SevenDayMACases" = "Seven Day MA Cases",
                "SLDCases"="SLDCases",
                "loessN1" = "loessN1")
```

# Data: The first look

The two data sets used in this analysis are the Madison case data sourced from the Wisconsin DHS and wastewater  concentration data produced by the Wisconsin State Laboratory of Hygiene. This wastewater data has entries every couple of days from November 15 2020 to June 24 2021.

```{r DF Set Up, echo=FALSE}
BaseDir <- params$BaseDir#get the root of the directory where the data is stored

#All the Madison data is contained in these two files#MMSD_Cases_processed
MadisonCaseFN  <-  paste0(BaseDir, "COVID-19_WastewaterAnalysis/data/processed/MMSD_Cases_2022_01_12_processed.csv")
LIMSFN <- paste0(BaseDir, "COVID-19_WastewaterAnalysis/data/processed/LIMSWasteData_01-25-21_01-05-22.csv")


#Importing the Madison case data
LatCaseDF <- ParseData(MadisonCaseFN)%>% 
  filter(Site == "Madison")%>%
  mutate(SevenDayMACases = rollapply(data = Cases, width = 7, FUN = mean, 
                            na.rm = TRUE,fill=NA))%>%
  filter(Date>ymd("2020-9-10"))%>%
  select(Date, Site, Cases,SevenDayMACases)

#Importing the Madison waste water data
LIMSFullDF <- ParseData(LIMSFN)%>%
  filter(Site == "Madison")

#joining the two data frames together
FullDF <- full_join(LatCaseDF,LIMSFullDF, by = c("Date","Site"))

#what does the data look like? 
FullDF%>%
head()%>%
formattable()

```

The case data has a strong weekend effect so for this section we look at a seven day smoothing of cases. The simple display of the data shows the core components of this story. First that wastewater data is very noisy. And that there is a hint of a relationship between the two signals.

```{r BaseRelationship}
FirstImpressionDF <- FullDF%>%
  NoNa("N1","Cases")

FirstImpression <- FirstImpressionDF%>%#Removing outliers
  ggplot(aes(x=Date))+#Data depends on time
  geom_line(aes(y=N1, color="N1",info=N1))+#compares N1 to Cases
  geom_line(aes(y=MinMaxFixing(PMMoV,N1), color="PMMoV",info=PMMoV))+
  geom_line(aes(y=MinMaxFixing(FlowRate,N1), color="FlowRate",info=FlowRate))+
  geom_line(aes(y=MinMaxFixing(BCoV,N1), color="BCoV",info=BCoV))+
  #geom_line(aes(y=MinMaxFixing(temperature,N1), color="temperature",info=temperature))+
  #geom_line(aes(y=MinMaxFixing(tss,N1), color="tss",info=tss))+
  geom_line(aes(y=MinMaxFixing(equiv_sewage_amt,N1), color="equiv_sewage_amt",info=equiv_sewage_amt))+
  geom_line(aes(y=MinMaxFixing(SevenDayMACases,N1), color="Seven Day MA Cases",info=Cases))+
  geom_line(aes(y=MinMaxFixing(N2,N1), color="N2",info=N2))+
  labs(y="N1")



ggplotly(FirstImpression)


#To remove weekend effects we are looking at the 7 day smoothing of cases.
```


```{r outlierDetection}
IQRFunc <- function(Vector,Gap=1.5,na.rm=TRUE,Ret=1){
  BaseQuimt <- quantile(Vector,c(.25,.75),na.rm=na.rm)
  IQRVal <- IQR(Vector,na.rm=na.rm)
  MedianVal <- median(Vector,na.rm=na.rm)
  ReturnVals <- list(MedianVal,BaseQuimt[[2]]+Gap*IQRVal,BaseQuimt[[1]]-Gap*IQRVal)
  return(ReturnVals[[Ret]])
}
MedianFunc <- function(Vector,Gap=4,na.rm=TRUE,Ret=1){
  BaseVal <- median(Vector,na.rm=na.rm)
  ReturnVals <- list(BaseVal,Gap*BaseVal,BaseVal/Gap)
  return(ReturnVals[[Ret]])
}
MeanSDFunc <- function(Vector,Gap=2.5,na.rm=TRUE,Ret=1){
  MeanVal <- mean(Vector,na.rm=na.rm)
  SD <- sd(Vector,na.rm=na.rm)
  ReturnVals <- list(MeanVal,MeanVal+Gap*SD,MeanVal-Gap*SD)
  return(ReturnVals[[Ret]])
}
RollingFunc <- function(Vector,Method,DaySmoothed=21){
  ReturnThresh <- rollapply(data = Vector, width = DaySmoothed, FUN = Method, 
                            Ret=1,fill=NA)
  LowThresh <- rollapply(data = Vector, width = DaySmoothed, FUN = Method, 
                            Ret=2,fill=NA)
  HighThresh <- rollapply(data = Vector, width = DaySmoothed, FUN = Method, 
                            Ret=3,fill=NA)

  return(list(ReturnThresh,LowThresh,HighThresh))
}

#method returns list of outlier best guess of data
OutlierDetectRobustFunc <- function(Vector,method,n = 5,Bin = 21,Lines=FALSE){
  methReturn <- RollingFunc(Vector,method,DaySmoothed=Bin)
  BestVector <- Vector
  for(i in 1:n){
    methReturn <- RollingFunc(BestVector,method,DaySmoothed=Bin)
    BestVector <- ifelse(BestVector>methReturn[[2]]|
                           BestVector<methReturn[[3]],methReturn[[1]],BestVector)
  }
  BestVector <- ifelse(is.na(BestVector),methReturn[[1]],BestVector)
  if(Lines){
    return(methReturn)
  }
  return(BestVector)
}

DaySmoothed=21#Very wide smoothing to find where the data strong deviate from trend

ErrorMarkedDF <- FullDF%>%#Remove older Var data that clearly has no relationship to Cases
  mutate(EarlyOutlier = ifelse(Date < mdy("11/20/2020"),TRUE,FALSE))#replace old. 
#"11/20/2020"
#"1/1/2021"

ErrorMarkedDF$IQRRobustOutlier <- 
              OutlierDetectRobustFunc(ErrorMarkedDF[[SelectedIndVar]],IQRFunc)
ErrorMarkedDF$MedianRobustOutlier <-
              OutlierDetectRobustFunc(ErrorMarkedDF[[SelectedIndVar]],MedianFunc)
ErrorMarkedDF$SDMeanRobustOutlier <-
              OutlierDetectRobustFunc(ErrorMarkedDF[[SelectedIndVar]],MeanSDFunc)
ErrorMarkedDF$SelectedOutlierMethod <- (ErrorMarkedDF[["MedianRobustOutlier"]] + ErrorMarkedDF$SDMeanRobustOutlier + ErrorMarkedDF[["IQRRobustOutlier"]]) / 3
ErrorMarkedDF$DetectedOutlier <- 
              ErrorMarkedDF[[SelectedIndVar]] != ErrorMarkedDF$SelectedOutlierMethod
#Calculating error Limits
IQRThresh <- OutlierDetectRobustFunc(ErrorMarkedDF$N1, IQRFunc,Lines = TRUE)
MedThresh <- OutlierDetectRobustFunc(ErrorMarkedDF$N1, MedianFunc,Lines = TRUE)
SDThresh <- OutlierDetectRobustFunc(ErrorMarkedDF$N1, MeanSDFunc,Lines = TRUE)
ErrorMarkedDF$IQRLow <- IQRThresh[[2]]
ErrorMarkedDF$IQRHigh <- IQRThresh[[3]]
ErrorMarkedDF$MedLow <- MedThresh[[2]]
ErrorMarkedDF$MedHigh <- MedThresh[[3]]
ErrorMarkedDF$SDLow <- SDThresh[[2]]
ErrorMarkedDF$SDHigh <- SDThresh[[3]]
ErrorRemovedDF <- ErrorMarkedDF%>%
  mutate(PotentialOutlier = Date>mdy("03/31/2021")&mdy("05/12/2021")>Date)%>%
         select(-EarlyOutlier)#Removing unneeded calculated columns

```

```{r}
OutlierLines <- ErrorRemovedDF%>%
  ggplot(aes(x=Date))+
  geom_point(aes(y=N1,color=DetectedOutlier),size=1)+
  geom_line(aes(y=IQRHigh,color = "IQR"))+
  geom_line(aes(y=IQRLow,color = "IQR"))+
  geom_line(aes(y=MedHigh,color = "Median"))+
  geom_line(aes(y=MedLow,color = "Median"))+
  geom_line(aes(y=SDLow,color = "SD"))+
  geom_line(aes(y=SDHigh,color = "SD"))

ggplotly(OutlierLines)


ErrorMarkedDF%>%
  filter(!is.na(N1),
         DetectedOutlier)

#26 total outliers
#3 are outliers everywhere
```



```{r covariants outliers}

CoVarGraphic <- ErrorRemovedDF%>%
  ggplot()+#LargeError
  aes(y = N1,color=PotentialOutlier,info = Date)
#PotentialOutlier#DetectedOutlier
CoVarGraphicPMMoV <- CoVarGraphic+
  geom_point(aes(x = PMMoV))+
  geom_vline(xintercept = 25822285)+
  geom_vline(xintercept = 29760688)+
  geom_hline(yintercept = log(145702))+
  geom_hline(yintercept = log(380836))
#26203622#29931423
#149752.0#461781.5

CoVarGraphicFlowRate <- CoVarGraphic+
  geom_point(aes(x = FlowRate))
CoVarGraphicBCoV <- CoVarGraphic+
  geom_point(aes(x = BCoV))
CoVarGraphicequiv_sewage_amt <- CoVarGraphic+#temperature,equiv_sewage_amt
  geom_point(aes(x = equiv_sewage_amt))
#PMMoV,FlowRate,BCoV,temperature,equiv_sewage_amt
ggplotly(CoVarGraphicPMMoV)
ggplotly(CoVarGraphicBCoV)
ggplotly(CoVarGraphicFlowRate)
ggplotly(CoVarGraphicequiv_sewage_amt)

ErrorMarkedDF%>%
  group_by(DetectedOutlier)%>%
  summarize(median(PMMoV),median(N1))


AA <- ErrorRemovedDF%>%
  ggplot(aes(x=Date,y=equiv_sewage_amt))+
  geom_point()
ggplotly(AA)
```


```{r}


summary(lm(DetectedOutlier ~ PMMoV ,data = ErrorMarkedDF))

library(rpart)
fit <- rpart(DetectedOutlier ~ PMMoV + N1,
   method="class", data=ErrorMarkedDF)

printcp(fit)
plotcp(fit)
summary(fit)
plot(fit)
text(fit, use.n=TRUE, all=TRUE, cex=.5)

CoVarGraphicPMMoV <- CoVarGraphic+
  geom_point(aes(x = PMMoV))+
  geom_hline(yintercept = 5.61e5)+
  geom_vline(xintercept = 2.82e7)
ggplotly(CoVarGraphicPMMoV)


ErrorMarkedDF%>%
  ggplot(aes(x = DetectedOutlier, y = log(PMMoV))) +
        geom_boxplot()


t.test(PMMoV ~ DetectedOutlier, data = ErrorMarkedDF)

#26203622#29931423
#149752.0#461781.5
```