---
params:
  BaseDir: "Z:/"
  ##BaseDir: "/Volumes/byandell/"
title: "MainStory"
author: "Marlin"
date: "10/28/2021"
output: html_document
---

Overview

There is mainly 3 parts to this story:

1) A simple easy to communicate model of the key relationship

2) A medium complexity smoothing analysis

3) A full power time series analysis with causal inference



The two data set used in this analysis are the Madison case and waste water concentration data.

```{r set up markdown settings, echo=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE
)
```


```{r Start enviroment, message=FALSE, warning=FALSE, echo=FALSE}
library(ggpubr)
library(forecast)
library(lmtest)
library(lubridate)
library(limma)
library(zoo)
library(dplyr)
library(readxl)

#Data Files and prep work
source("../../lib/GenPlotMaking.R")
#source("../../lib/WasteWaterDataProccess.R")
#source("../../lib/CasesDataProccess.R")
source("../../lib/DataProccess.R")
source("../../lib/HelperFunctions.R")


source("../../lib/NoTSCorrelationFunctions.R")
```

```{r DF Set Up, echo=FALSE}
BaseDir <- params$BaseDir

MadisonCaseFN  <-  paste0(BaseDir,"COVID-19_WastewaterAnalysis/data/processed/MMSD_Cases_processed.csv")
LIMSFN <- paste0(BaseDir,"COVID-19_WastewaterAnalysis/data/processed/LIMSWasteData_2021-06-30_17-40.csv")

LatCaseDF <- ParseData(MadisonCaseFN)%>% 
  filter(!is.na(Site)) %>%
  select(Date,Site,Cases,Tests,Per_pos)

LatCaseDFRoll <- RollPerPos(LatCaseDF,"Cases","Tests",Facet="Site",n = 14)

FullLatCaseDFRoll <- full_join(LatCaseDF,LatCaseDFRoll,by=c("Date","Site"),suffix=c("",".Rolled"))%>%
  filter(Site=="Madison",
         Per_pos.Rolled!=-500,
         Date>=ymd("2020-08-15"))
  

LIMSFullDF <- ParseData(LIMSFN)%>%
  select(Date,Site, N1,N1Error)%>%
  filter(Site=="Madison")

head(FullLatCaseDFRoll)
head(LIMSFullDF)
```

A simple display of the data shows the core components of this story. First that both data sets are extremely noisy.
And that there is a hint of a relationship between the two signals. 

```{r plot of base relationship}
ggplot()+
  geom_line(aes(x=Date,y=(N1-min(N1,na.rm=TRUE))/max(N1,na.rm=TRUE),color="N1"),data=LIMSFullDF)+
  geom_line(aes(x=Date,y=(Cases-min(Cases,na.rm=TRUE))/max(Cases,na.rm=TRUE),color="Cases"),data=FullLatCaseDFRoll)+
  labs(y="variable min max normalized")
```
A key component to this relationship is that the relationship between N1 and Case involves a gamma distribution modeling both the time between catching Covid-19 and getting a test and the concentration of the shedded particles. We found a gamma distribution with mean 11.73 days and a sd of 7.68 match's other research and gives good results.

```{r SLD}
scale =5.028338
shape =2.332779

weights <- dgamma(1:21,scale = scale,shape = shape)
plot(weights, 
            main=paste("Gamma Distribution with mean = 11.73 days, and SD = 7.68"),
            ylab = "Weight",
            xlab = "Lag")


SLDDF <- SLDSmoothing(FullLatCaseDFRoll,"Cases",Weights=weights)%>%
  filter(Site %in% c("Madison"))

ggplot()+
  geom_line(aes(x=Date,y=(SLDCases-min(SLDCases,na.rm=TRUE))/max(SLDCases,na.rm=TRUE),color="SLDCases"),data=SLDDF)+
  geom_line(aes(x=Date,y=(N1-min(N1,na.rm=TRUE))/max(N1,na.rm=TRUE),color="N1"),data=LIMSFullDF)+
  facet_wrap(~Site)+
  labs(y="variable min max normalized")
```

To aid this smoothing we have a first pass of removing obvious outliers and doing light smoothing of the N1 data.

```{r smoothing}
DaySmoothed <- 4


RefinedLIMSFullDF <- LIMSFullDF%>%
  mutate(SmoothN1=c(rep(NA,DaySmoothed-1),rollmedian(N1,DaySmoothed)))

RefinedLIMSFullDF%>%
  ggplot()+
  geom_line(aes(x=Date,y=(SmoothN1-min(SmoothN1,na.rm=TRUE))/max(SmoothN1,na.rm=TRUE),color="SmoothN1"))+
  geom_line(aes(x=Date,y=(SLDCases-min(SLDCases,na.rm=TRUE))/max(SLDCases,na.rm=TRUE),color="SLDCases"),data=SLDDF)+
  facet_wrap(~Site)

```


To isolate this relationship we used a primitive binning relationship. This clarifies the relationship we see hints of in the previous graphic and masks the noise in the data. 


```{r binning part}
medianMean <- function(Vec){
  return(mean(replace(Vec, c(which.min(Vec), which.max(Vec)), NA), na.rm = TRUE))
}

StartDate=4
DaySmoothing=7
Lag=14

BinDF <- full_join(SLDDF,RefinedLIMSFullDF,by=c("Date","Site"))%>%
  select(Date,SLDCases,SmoothN1)%>%
    mutate(MovedCases = data.table::shift(SLDCases,Lag),
           Week=(as.numeric(Date)+StartDate)%/%DaySmoothing)%>%
    group_by(Week)%>%
  #filter(SmoothN1<max(SmoothN1,na.rm=TRUE)/1.5)%>%
  #filter(Week>2650)%>%
  summarise(BinnedCases=mean(MovedCases,na.rm=TRUE),BinnedN1=mean(SmoothN1,na.rm=TRUE))



BinDF%>%
  ggplot()+
  geom_line(aes(x=Week,y=(BinnedN1-min(BinnedN1,na.rm=TRUE))/max(BinnedN1,na.rm=TRUE),color="N1"))+
  geom_line(aes(x=Week,y=(BinnedCases-min(BinnedCases,na.rm=TRUE))/max(BinnedCases,na.rm=TRUE),color="Cases"))+
  labs(y="Binned variable min max normalized")

BinDF%>%
  ggplot()+
  geom_point(aes(x=BinnedCases,y=BinnedN1))

cor(BinDF$BinnedN1,BinDF$BinnedCases,use="pairwise.complete.obs")
summary(lm(BinnedCases~BinnedN1,data=BinDF))
```




To generate this relationship without reducing the amount of data we rely on a Loess smoothing of the data. The first step is to get a more rigorous measure of the relationship of the data. Here we will use cross correlation. These figures support the work done in previous steps.

```{r ccf on previous data structures}
ccf(SLDDF$Cases,RefinedLIMSFullDF$N1,na.action=na.pass)
#title(main ="Cases Vs. N1")

ccf(SLDDF$SLDCases,RefinedLIMSFullDF$N1,na.action=na.pass)
#title(main="SLD Smoothed Cases Vs.N1")
ccf(SLDDF$SLDCases,RefinedLIMSFullDF$SmoothN1,na.action=na.pass)
#title(main="SLD Smoothed Cases Vs. Smoothed N1")
ccf(BinDF$BinnedCases,BinDF$BinnedN1,na.action=na.pass)
#title(main="Binned Cases Vs. Binned N1")
```
The loess smoothing is a way of generating smooth curves from noisy data. The displayed plot shows the visual power of this smoothing.

```{r loess smoothing and some intro CCF processes}
RefinedLIMSFullDF$loessN1 <- loessFit(y=(RefinedLIMSFullDF$N1),
                      x=RefinedLIMSFullDF$Date,
                      #weights=1/RefinedLIMSFullDF$N1Error,
                      span=.15,
                      iterations=3)$fitted


RefinedLIMSFullDF%>%
  ggplot()+
  geom_line(aes(x=Date,y=(loessN1-min(loessN1,na.rm=TRUE))/max(loessN1,na.rm=TRUE),color="loessN1"))+
  geom_line(aes(x=Date,y=(SLDCases-min(SLDCases,na.rm=TRUE))/max(SLDCases,na.rm=TRUE),color="SLDCases"),data=SLDDF)+
  facet_wrap(~Site)+
  labs(y="variable min max normalized")




ccf(RefinedLIMSFullDF$loessN1,SLDDF$SLDCases,na.action=na.pass)
```



Finally we wish to get a statistically powerful analysis we turn to formal time series tools like ARIMA models.
```{r arima models, var models, some predictive relationship}

FullDF <- full_join(RefinedLIMSFullDF,SLDDF,by=c("Date","Site"))%>%
  select(loessN1,SLDCases)


VARMA(FullDF,p=1,q=1,include.mean=FALSE)

```



