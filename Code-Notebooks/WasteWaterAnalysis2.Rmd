---
title: "WasteWater Analysis 2.0"
author: "Steve Goldstein and Marlin Lee"
date: "6/1/2021"
output:
  html_document: default
  pdf_document: default
---


```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE,warning = FALSE)
knitr::opts_chunk$set(fig.width=9, fig.height=9) 
#library(shiny)
library(ggpubr)
library(dplyr)
# library(shinydashboard)
# library(shinyjqui)
# library(shinycssloaders)
library(limma)

#Data Files and prep work
source("../Scripts/GenPlotMaking.R")
source("../Scripts/WasteWaterDataProccess.R")
source("../Scripts/CassesDataProccess.R")
source("../Scripts/HelperFunctions.R")


source("../Scripts/WasteShiny/PrepData.R", local = TRUE)


# a=LIMSFullDF%>%
#   select(Site,Date)%>%
#   mutate(DataSet="LIMSData")
# 
# b=LatWasteDF%>%
#   mutate(Site=ifelse(Site=="MMSD P11","MMSD-P11",Site),
#          Site=ifelse(Site=="MMSD P18","MMSD-P18",Site),
#          Site=ifelse(Site=="MMSD P7","MMSD-P7",Site),
#          Site=ifelse(Site=="MMSD P8","MMSD-P8",Site),
#          Site=ifelse(Site=="MMSD P2","MMSD-P2",Site))
# 
# bb=full_join(a,b,by=c("Site","Date"))%>%
#   filter(is.na(DataSet))%>%
#   mutate(N1Error=NA)%>%
#   select(Date,Site,N1,N1Error)
# 
# bb
# aa=LIMSFullDF%>%
#   select(Date,Site,N1,N1Error)
# 
# LIMSFullDF <- full_join(aa,bb,by=c("Date","Site"))%>%
#   mutate(N1=ifelse(is.na(N1.x),N1.y,N1.x),
#          N1Error=N1Error.x)%>%
#   select(Date,Site,N1,N1Error)%>%
#   filter(is.na(N1Error))
# 
# LIMSFullDF%>%
#   group_by(Site)%>%
#   summarise(n=n(),Dur=max(Date)-min(Date))
#LoessSmoothPlot(SiteS="MMSD-P2",Span=.1,min=0,max=120,Title = F,FullLim=F,SiteLab=F)
```



```{r start up, include=FALSE}

HFGPop=read.csv("../../UntrackedData/HFGPop.csv.txt")%>%
  select(Site=wwtp_name,Population=pop_served)


ConfigOption=list(
      myseed=1234567890,
      XAxisLabSiz=10,
      YAxisLabSiz=15,
      GenFontSiz=20,
      alphaPoint=.7,
      PointSize=2,
      alphaWeek=.2)
    
```

```{r, include=FALSE}
DayRolling=7



LatCaseDFRoll=RollPerPos(LatCaseDF,"Cases","Tests",Facet="Site",n=DayRolling)%>%
  select(Date,Site,Cases,Per_pos)#%>%
  #mutate(Date=Date-DayRolling/2)

CasePlotMaking = function(SiteS,Method="Cases"){
  SiteCases=LatCaseDF%>%
    filter(Site==SiteS)

  SiteCasesRoll=LatCaseDFRoll%>%
    filter(Site==SiteS)
  
  LIMSSiteDF=LIMSFullDF%>%
   filter(Site==SiteS)


  Date_lim_long=c(min(LIMSSiteDF$Date),max(LIMSSiteDF$Date))
  
  CasePlot <- Buildplot_gen(
      Method,
      MainDF=SiteCases,
      Loc="Site",
      LineDF=SiteCasesRoll,
      Xfreq="30 days",
      DateLimits=Date_lim_long,
      Standards=ConfigOption,
      AxisPos="bottom",
      LineColor="red",
      Colplot=TRUE) + Header_theme(ConfigOption)
  return(CasePlot)
  
}

#CasePlotMaking("Madison")
```

```{r Loess Model, include=FALSE}
#Gen Both Cases and per Pos plot
LoessSmoothPlot <- function(SiteS,Span=.3,min=1e-5,max=1e5,BoxWidth=.5,Independent="N1",Dependent="N1Error",HasNo=F, Title=T,FullLim=F,SiteLab=T){
  PlaceHolder=""
  if(HasNo){
    PlaceHolder="no"
  }
  LIMSDF=LIMSFullDF%>%
    filter(Site==SiteS)%>%
    mutate(Indy=!!sym(Independent),
           Dep=!!sym(Dependent))%>%
    filter(!is.na(Dep),
           !is.na(Indy),
           Dep>0,
           Indy>0)
    
  DFSize=dim(LIMSDF)[1]
  ConWeightModel=loessFit(y=LIMSDF$Indy,
                       x=LIMSDF$Date,
                       weights=rep(1,DFSize),
                       span=Span,
                       min.weight=min,
                       max.weight=max,
                       iterations=10)

  SEWeightModel=loessFit(y=LIMSDF$Indy,
                       x=LIMSDF$Date,
                       weights=LIMSDF$Indy/LIMSDF$Dep,
                       span=Span,min.weight=min,
                       max.weight=max,
                       iterations=10)
  LIMSDF$Pred1 <- ConWeightModel$fitted
  LIMSDF$PredSE <- SEWeightModel$fitted
  LoessPlot=LIMSDF%>%
    mutate(ErrorMin=Indy-Dep,ErrorMax=Indy+Dep)%>%
        mutate(ErrorMin=ifelse(ErrorMin>0,ErrorMin,0))%>%
        ggplot()+
        aes(x=Date)+
        geom_rect(aes(ymin=ErrorMin,ymax=ErrorMax,xmin=Date-BoxWidth,xmax=Date+BoxWidth),color="black",alpha=.25)+
        geom_rect(aes(ymin=Indy,ymax=Indy,xmin=Date-BoxWidth,xmax=Date+BoxWidth),color="black",alpha=.25)+
        geom_line(aes(y=Pred1,color="1"),size=1.25)#+
        geom_line(aes(y=PredSE,color=paste0(Independent,"/",Dependent)),size=1.25)
  if(SiteLab){
    LoessPlot=LoessPlot+facet_wrap(~Site)
  }
  LoessPlot=LoessPlot+
        scale_y_log10()+
        labs(color="Weights Used")+
    ylab(Independent)+
    Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(0,0,0,0), "cm"))+ 
    theme(legend.position = "bottom")+
    ggtitle("")
  if(Title){
    LoessPlot=LoessPlot+
      ggtitle(paste0("Weighted loess smoothing with ",PlaceHolder," truncation 
                   loessFit(",Independent, " ~ Date, span=",Span,")"))
  }
  if(FullLim){
    XVar=LIMSFullDF$Date
    YVar=pull(LIMSFullDF,Independent)
    XLim <- c(min(XVar),max(XVar))
    YLim <- c(min(YVar[YVar!=0]),max(YVar))
    LoessPlot <- LoessPlot+
      scale_x_date(limits = XLim)+
      scale_y_log10(limits = YLim)
  }
  return(LoessPlot)
}

```

Due to the large variations of the N1 concentration we have tried to create a smoothed version of the data set that captures the underlying shifts of the data. Below is our best attempt at smoothing the N1 concentration data. It shows relation to case data given the spread of shedding of N1. This relationship holds for N2 as well.

To Do: Pick a set of graphs to show. %Pos or Cases

```{r,  echo=FALSE}

N1Plot=LoessSmoothPlot(SiteS="Madison",Span=.1,min=0,max=120,Title = F,FullLim=F,SiteLab=F)
PerPosPlot=CasePlotMaking("Madison",Method="Per_pos")
CasePlot=CasePlotMaking("Madison")

#ggarrange(CasePlot,N1Plot,nrow=2,common.legend = TRUE ,align ="hv")
#ggarrange(PerPosPlot,N1Plot,nrow=2,common.legend = TRUE,align ="hv")

annotate_figure(ggarrange(CasePlot,N1Plot,nrow=2,common.legend = TRUE ,align ="hv"),top = text_grob("Weighted loess smoothing compared to cases)", color = "black", face = "bold", size = 14))
annotate_figure(ggarrange(PerPosPlot,N1Plot,nrow=2,common.legend = TRUE,align ="hv"),top = text_grob("Weighted loess smoothing compared to percent positive)", color = "black", face = "bold", size = 14))



```



To use standard Error measurements in our smoothing we needed to have it be an unbiased estimate given the concentration. A strong correlation between N1 and N1Error means it needs to be controlled for. Using standard error normalized by N1 gave a meaningful measurement of the consistency of the data.

***No strong relationship existed between the modified standard error and other predictors like Percent bovine recovery and PMMoV***


```{r SE Pred N1 Gen, echo=FALSE}

#ToDo: add custom Weighting
#How to deal with -N2Errors
SimpleN1ErrorN1Model <- function(Independent,Dependent,...){
  TempDF <- LIMSFullDF%>%
    mutate(Indy=!!sym(Independent),
           Dep=!!sym(Dependent))%>%
    filter(!is.na(Dep),
           !is.na(Indy),
           Dep>0,
           Indy>0)
  UnWeightedModelFull2 <- lm(Dep~Indy-1,weights=Indy/Dep,data=TempDF)
  
  TempDF%>%
    mutate(FullDataPredict=predict.lm(UnWeightedModelFull2,.))%>%
    ggplot()+aes(x=Indy)+
    geom_point(aes(y=Dep),size=1)+
    geom_smooth(aes(y=Dep),method="lm",se=F,formula=y~0+x)+
    #geom_point(aes(y=FullDataPredict,color="Predicted"),size=1)+
    scale_x_log10()+
    scale_y_log10()+
    ggtitle("LM (N1Error ~ N1 - 1)")+
    ylab(Dependent)+
    xlab(Independent)+
    theme(aspect.ratio=1)
}
#,Weight="INDDep"
SimpleN1ErrorN1Model(Independent="N1",Dependent="N1Error")

#Add aspect=1
#add slope to plot
```





2. smoothing of N1 for Madison


Boxes represent N1 plus or minus 1 1 Error



Below is the two versions of the smoothed data capturing different scales of its variations. 



```{r SmoothPlot, echo=FALSE}


LoessSmoothPlot(SiteS="Madison",Span=.1,min=0,max=120)

LoessSmoothPlot(SiteS="Madison",Span=.3,min=0,max=120)



#Text explaining boxes
#Boxes are N1 +-N1Error
#make boxes stand out less


#Sparse Main Plots in 1 Documents
#auxiliary plots in other locations and loess smoothing:
#Different weightings
#weighting
#Residuals
#Weighted loess smoothing with truncation loessFit(N1 ~ Date, span=.3)
```


. smoothing of N1 for interceptors


```{r, echo=FALSE,include=TRUE}
G1 <- LoessSmoothPlot(SiteS="Madison",Span=.3,max=20, Title=F,FullLim=T)
G2 <- LoessSmoothPlot(SiteS="MMSD-P2",Span=.3,max=20, Title=F,FullLim=T)
G3 <- LoessSmoothPlot(SiteS="MMSD-P7",Span=.3,max=20, Title=F,FullLim=T)
G4 <- LoessSmoothPlot(SiteS="MMSD-P8",Span=.3,max=20, Title=F,FullLim=T)
G5 <- LoessSmoothPlot(SiteS="MMSD-P11",Span=.3,max=20, Title=F,FullLim=T)
G6 <- LoessSmoothPlot(SiteS="MMSD-P18",Span=.3,max=20, Title=F,FullLim=T)

#LoessSmoothPlot(SiteS="UW-Sellery",Span=.3,max=20)
#LoessSmoothPlot(SiteS="UW-LakeShore",Span=.3,max=20)

SixPlots=ggarrange(G1,G2,G3,G4,G5,G6, nrow=3,ncol=2, common.legend = T)
annotate_figure(SixPlots,top = text_grob("Weighted loess smoothing with truncation
                                                                                loessFit(N1 ~ Date, span=.3)", color = "black", face = "bold", size = 14))
```





