---
title: "WasteWater Analyses"
author: "Marlin"
date: "6/1/2021"
output:
  pdf_document: default
  html_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


```{r Importing, include=FALSE}
library(shiny)
library(ggpubr)
library(dplyr)
library(shinydashboard)
library(shinyjqui)
library(shinycssloaders)

#Data Files and prepwork
source("../Scripts/GenPlotMaking.R")
source("../Scripts/WasteWaterDataProccess.R")
source("../Scripts/CassesDataProccess.R")
source("../Scripts/HelperFunctions.R")
LatWasteFN <- "../../UntrackedData/WW SARS-COV-2 Data V5.xlsx"
LatSpringCaseFN="../../UntrackedData/SpringSemester_CasesByDorm.tsv"
LatFallCaseFN="../../UntrackedData/FallSemester_CasesByDorm.tsv"
HFGWasteFN = "../../UntrackedData/HFG data for stats preliminary 3-18-21.xlsx"
HFGCaseFN="../../UntrackedData/HighFreq_CaseData_2021-05-07.csv"
LatMMSDFN = "../../UntrackedData/MMSD_Cases.2021-05-21.csv"

```

```{r start up, include=FALSE}
HFGFrame=HFGInfo(HFGWasteFN)%>%
  select(Date,Site=Plant,Filter,Well,N1=N1GC,N2=N2GC,PMMoV=PMMOVGC,Pct_BCoV=BCoV)%>%
  mutate(Filter=as.character(Filter),Well=as.character(Well))%>%
  rename(`Filter replicates`=Filter)


HFGCaseDF=HFGCasesPARSER(HFGCaseFN)



HFGCaseDFRoll=HFGCaseDF%>%
  mutate(EpisodeCases=ifelse(EpisodeCases==-999,2.5,EpisodeCases))%>%
  mutate(CollectedCases=ifelse(CollectedCases==-999,2.5,CollectedCases))%>%
  mutate(ConfirmedCases=ifelse(ConfirmedCases==-999,2.5,ConfirmedCases))%>%
  RollAvg(Facet="Site")%>%
  select(Date,Site,ends_with("Cases"))

HFGPop=read.csv("../../UntrackedData/HFGPop.csv.txt")%>%
  select(Site=wwtp_name,Population=pop_served)

HFGCaseDF=full_join(HFGPop,HFGCaseDF,by="Site")

HFGCaseDFRoll=full_join(HFGPop,HFGCaseDFRoll,by="Site")



HFGDateRangeDF=WeekendGen(HFGCaseDF$Date)

LatCaseDF=CovidDataPARSER(LatSpringCaseFN,LatFallCaseFN,LatMMSDFN)%>%
  filter(!is.na(Site))%>%
  select(Date,Site,Cases,Tests,Per_pos)

#return(LatCaseDF)
LatCaseDFRoll=RollPerPos(LatCaseDF,"Cases","Tests",Facet="Site")%>%
  select(Date,Site,Cases,Per_pos)

LatWasteDF=WasteWater(LatWasteFN)%>%
  mutate(Date=as.Date(Date))%>%
  filter(!is.na(Date),!is.na(N1),!is.na(Site))%>%
  filter(Date<mdy("6/5/2021"))%>%
  select(Date,Site,N1,N2,PMMoV,Pct_BCoV,AVG)


ConfigOption=list(
      myseed=1234567890,
      XAxisLabSiz=10,
      YAxisLabSiz=15,
      GenFontSiz=20,
      alphaPoint=.7,
      PointSize=2,
      alphaWeek=.2)
    
```



Focus on HFG. Why? replicates and our best shot. (future: graphic and analysis computing, e.g. variances.




```{r paused down, fig.height = 8, fig.width = 15,include=F}
N1Start=min(HFGFrame$Date)
N1End=max(HFGFrame$Date)
CStart=min(HFGCaseDF$Date)
CEnd=max(HFGCaseDF$Date)
SiteOptions=c("Hudson","Kenosha","Platteville","Madison", "Merrill","Plymouth","River Falls","Sun Prairie","Wausau","Oshkosh")


HFGCaseDFRoll%>%
  ggplot()+aes(x=Date)+geom_point(aes(y=ConfirmedCases,x=Date-2))+
  scale_x_date(limits=c(N1Start,N1End))+
  facet_wrap(~Site,scales = "free")+ggtitle("Sparse HFG Case Data")
  
SiteOptions2=c("Kenosha","Madison", "Sun Prairie","Wausau","Oshkosh")

HFGFrame%>%
  filter(!is.na(N1),Site %in% SiteOptions2)%>%
  group_by(Site)%>%
  summarize(`N1 testing Range`=max(Date)-min(Date),NDays=length(unique(Date)))

SiteOptions2=c("Kenosha","Madison", "Sun Prairie","Wausau")


```

```{r No Clear relation,include=F}
MaskedDataRange="1-4 Cases"
RelData=HFGCaseDF%>%
  filter(Site %in% SiteOptions2)%>%
    mutate(Small3=ifelse(EpisodeCases==-999,MaskedDataRange,"Normal Values"))%>%
    mutate(PHI_masking=ifelse(CollectedCases==-999,MaskedDataRange,"Reported values"))%>%
    mutate(Small2=ifelse(ConfirmedCases==-999,MaskedDataRange,"Normal Values"))%>%
    filter(!is.na(PHI_masking))%>%
    mutate(EpisodeCases=ifelse(EpisodeCases==-999,2.5,EpisodeCases))%>%
    mutate(CollectedCases=ifelse(CollectedCases==-999,2.5,CollectedCases))%>%
    mutate(ConfirmedCases=ifelse(ConfirmedCases==-999,2.5,ConfirmedCases))
RelRollData=HFGCaseDFRoll%>%
  filter(Site %in% SiteOptions2)

RelWasteData=HFGFrame%>%
    filter(!is.na(Site))%>%
    filter(Site %in% SiteOptions2)

Data_mean_var = reactive({
  HFGSiteMean=filtered_data_P()%>%
    group_by(Date,Site)%>%
    summarise(N1=exp(mean(log(N1),na.rm = T)),
              N2=exp(mean(log(N2),na.rm = T)),
              PMMoV=exp(mean(log(PMMoV),na.rm = T)),
              Pct_BCoV=exp(mean(log(Pct_BCoV),na.rm = T)))
})
#Data of the means of each Filter
Filter_mean_var = reactive({
  HFGFilterMean=filtered_data_P()%>%
    group_by(Date,Site,`Filter replicates`)%>%
    summarise(N1=exp(mean(log(N1),na.rm = T)),
              N2=exp(mean(log(N2),na.rm = T)),
              PMMoV=exp(mean(log(PMMoV),na.rm = T)),
              Pct_BCoV=exp(mean(log(Pct_BCoV),na.rm = T)))
})
source("../Scripts/GenPlotMaking.R")
```



Cases: for Madison and Kenosha (and Sun Prairie + Wausau if they are plotted in PMMoV section.
Points: larger pop avoids problematic small pop areas (low numbers have a lot of variance; 1-4 => -999.
also: relatively small sample size (relative to variance in case counts):
short duration; some flowage districts haver fewer observations.
Describe plots of cases (or %positive): Unimodal: is there a trend? segmentation? can't say;
Cases plot:



```{r No claer relation Cases, fig.height = 6, fig.width = 16}
#c(N1Start,N1End)

Date_lim_HFG=c(min(RelData$Date)-2,max(RelData$Date)+2)

HFDCasesGraphic=Buildplot_gen("CollectedCases",
  MainDF=RelData,
  ColorType="PHI_masking",
  Loc="Site",
  LineDF=RelRollData,
  WeekDF=HFGDateRangeDF,
  DateLimits=Date_lim_HFG,
  Standards=ConfigOption,
  Xfreq="14 days",
  AxisPos="bottom",
  LineColor="red",
  norm="Population",
  Colplot=T,
  Start=N1Start,
  End=N1End,
  nrow=2)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

#ordered factor
#arrow point to lines
#label span of hf collection
#arrow at bottom
#add text box to explain lines

scopeText=geom_text(aes(label = "Range of HF collection"))

HFDCasesGraphic+ annotate("text", x = N1Start+11.5, y = max(RelData$CollectedCases/RelData$Population), label = "<-  Range of HF collection  ->")


#add arrows

```



N1:
left (and right?): outliers called out by Dagmara; action: ignore them.
remaining dips: what are they:
3 interpretations: (a) real dip; (b) just chaotic quirky;
(c) longer explanation: 9 replicates have low var; OK good experiment; good benchwork.
now think about the stochasticity of the sampling process; you capture a liter of ww
whose N1 concentration is a random variable.
Plot: N1 for 2 or 4 welts.




```{r No clear relation N1, fig.height = 6, fig.width = 16}
meanOfN1=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  group_by(Site,Date)%>%
  summarise(N1=exp(mean(log(N1),na.rm=T)))%>%
  select(Date,Site,N1)%>%
  mutate(lower=N1-2*0.2199*N1)%>%
  mutate(Upper=N1+2*0.2199*N1)

N1PlotGraphic=Buildplot_gen(
  "N1",
  MainDF=RelWasteData,
  LineDF =meanOfN1,
  Loc="Site",
  YLabel = "N1 (GC/L)",
  log_scale=T,
  ColorType="Filter replicates",
  DateLimits=Date_lim_HFG,
  RMOutliers=T,
  AxisPos="bottom",
  Standards=ConfigOption,
  Xfreq="14 days",
  nrow=2)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

N1PlotGraphic

#EpisodeCases    ConfirmedCases CollectedCases
#annotate_figure(top=text_grob("No clear pattern partially due to short time frame",size=15),ggarrange(p1,p2,nrow = 2,align="hv",common.legend = T))
#yaxis needs units=
#N1 (GC/L)
```




```{r predicting varience, fig.height = 6, fig.width = 16}
#Description

HFGFrame%>%
  select(Date,Site,`Filter replicates`,N1)%>%
  group_by(Site,Date)%>%
  summarize(mN1=exp(mean(log(N1))),vN1=var(N1))%>%
  ggplot()+geom_point(aes(x=mN1,y=sqrt(vN1),color=Site))+
  scale_y_log10()+scale_x_log10()+ylab("SD")+xlab("Daily geometric mean of N1")+
  ggtitle("Measurement error scales linearly")



# Buildplot_gen(
#   "N1",
#   MainDF=RelWasteData,
#   #LineDF =meanOfN1,
#   Loc="Site",
#   YLabel = "N1 (GC/L)",
#   log_scale=T,
#   ColorType="Filter replicates",
#   DateLimits=Date_lim_HFG,
#   RMOutliers=T,
#   AxisPos="bottom",
#   Standards=ConfigOption,
#   Xfreq="14 days",
#   boxingDF=meanOfN1,
#   nrow=2)+ Header_theme(ConfigOption)+
#       theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
#             plot.margin = unit(c(.5,0,0,0), "cm"))


#N1PlotGraphic+geom_rect(aes(ymin=lower,ymax=Upper,xmin=Date-.3,xmax=Date+.3),fill="red",alpha=.6,data=meanOfN1)

```

%BoCov and PMMOV
can we use these? answer: don't see how.

```{r outliers PMMoV, fig.height = 6, fig.width = 16}
#fix order to low medium high
#add x axis label
#PMMoV (GC/L)
HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  mutate(`PMMoV Level`=ifelse(PMMoV<1*10^7,"Low","Medium"))%>%
  mutate(`PMMoV Level`=ifelse(PMMoV>1*10^8,"High",`PMMoV Level`))%>%
  ggplot()+aes(x=PMMoV,y=N1,color=`PMMoV Level`)+geom_point()+scale_y_log10()+
  scale_x_log10()+facet_wrap(~Site)+ggtitle("relationship of PMMoV to N1")+ Header_theme(ConfigOption)+
  xlab("PMMoV (GC/L)")+ylab("N1 (GC/L)")+
  theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  mutate(`PMMoV Level`=ifelse(PMMoV<1*10^7,"Low","Medium"))%>%
  mutate(`PMMoV Level`=ifelse(PMMoV>1*10^8,"High",`PMMoV Level`))%>%
  ggplot()+aes(x=Date,y=N1,color=`PMMoV Level`)+ Header_theme(ConfigOption)+geom_point()+
  ylab("N1 (GC/L)")+
  scale_y_log10()+facet_wrap(~Site)+#ggtitle("relationship of PMMoV to N1")+
  theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

```

```{r outliers Per_Bcov, fig.height = 6, fig.width = 13}
HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  filter(N1<2e6)%>%
  #mutate(marked=ifelse(Pct_BCoV<.5,"Low %Bcov","MAIN G"))%>%
  #mutate(marked=ifelse(Pct_BCoV>10,"High %Bcov",marked))%>%
  ggplot()+aes(x=Pct_BCoV,y=N1)+geom_point()+
  #scale_y_log10()+
  #scale_x_log10()+
  facet_wrap(~Site)+
  ggtitle("N1 Vs %Bcov looking for trend")
#, scales = "free"
#scale_x_log10()+,color=marked

HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  mutate(marked=ifelse(Pct_BCoV<1,"%Bcov<.5","MAIN G"))%>%
  mutate(marked=ifelse(Pct_BCoV>10,"%Bcov >10%",marked))%>%
  ggplot()+aes(x=Date,y=N1,color=marked)+geom_point()+
  scale_y_log10()+facet_wrap(~Site)+
  ggtitle("N1 Vs Date using thresholding")
#meam=data.frame(a=1:1000)
#meam$b=30*runif(1000)-15
#meam%>%
#  mutate(noiscor=a+b)%>%
#  ggplot()+geom_point(aes(x=a,y=noiscor))+
#  scale_y_log10()+
#  scale_x_log10()
```

```{r Thresholding Dorms, fig.height = 8, fig.width = 15, include=F}
# shift=-0
# LeftDate=min(LatWasteDF$Date)
# RightDate=max(LatWasteDF$Date)
# p1=LatWasteDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date,y=N1)+geom_point(aes(color=N1>5e4))+
#   #scale_y_log10()+
#   #geom_smooth(span=.42)+
#   facet_wrap(~Site)+
#   scale_x_date(limits=c(LeftDate,RightDate))
# 
# p2=LatCaseDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Cases))+
#   geom_line(aes(y=SevCases))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p3=LatCaseDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   filter(Tests<2000)%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Tests,color="Tests"))+
#   geom_line(aes(y=SevTest,color="Tests"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p4=LatCaseDF%>%
#   filter(Per_pos<50)%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Per_pos,color="Per_pos"))+
#   geom_line(aes(y=rollingPer_pos,color="Per_pos"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# annotate_figure(top=text_grob("Dorm data with thresholding",size=15),ggarrange(plotlist = list(p1,p2),nrow = 2,align="hv",common.legend = T))

```



```{r Thresholding Gen, fig.height = 16, fig.width = 15, include=F}
# shift=-0
# LeftDate=min(LatWasteDF$Date)
# RightDate=max(LatWasteDF$Date)
# p1=LatWasteDF%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date,y=N1)+geom_point(aes(color=N1>5e4))+
#   scale_y_log10()+
#   #geom_smooth(span=.42)+
#   facet_wrap(~Site)+
#   scale_x_date(limits=c(LeftDate,RightDate))
# 
# p2=LatCaseDF%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Cases,color="Cases"))+
#   geom_line(aes(y=SevCases,color="Cases"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p3=LatCaseDF%>%
#   filter((Site=="Madison"))%>%
#   filter(Tests<2000)%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Tests,color="Tests"))+
#   geom_line(aes(y=SevTest,color="Tests"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p4=LatCaseDF%>%
#   filter(Per_pos<50)%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Per_pos,color="Per_pos"))+
#   geom_line(aes(y=rollingPer_pos,color="Per_pos"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# ggarrange(plotlist = list(p1,p2,p3,p4),nrow = 4,align="hv")

```

UW thresholding / box plots; (remove winter break)

Points are easily masked if we think they are unneeded

```{r boxplots, fig.height = 8, fig.width = 15}
NovemberBreak=seq(from=mdy("12/18/2020"),to=mdy("1/25/2021"),by=1)

shift=-0
LeftDate=min(LatWasteDF$Date)
RightDate=max(LatWasteDF$Date)

p1=LatWasteDF%>%
  filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
  filter(!(Date %in% NovemberBreak))%>%
  mutate(Loc="10")%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("1/25/2021"),"4",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("12/18/2020"),"3",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("11/18/2020"),"2",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("10/18/2020"),"1",Loc))%>%
  
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("2/5/2021"),"5",Loc))%>%
  #mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("12/18/2020"),"4",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("12/18/2020"),"3",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("11/4/2020"),"2",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("10/11/2020"),"1",Loc))%>%
  ggplot()+
  geom_boxplot(aes(y=N1,x=Date,group=Loc),fill="light blue")+
  geom_point(aes(y=N1,x=Date,color=Loc),fill="light blue")+
  scale_y_log10()+
  facet_wrap(~Site)
  scale_x_date(limits=c(LeftDate,RightDate))

  
RelCaseLongDF=LatCaseDF%>%
   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))
RelCaseLongRollDF= LatCaseDFRoll%>%
   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))
  
Date_lim_long=c(min(RelCaseLongDF$Date),max(RelCaseLongDF$Date))

p2=Buildplot_gen(
      "Cases",
      MainDF=RelCaseLongDF,
      Loc="Site",
      LineDF=RelCaseLongRollDF,
      DateLimits=Date_lim_long+shift,
      Standards=ConfigOption,
      AxisPos="bottom",
      LineColor="red",
      Colplot=F,scalesF="free_y")

annotate_figure(top=text_grob("Dorm data with ad hoc binning",size=15),ggarrange(p1,p2,nrow = 2,align="hv"))
```


question to resolve: date off by one between MMSD and HFG; is it in the emails or READMEs?


```{r madison messure same data}

LatData=LatWasteDF%>%
  filter((Site=="Madison"))
HFGData=HFGFrame%>%
  filter((Site=="Madison"))

#??lat data off shifted by one day??

ggplot()+geom_point(aes(y=N1,color=`Filter replicates`,x=Date,shape="High Frequency"),data=HFGData)+
  geom_point(aes(y=N1,x=Date-1,shape="Longitudinal"),data=LatData,size=2.5)+
  scale_y_log10()+
  scale_x_date(limits=c(N1Start,N1End))+ggtitle("HFG and Longitudinal data match")

```
