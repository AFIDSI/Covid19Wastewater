---
title: "WasteWater Analysis"
author: "Steve Goldstein and Marlin Lee"
date: "6/1/2021"
output:
  pdf_document: default
  html_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


```{r Importing, include=FALSE}
library(shiny)
library(ggpubr)
library(dplyr)
library(shinydashboard)
library(shinyjqui)
library(shinycssloaders)

#Data Files and prepwork
source("../Scripts/GenPlotMaking.R")
source("../Scripts/WasteWaterDataProccess.R")
source("../Scripts/CassesDataProccess.R")
source("../Scripts/HelperFunctions.R")


```

```{r start up, include=FALSE}
source("../Scripts/WasteShiny/PrepData.R", local = TRUE)
```


This report is meant to give an overarching view of the data analysis done and the attempts to reduce noise and find relationships in the data. We find that the data has [I am not sure how we want to summarize this]

  
  We  focus on the high frequency data from January 25 2021 to February 16 2021 as it has many features which could help reduce noise in both the case data and waste water data. The data has 3 well replicates for each of the 3 filter replicates which means for each day there is 9 replicates of the sample. This make the data vital as it minimizes any error in data collection which gives the best shot for understanding an underlying trend.




```{r paused down, fig.height = 8, fig.width = 15,include=F}
N1Start=min(HFGFrame$Date)
N1End=max(HFGFrame$Date)
CStart=min(HFGCaseDF$Date)
CEnd=max(HFGCaseDF$Date)
SiteOptions=c("Hudson","Kenosha","Platteville","Madison", "Merrill","Plymouth","River Falls","Sun Prairie","Wausau","Oshkosh")


HFGCaseDFRoll%>%
  ggplot()+aes(x=Date)+geom_point(aes(y=ConfirmedCases,x=Date-2))+
  scale_x_date(limits=c(N1Start,N1End))+
  facet_wrap(~Site,scales = "free")+ggtitle("Sparse HFG Case Data")
  
SiteOptions2=c("Kenosha","Madison", "Sun Prairie","Wausau","Oshkosh")

HFGFrame%>%
  filter(!is.na(N1),Site %in% SiteOptions2)%>%
  group_by(Site)%>%
  summarize(`N1 testing Range`=max(Date)-min(Date),NDays=length(unique(Date)))

SiteOptions2=c("Kenosha","Madison", "Sun Prairie","Wausau")


```

```{r No Clear relation,include=F}
MaskedDataRange="1-4 Cases"
RelData=HFGCaseDF%>%
  filter(Site %in% SiteOptions2)%>%
    mutate(Small3=ifelse(EpisodeCases==-999,MaskedDataRange,"Normal Values"))%>%
    mutate(PHI_masking=ifelse(CollectedCases==-999,MaskedDataRange,"Reported values"))%>%
    mutate(Small2=ifelse(ConfirmedCases==-999,MaskedDataRange,"Normal Values"))%>%
    filter(!is.na(PHI_masking))%>%
    mutate(EpisodeCases=ifelse(EpisodeCases==-999,2.5,EpisodeCases))%>%
    mutate(CollectedCases=ifelse(CollectedCases==-999,2.5,CollectedCases))%>%
    mutate(ConfirmedCases=ifelse(ConfirmedCases==-999,2.5,ConfirmedCases))
RelRollData=HFGCaseDFRoll%>%
  filter(Site %in% SiteOptions2)

RelWasteData=HFGFrame%>%
    filter(!is.na(Site))%>%
    filter(Site %in% SiteOptions2)

```


  We furthermore focus on the large location centers where number of cases stays mostly above 5. Due to PHI masking the majority of the case data of smaller location needs to be reduce. Additionally the lower population would be expected [Prove this?] to have higher day to day variance which makes it unsuited for showing a causal relationship.
    
  below shows that within the time frame of the high frequency measurements there is no clear 7 day average trend among the 4 Sites.

[I used collected cases for this section of the report. Should I switch to reported cases to get parity with other data source]


[Might want to limit the graph to just the days we have N1 data on so all date based graphics have the same ending points. Or at least a smaller buffer]

```{r No claer relation Cases, fig.height = 6, fig.width = 16}
# Cases: 
# larger pop avoids problematic small pop areas (low numbers have a lot of variance; 1-4 => -999.
# also: relatively small sample size (relative to variance in case counts):
# short duration; 
# some flowage districts have fewer observations.
# Describe plots of cases (or %positive): Unimodal: is there a trend? segmentation? can't say;
# Cases plot:



#c(N1Start,N1End)

Date_lim_HFG=c(min(RelData$Date)-2,max(RelData$Date)+2)

HFDCasesGraphic=Buildplot_gen("CollectedCases",
  MainDF=RelData,
  ColorType="PHI_masking",
  Loc="Site",
  LineDF=RelRollData,
  WeekDF=HFGDateRangeDF,
  DateLimits=Date_lim_HFG,
  Standards=ConfigOption,
  Xfreq="14 days",
  AxisPos="bottom",
  YLabel = "Cases per 100,000 people",
  LineColor="red",
  norm="Population",
  Colplot=T,
  Start=N1Start,
  End=N1End,
  nrow=2,
  Bind=F)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

#ordered factor
#arrow point to lines
#label span of hf collection
#arrow at bottom
#add text box to explain lines
YMax=max(RelData$CollectedCases/RelData$Population)
  
scopeText=geom_text(aes(label = "Range of HF collection"))

HFDCasesGraphic+ annotate("text", x = N1Start+11.5, y = YMax, label = "<-  Range of HF collection  ->")


#add arrows

```





The N1 data has an unnatural dip on January 28 that should be ignore as testing error. otherwise we see chaotic movements that do not mirror the Covid-19 case data. Furthermore the the replicates have low variation which implies the problem is not in the PCR process. There are three possible explanations for these dips. The first explanations is that the waste water is naturally highly chaotic in capturing N1 loads. The second explanation is that the variation is just the true N1 relationship in the community. Finally the sampling process of waste water might fail to capture the true concentration. This might be from collection site issues or from flow issues.



```{r No clear relation N1, fig.height = 6, fig.width = 16}
# N1:
# left (and right?): outliers called out by Dagmara; action: ignore them.
# remaining dips: what are they:
# 3 interpretations: 
# 
# (a) real dip; 
# 
# (b) just chaotic quirky;
# 
# (c) longer explanation: 9 replicates have low var; OK good experiment; good benchmark.
# now think about the stochasticity of the sampling process; you capture a liter of ww
# whose N1 concentration is a random variable.


meanOfN1=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  group_by(Site,Date)%>%
  summarise(N1=exp(mean(log(N1),na.rm=T)))%>%
  select(Date,Site,N1)%>%
  mutate(lower=N1-2*0.2199*N1)%>%
  mutate(Upper=N1+2*0.2199*N1)

N1PlotGraphic=Buildplot_gen(
  "N1",
  MainDF=RelWasteData,
  LineDF =meanOfN1,
  Loc="Site",
  YLabel = "N1 (GC/L)",
  log_scale=T,
  ColorType="Filter replicates",
  DateLimits=Date_lim_HFG,
  RMOutliers=T,
  AxisPos="bottom",
  Standards=ConfigOption,
  Xfreq="7 days",
  nrow=2)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

N1PlotGraphic

#EpisodeCases    ConfirmedCases CollectedCases
#annotate_figure(top=text_grob("No clear pattern partially due to short time frame",size=15),ggarrange(p1,p2,nrow = 2,align="hv",common.legend = T))
#yaxis needs units=
#N1 (GC/L)
```




```{r predicting varience,include=FALSE,fig.height = 15, fig.width = 20}
#Varience analysis

HFGFrame%>%
  select(Date,Site,`Filter replicates`,N1)%>%
  group_by(Site,Date)%>%
  summarize(mN1=exp(mean(log(N1))),vN1=var(N1))%>%
  ggplot()+geom_point(aes(x=mN1,y=sqrt(vN1),color=Site))+
  scale_y_log10()+scale_x_log10()+
  ylab("SD")+xlab("Daily geometric mean of N1")+
  ggtitle("Measurement error scales linearly")



Buildplot_gen(
  "N1",
  MainDF=RelWasteData,
  #LineDF =meanOfN1,
  Loc="Site",
  YLabel = "N1 (GC/L)",
  log_scale=T,
  ColorType="Filter replicates",
  DateLimits=Date_lim_HFG,
  RMOutliers=T,
  AxisPos="bottom",
  Standards=ConfigOption,
  Xfreq="14 days",
  boxingDF=meanOfN1,
  nrow=2)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))


#N1PlotGraphic+geom_rect(aes(ymin=lower,ymax=Upper,xmin=Date-.3,xmax=Date+.3),fill="red",alpha=.6,data=meanOfN1)

```

To confirm there is no way to explain the weird movements of the N1 concentration we looked to see if they could be explained by abnormal Percent BeCoV recovery or PMMoV [Use full names]. Below shows unusual PMMoV values do not explain the unusual N1 values.




```{r fig.height = 6, fig.width = 16}

# %BoCov and PMMOV
# can we use these? answer: don't see how.

PMMoVUseDF=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  mutate(`PMMoV Level`=ifelse(PMMoV<1*10^7,"Low","Medium"))%>%
  mutate(`PMMoV Level`=ifelse(PMMoV>1*10^8,"High",`PMMoV Level`))%>%
  mutate(`PMMoV Level`=factor(`PMMoV Level`,levels=c("High","Medium","Low")))

PMMoVUseDF%>%
  ggplot()+aes(x=PMMoV,y=N1,color=`PMMoV Level`)+geom_point()+scale_y_log10()+
  scale_x_log10()+facet_wrap(~Site)+ggtitle("N1 Vs PMMoV")+ Header_theme(ConfigOption)+
  xlab("PMMoV (GC/L)")+ylab("N1 (GC/L)")+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

PMMoVUseDF%>%
  ggplot()+aes(x=Date,y=N1,color=`PMMoV Level`)+ Header_theme(ConfigOption)+geom_point()+
  ylab("N1 (GC/L)")+ggtitle("PMMoV and N1 appear unrelated")+
  scale_y_log10()+facet_wrap(~Site)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

```

BCov has no clear outliers and the extreme values of BCov have no relation to the N1 data. This means that its use as a control is limited.


```{r outliers Per_Bcov, fig.height = 6, fig.width = 13}
BCoVUseDF=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  filter(N1<2e6)%>%
  mutate(`Percent BCoV Recovery`=ifelse(Pct_BCoV<.5,"Low","Medium"))%>%
  mutate(`Percent BCoV Recovery`=ifelse(Pct_BCoV>10,"High",`Percent BCoV Recovery`))%>%
  mutate(`Percent BCoV Recovery`=factor(`Percent BCoV Recovery`,levels=c("High","Medium","Low")))

BCoVUseDF%>%
  ggplot()+aes(x=Pct_BCoV,y=N1,color=`Percent BCoV Recovery`)+geom_point()+
  xlab("Percent Bcov Recovery")+
  ylab("N1 (GC/L)")+
  #scale_y_log10()+
  #scale_x_log10()+
  facet_wrap(~Site)+
  ggtitle("N1 Vs %Bcov recovery")+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))
#, scales = "free"
#scale_x_log10()+,color=marked

BCoVUseDF%>%
  ggplot()+aes(x=Date,y=N1,color=`Percent BCoV Recovery`)+geom_point()+
  ggtitle("Percent BCoV recovery and N1 appear unrelated")+
  scale_y_log10()+facet_wrap(~Site)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

```








```{r madison messure same data, fig.height = 6, fig.width = 13, include=FALSE}
#question to resolve: date off by one between MMSD and HFG; is it in the emails or READMEs?
LatData=LatWasteDF%>%
  filter((Site=="Madison"))
HFGData=HFGFrame%>%
  filter((Site=="Madison"))

#??lat data off shifted by one day??
#*change legend labels

ggplot()+geom_point(aes(y=N1,color=`Filter replicates`,x=Date,shape="High Frequency"),data=HFGData)+
  geom_point(aes(y=N1,x=Date-1,shape="Longitudinal"),data=LatData,size=2.5)+
  ylab("N1 (GC/L)")+
  scale_y_log10()+
  labs(shape="Data Set")+
  scale_x_date(limits=c(N1Start,N1End))+ggtitle("HFG and Longitudinal data match")+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

```

```{r Thresholding Dorms, fig.height = 8, fig.width = 15, include=F}
# shift=-0
# LeftDate=min(LatWasteDF$Date)
# RightDate=max(LatWasteDF$Date)
# p1=LatWasteDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date,y=N1)+geom_point(aes(color=N1>5e4))+
#   #scale_y_log10()+
#   #geom_smooth(span=.42)+
#   facet_wrap(~Site)+
#   scale_x_date(limits=c(LeftDate,RightDate))
# 
# p2=LatCaseDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Cases))+
#   geom_line(aes(y=SevCases))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p3=LatCaseDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   filter(Tests<2000)%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Tests,color="Tests"))+
#   geom_line(aes(y=SevTest,color="Tests"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p4=LatCaseDF%>%
#   filter(Per_pos<50)%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Per_pos,color="Per_pos"))+
#   geom_line(aes(y=rollingPer_pos,color="Per_pos"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# annotate_figure(top=text_grob("Dorm data with thresholding",size=15),ggarrange(plotlist = list(p1,p2),nrow = 2,align="hv",common.legend = T))

```



```{r Thresholding Gen, fig.height = 16, fig.width = 15, include=F}
# shift=-0
# LeftDate=min(LatWasteDF$Date)
# RightDate=max(LatWasteDF$Date)
# p1=LatWasteDF%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date,y=N1)+geom_point(aes(color=N1>5e4))+
#   scale_y_log10()+
#   #geom_smooth(span=.42)+
#   facet_wrap(~Site)+
#   scale_x_date(limits=c(LeftDate,RightDate))
# 
# p2=LatCaseDF%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Cases,color="Cases"))+
#   geom_line(aes(y=SevCases,color="Cases"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p3=LatCaseDF%>%
#   filter((Site=="Madison"))%>%
#   filter(Tests<2000)%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Tests,color="Tests"))+
#   geom_line(aes(y=SevTest,color="Tests"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p4=LatCaseDF%>%
#   filter(Per_pos<50)%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Per_pos,color="Per_pos"))+
#   geom_line(aes(y=rollingPer_pos,color="Per_pos"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# ggarrange(plotlist = list(p1,p2,p3,p4),nrow = 4,align="hv")

```

One solution to the noisy data is to instead look at boxes of days. Doing this shows a clear relationship in the US Dorms Data below. However when it comes to larger locations this method seems less effective.

```{r boxplots, fig.height = 8, fig.width = 15}
NovemberBreak=seq(from=mdy("12/18/2020"),to=mdy("1/25/2021"),by=1)

shift=-0
LeftDate=min(LatWasteDF$Date)
RightDate=max(LatWasteDF$Date)

p1=LatWasteDF%>%
  filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
  filter(!(Date %in% NovemberBreak))%>%
  mutate(Loc="10")%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("1/25/2021"),"4",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("12/18/2020"),"3",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("11/18/2020"),"2",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("10/18/2020"),"1",Loc))%>%
  
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("2/5/2021"),"5",Loc))%>%
  #mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("12/18/2020"),"4",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("12/18/2020"),"3",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("11/4/2020"),"2",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("10/11/2020"),"1",Loc))%>%
  ggplot()+
  geom_boxplot(aes(y=N1,x=Date,group=Loc),fill="light blue",show.legend = FALSE)+
  #geom_point(aes(y=N1,x=Date,color=Loc),fill="light blue")+
  scale_y_log10()+
  facet_wrap(~Site)+
  ylab("N1 (GC/L)")+
  scale_x_date(limits=c(LeftDate,RightDate))+ Header_theme(ConfigOption)
    

  
RelCaseLongDF=LatCaseDF%>%
   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))
RelCaseLongRollDF= LatCaseDFRoll%>%
   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))
  
Date_lim_long=c(min(RelCaseLongDF$Date),max(RelCaseLongDF$Date))

p2=Buildplot_gen(
      "Cases",
      MainDF=RelCaseLongDF,
      Loc="Site",
      LineDF=RelCaseLongRollDF,
      DateLimits=Date_lim_long+shift,
      Standards=ConfigOption,
      AxisPos="bottom",
      LineColor="red",
      Colplot=F,scalesF="free_y")+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

annotate_figure(top=text_grob("Dorm data with ad hoc binning",size=15),ggarrange(p1,p2,nrow = 2,align="hv"))
```



