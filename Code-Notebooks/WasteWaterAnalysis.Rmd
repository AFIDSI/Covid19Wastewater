---
title: "WasteWater Analysis"
author: "Steve Goldstein and Marlin Lee"
date: "6/1/2021"
output:
  pdf_document: default
  html_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


```{r Importing, include=FALSE}
library(shiny)
library(ggpubr)
library(dplyr)
library(shinydashboard)
library(shinyjqui)
library(shinycssloaders)

#Data Files and prepwork
source("../Scripts/GenPlotMaking.R")
source("../Scripts/WasteWaterDataProccess.R")
source("../Scripts/CassesDataProccess.R")
source("../Scripts/HelperFunctions.R")
LatWasteFN <- "../../UntrackedData/WW SARS-COV-2 Data V5.xlsx"
LatSpringCaseFN="../../UntrackedData/SpringSemester_CasesByDorm.tsv"
LatFallCaseFN="../../UntrackedData/FallSemester_CasesByDorm.tsv"
HFGWasteFN = "../../UntrackedData/HFG data for stats preliminary 3-18-21.xlsx"
HFGCaseFN="../../UntrackedData/HighFreq_CaseData_2021-05-07.csv"
LatMMSDFN = "../../UntrackedData/MMSD_Cases.2021-05-21.csv"

```

```{r start up, include=FALSE}
HFGFrame=HFGInfo(HFGWasteFN)%>%
  select(Date,Site=Plant,Filter,Well,N1=N1GC,N2=N2GC,PMMoV=PMMOVGC,Pct_BCoV=BCoV)%>%
  mutate(Filter=as.character(Filter),Well=as.character(Well))%>%
  rename(`Filter replicates`=Filter)


HFGCaseDF=HFGCasesPARSER(HFGCaseFN)



HFGCaseDFRoll=HFGCaseDF%>%
  mutate(EpisodeCases=ifelse(EpisodeCases==-999,2.5,EpisodeCases))%>%
  mutate(CollectedCases=ifelse(CollectedCases==-999,2.5,CollectedCases))%>%
  mutate(ConfirmedCases=ifelse(ConfirmedCases==-999,2.5,ConfirmedCases))%>%
  RollAvg(Facet="Site")%>%
  select(Date,Site,ends_with("Cases"))

HFGPop=read.csv("../../UntrackedData/HFGPop.csv.txt")%>%
  select(Site=wwtp_name,Population=pop_served)

HFGCaseDF=full_join(HFGPop,HFGCaseDF,by="Site")

HFGCaseDFRoll=full_join(HFGPop,HFGCaseDFRoll,by="Site")



HFGDateRangeDF=WeekendGen(HFGCaseDF$Date)

LatCaseDF=CovidDataPARSER(LatSpringCaseFN,LatFallCaseFN,LatMMSDFN)%>%
  filter(!is.na(Site))%>%
  select(Date,Site,Cases,Tests,Per_pos)

#return(LatCaseDF)
LatCaseDFRoll=RollPerPos(LatCaseDF,"Cases","Tests",Facet="Site")%>%
  select(Date,Site,Cases,Per_pos)

LatWasteDF=WasteWater(LatWasteFN)%>%
  mutate(Date=as.Date(Date))%>%
  filter(!is.na(Date),!is.na(N1),!is.na(Site))%>%
  filter(Date<mdy("6/5/2021"))%>%
  select(Date,Site,N1,N2,PMMoV,Pct_BCoV,AVG)


ConfigOption=list(
      myseed=1234567890,
      XAxisLabSiz=10,
      YAxisLabSiz=15,
      GenFontSiz=20,
      alphaPoint=.7,
      PointSize=2,
      alphaWeek=.2)
    
```

```{r Comp cases,include=FALSE}
HFGCaseDF2=HFGCaseDF%>%
  filter(Site=="Madison")%>%
  filter(ConfirmedCases!=-999)%>%
  filter(CollectedCases!=-999)
LatCaseDF2=LatCaseDF%>%
  filter(Site=="Madison")%>%
  mutate(Date=Date)

ggplot() + geom_point(aes(x=Date,y=Cases,color="cases"),data=LatCaseDF2) + 
  geom_point(aes(x=Date+2,y=CollectedCases,color="CollectedCases"),data=HFGCaseDF2)+
  scale_x_date(limits=c(min(HFGCaseDF2$Date),max(HFGCaseDF2$Date)))+
  facet_wrap(~Site)

inner_join(HFGCaseDF2,LatCaseDF2,by=c("Date","Site"))%>%
  ggplot()+aes(x=Cases,y=CollectedCases)+geom_point()+
  geom_abline()

a=inner_join(HFGCaseDF2,LatCaseDF2,by=c("Date","Site"))%>%
  mutate(Diff=abs(CollectedCases-Cases))%>%
  filter(Diff>75)%>%
  select(Site,Date,CollectedCases,Cases)
a$Date
```

Focus on HF Data. 

replicates and our best shot.


```{r paused down, fig.height = 8, fig.width = 15,include=F}
N1Start=min(HFGFrame$Date)
N1End=max(HFGFrame$Date)
CStart=min(HFGCaseDF$Date)
CEnd=max(HFGCaseDF$Date)
SiteOptions=c("Hudson","Kenosha","Platteville","Madison", "Merrill","Plymouth","River Falls","Sun Prairie","Wausau","Oshkosh")


HFGCaseDFRoll%>%
  ggplot()+aes(x=Date)+geom_point(aes(y=ConfirmedCases,x=Date-2))+
  scale_x_date(limits=c(N1Start,N1End))+
  facet_wrap(~Site,scales = "free")+ggtitle("Sparse HFG Case Data")
  
SiteOptions2=c("Kenosha","Madison", "Sun Prairie","Wausau","Oshkosh")

HFGFrame%>%
  filter(!is.na(N1),Site %in% SiteOptions2)%>%
  group_by(Site)%>%
  summarize(`N1 testing Range`=max(Date)-min(Date),NDays=length(unique(Date)))

SiteOptions2=c("Kenosha","Madison", "Sun Prairie","Wausau")


```

```{r No Clear relation,include=F}
MaskedDataRange="1-4 Cases"
RelData=HFGCaseDF%>%
  filter(Site %in% SiteOptions2)%>%
    mutate(Small3=ifelse(EpisodeCases==-999,MaskedDataRange,"Normal Values"))%>%
    mutate(PHI_masking=ifelse(CollectedCases==-999,MaskedDataRange,"Reported values"))%>%
    mutate(Small2=ifelse(ConfirmedCases==-999,MaskedDataRange,"Normal Values"))%>%
    filter(!is.na(PHI_masking))%>%
    mutate(EpisodeCases=ifelse(EpisodeCases==-999,2.5,EpisodeCases))%>%
    mutate(CollectedCases=ifelse(CollectedCases==-999,2.5,CollectedCases))%>%
    mutate(ConfirmedCases=ifelse(ConfirmedCases==-999,2.5,ConfirmedCases))
RelRollData=HFGCaseDFRoll%>%
  filter(Site %in% SiteOptions2)

RelWasteData=HFGFrame%>%
    filter(!is.na(Site))%>%
    filter(Site %in% SiteOptions2)

Data_mean_var = reactive({
  HFGSiteMean=filtered_data_P()%>%
    group_by(Date,Site)%>%
    summarise(N1=exp(mean(log(N1),na.rm = T)),
              N2=exp(mean(log(N2),na.rm = T)),
              PMMoV=exp(mean(log(PMMoV),na.rm = T)),
              Pct_BCoV=exp(mean(log(Pct_BCoV),na.rm = T)))
})
#Data of the means of each Filter
Filter_mean_var = reactive({
  HFGFilterMean=filtered_data_P()%>%
    group_by(Date,Site,`Filter replicates`)%>%
    summarise(N1=exp(mean(log(N1),na.rm = T)),
              N2=exp(mean(log(N2),na.rm = T)),
              PMMoV=exp(mean(log(PMMoV),na.rm = T)),
              Pct_BCoV=exp(mean(log(Pct_BCoV),na.rm = T)))
})
source("../Scripts/GenPlotMaking.R")
```




Cases: 
larger pop avoids problematic small pop areas (low numbers have a lot of variance; 1-4 => -999.
also: relatively small sample size (relative to variance in case counts):
short duration; 
some flowage districts have fewer observations.
Describe plots of cases (or %positive): Unimodal: is there a trend? segmentation? can't say;
Cases plot:



```{r No claer relation Cases, fig.height = 6, fig.width = 16}
#c(N1Start,N1End)

Date_lim_HFG=c(min(RelData$Date)-2,max(RelData$Date)+2)

HFDCasesGraphic=Buildplot_gen("CollectedCases",
  MainDF=RelData,
  ColorType="PHI_masking",
  Loc="Site",
  LineDF=RelRollData,
  WeekDF=HFGDateRangeDF,
  DateLimits=Date_lim_HFG,
  Standards=ConfigOption,
  Xfreq="14 days",
  AxisPos="bottom",
  LineColor="red",
  norm="Population",
  Colplot=T,
  Start=N1Start,
  End=N1End,
  nrow=2,
  Bind=F)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

#ordered factor
#arrow point to lines
#label span of hf collection
#arrow at bottom
#add text box to explain lines
YMax=max(RelData$CollectedCases/RelData$Population)
  
scopeText=geom_text(aes(label = "Range of HF collection"))

HFDCasesGraphic+ annotate("text", x = N1Start+11.5, y = YMax, label = "<-  Range of HF collection  ->")


#add arrows

```

```{r Case comp}

HFGMadCaseDF=HFGCaseDF%>%
  filter(Site=="Madison")%>%
  filter(ConfirmedCases!=-999)

LIMSMadCaseDF=LatCaseDF%>%
  filter(Site=="Madison")


BothCases=inner_join(HFGMadCaseDF,LIMSMadCaseDF,by = c("Date","Site"))

BothCases%>%
  ggplot()+
  aes(x=ConfirmedCases,y=Cases)+
  geom_point()+
  geom_abline(slope=1,color="red")+
  facet_wrap(~Site)+
  ylab("Census track level Case data")+
  xlab("Address level Case data")


BothCases%>%
  mutate(ratio=CollectedCases/Cases)%>%
  mutate(weird=CollectedCases>80+Cases|CollectedCases<Cases-70)%>%
  ggplot()+
  aes(x=CollectedCases,y=Cases,color=weird)+
  geom_point()+
  geom_abline(slope=1,color="red")+
  geom_abline(slope=1,intercept=80,color="red")+
  geom_abline(slope=1,intercept=-70,color="red")+
  facet_wrap(~Site)+
  ylab("Census track level Case data")+
  xlab("Address level Case data")

BothCases%>%
  mutate(weird=CollectedCases>80+Cases|CollectedCases<Cases-70)%>%
  filter(weird)%>%
  select(Site,Date,CollectedCases,Cases)

BothCases%>%
  mutate(weird=ConfirmedCases>80+Cases|ConfirmedCases<Cases-70)%>%
  filter(weird)%>%
  select(Site,Date,ConfirmedCases,Cases)
```



N1:
left (and right?): outliers called out by Dagmara; action: ignore them.
remaining dips: what are they:
3 interpretations: 

(a) real dip; 

(b) just chaotic quirky;

(c) longer explanation: 9 replicates have low var; OK good experiment; good benchwork.
now think about the stochasticity of the sampling process; you capture a liter of ww
whose N1 concentration is a random variable.





```{r No clear relation N1, fig.height = 6, fig.width = 16}
meanOfN1=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  group_by(Site,Date)%>%
  summarise(N1=exp(mean(log(N1),na.rm=T)))%>%
  select(Date,Site,N1)%>%
  mutate(lower=N1-2*0.2199*N1)%>%
  mutate(Upper=N1+2*0.2199*N1)

N1PlotGraphic=Buildplot_gen(
  "N1",
  MainDF=RelWasteData,
  LineDF =meanOfN1,
  Loc="Site",
  YLabel = "N1 (GC/L)",
  log_scale=T,
  ColorType="Filter replicates",
  DateLimits=Date_lim_HFG,
  RMOutliers=T,
  AxisPos="bottom",
  Standards=ConfigOption,
  Xfreq="14 days",
  nrow=2)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

N1PlotGraphic

#EpisodeCases    ConfirmedCases CollectedCases
#annotate_figure(top=text_grob("No clear pattern partially due to short time frame",size=15),ggarrange(p1,p2,nrow = 2,align="hv",common.legend = T))
#yaxis needs units=
#N1 (GC/L)
```




```{r predicting varience,include=FALSE,fig.height = 15, fig.width = 20}
#Varience analysis

HFGFrame%>%
  select(Date,Site,`Filter replicates`,N1)%>%
  group_by(Site,Date)%>%
  summarize(mN1=exp(mean(log(N1))),vN1=var(N1))%>%
  ggplot()+geom_point(aes(x=mN1,y=sqrt(vN1),color=Site))+
  scale_y_log10()+scale_x_log10()+
  ylab("SD")+xlab("Daily geometric mean of N1")+
  ggtitle("Measurement error scales linearly")



Buildplot_gen(
  "N1",
  MainDF=RelWasteData,
  #LineDF =meanOfN1,
  Loc="Site",
  YLabel = "N1 (GC/L)",
  log_scale=T,
  ColorType="Filter replicates",
  DateLimits=Date_lim_HFG,
  RMOutliers=T,
  AxisPos="bottom",
  Standards=ConfigOption,
  Xfreq="14 days",
  boxingDF=meanOfN1,
  nrow=2)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))


#N1PlotGraphic+geom_rect(aes(ymin=lower,ymax=Upper,xmin=Date-.3,xmax=Date+.3),fill="red",alpha=.6,data=meanOfN1)

```

%BoCov and PMMOV
can we use these? answer: don't see how.

```{r fig.height = 6, fig.width = 16}
#fix order to low medium high
#add x axis label
#PMMoV (GC/L)
PMMoVUseDF=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  mutate(`PMMoV Level`=ifelse(PMMoV<1*10^7,"Low","Medium"))%>%
  mutate(`PMMoV Level`=ifelse(PMMoV>1*10^8,"High",`PMMoV Level`))%>%
  mutate(`PMMoV Level`=factor(`PMMoV Level`,levels=c("High","Medium","Low")))

PMMoVUseDF%>%
  ggplot()+aes(x=PMMoV,y=N1,color=`PMMoV Level`)+geom_point()+scale_y_log10()+
  scale_x_log10()+facet_wrap(~Site)+ggtitle("N1 Vs PMMoV")+ Header_theme(ConfigOption)+
  xlab("PMMoV (GC/L)")+ylab("N1 (GC/L)")+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

PMMoVUseDF%>%
  ggplot()+aes(x=Date,y=N1,color=`PMMoV Level`)+ Header_theme(ConfigOption)+geom_point()+
  ylab("N1 (GC/L)")+ggtitle("PMMoV and N1 appear unrelated")+
  scale_y_log10()+facet_wrap(~Site)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

```

```{r outliers Per_Bcov, fig.height = 6, fig.width = 13}
BCoVUseDF=HFGFrame%>%
  filter(Site %in% SiteOptions2)%>%
  filter(N1<2e6)%>%
  mutate(`Percent BCoV Recovery`=ifelse(Pct_BCoV<.5,"Low","Medium"))%>%
  mutate(`Percent BCoV Recovery`=ifelse(Pct_BCoV>10,"High",`Percent BCoV Recovery`))%>%
  mutate(`Percent BCoV Recovery`=factor(`Percent BCoV Recovery`,levels=c("High","Medium","Low")))

BCoVUseDF%>%
  ggplot()+aes(x=Pct_BCoV,y=N1,color=`Percent BCoV Recovery`)+geom_point()+
  xlab("Percent Bcov Recovery")+
  ylab("N1 (GC/L)")+
  #scale_y_log10()+
  #scale_x_log10()+
  facet_wrap(~Site)+
  ggtitle("N1 Vs %Bcov recovery")+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))
#, scales = "free"
#scale_x_log10()+,color=marked

BCoVUseDF%>%
  ggplot()+aes(x=Date,y=N1,color=`Percent BCoV Recovery`)+geom_point()+
  ggtitle("Percent BCoV recovery and N1 appear unrelated")+
  scale_y_log10()+facet_wrap(~Site)+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

```





question to resolve: date off by one between MMSD and HFG; is it in the emails or READMEs?


```{r madison messure same data, fig.height = 6, fig.width = 13}

LatData=LatWasteDF%>%
  filter((Site=="Madison"))
HFGData=HFGFrame%>%
  filter((Site=="Madison"))

#??lat data off shifted by one day??
#*change legend labels

ggplot()+geom_point(aes(y=N1,color=`Filter replicates`,x=Date,shape="High Frequency"),data=HFGData)+
  geom_point(aes(y=N1,x=Date-1,shape="Longitudinal"),data=LatData,size=2.5)+
  ylab("N1 (GC/L)")+
  scale_y_log10()+
  labs(shape="Data Set")+
  scale_x_date(limits=c(N1Start,N1End))+ggtitle("HFG and Longitudinal data match")+ Header_theme(ConfigOption)+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

```

```{r Thresholding Dorms, fig.height = 8, fig.width = 15, include=F}
# shift=-0
# LeftDate=min(LatWasteDF$Date)
# RightDate=max(LatWasteDF$Date)
# p1=LatWasteDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date,y=N1)+geom_point(aes(color=N1>5e4))+
#   #scale_y_log10()+
#   #geom_smooth(span=.42)+
#   facet_wrap(~Site)+
#   scale_x_date(limits=c(LeftDate,RightDate))
# 
# p2=LatCaseDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Cases))+
#   geom_line(aes(y=SevCases))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p3=LatCaseDF%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   filter(Tests<2000)%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Tests,color="Tests"))+
#   geom_line(aes(y=SevTest,color="Tests"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p4=LatCaseDF%>%
#   filter(Per_pos<50)%>%
#   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Per_pos,color="Per_pos"))+
#   geom_line(aes(y=rollingPer_pos,color="Per_pos"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# annotate_figure(top=text_grob("Dorm data with thresholding",size=15),ggarrange(plotlist = list(p1,p2),nrow = 2,align="hv",common.legend = T))

```



```{r Thresholding Gen, fig.height = 16, fig.width = 15, include=F}
# shift=-0
# LeftDate=min(LatWasteDF$Date)
# RightDate=max(LatWasteDF$Date)
# p1=LatWasteDF%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date,y=N1)+geom_point(aes(color=N1>5e4))+
#   scale_y_log10()+
#   #geom_smooth(span=.42)+
#   facet_wrap(~Site)+
#   scale_x_date(limits=c(LeftDate,RightDate))
# 
# p2=LatCaseDF%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Cases,color="Cases"))+
#   geom_line(aes(y=SevCases,color="Cases"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p3=LatCaseDF%>%
#   filter((Site=="Madison"))%>%
#   filter(Tests<2000)%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Tests,color="Tests"))+
#   geom_line(aes(y=SevTest,color="Tests"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# p4=LatCaseDF%>%
#   filter(Per_pos<50)%>%
#   filter((Site=="Madison"))%>%
#   ggplot()+aes(x=Date)+
#   geom_point(aes(y=Per_pos,color="Per_pos"))+
#   geom_line(aes(y=rollingPer_pos,color="Per_pos"))+
#   facet_wrap(~Site,scales="free_y")+
#   scale_x_date(limits=c(LeftDate+shift,RightDate+shift))
# 
# ggarrange(plotlist = list(p1,p2,p3,p4),nrow = 4,align="hv")

```

UW thresholding / box plots

```{r boxplots, fig.height = 8, fig.width = 15}
NovemberBreak=seq(from=mdy("12/18/2020"),to=mdy("1/25/2021"),by=1)

shift=-0
LeftDate=min(LatWasteDF$Date)
RightDate=max(LatWasteDF$Date)

p1=LatWasteDF%>%
  filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))%>%
  filter(!(Date %in% NovemberBreak))%>%
  mutate(Loc="10")%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("1/25/2021"),"4",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("12/18/2020"),"3",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("11/18/2020"),"2",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-LakeShore"&Date<mdy("10/18/2020"),"1",Loc))%>%
  
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("2/5/2021"),"5",Loc))%>%
  #mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("12/18/2020"),"4",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("12/18/2020"),"3",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("11/4/2020"),"2",Loc))%>%
  mutate(Loc=ifelse(Site=="UW-Sellery"&Date<mdy("10/11/2020"),"1",Loc))%>%
  ggplot()+
  geom_boxplot(aes(y=N1,x=Date,group=Loc),fill="light blue",show.legend = FALSE)+
  #geom_point(aes(y=N1,x=Date,color=Loc),fill="light blue")+
  scale_y_log10()+
  facet_wrap(~Site)+
  ylab("N1 (GC/L)")+
  scale_x_date(limits=c(LeftDate,RightDate))+ Header_theme(ConfigOption)
    

  
RelCaseLongDF=LatCaseDF%>%
   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))
RelCaseLongRollDF= LatCaseDFRoll%>%
   filter((Site=="UW-Sellery")|(Site=="UW-LakeShore"))
  
Date_lim_long=c(min(RelCaseLongDF$Date),max(RelCaseLongDF$Date))

p2=Buildplot_gen(
      "Cases",
      MainDF=RelCaseLongDF,
      Loc="Site",
      LineDF=RelCaseLongRollDF,
      DateLimits=Date_lim_long+shift,
      Standards=ConfigOption,
      AxisPos="bottom",
      LineColor="red",
      Colplot=F,scalesF="free_y")+
      theme(axis.text.x = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
            axis.title.x = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
            plot.margin = unit(c(.5,0,0,0), "cm"))

annotate_figure(top=text_grob("Dorm data with ad hoc binning",size=15),ggarrange(p1,p2,nrow = 2,align="hv"))
```



