---
title: "CovWasteDashboard"
author: "Marlin"
date: "5/7/2021"
output: html_document
---

```{r}
library(shiny)
library(ggpubr)
library(dplyr)
library(shinydashboard)
```

#tab1 Data
```{r}
source("../Scripts/DataProccess.R")
Waterfilename <- "../../UntrackedData/WW SARS-COV-2 Data V5.xlsx"
CovidFileName = "../../UntrackedData/MMSD_Cases.csv"

TCovDF=CovidData(CovidFileName)

Spring="../../UntrackedData/SpringSemester_CasesByDorm.tsv"
Fall="../../UntrackedData/Oct2020toEndFall_CasesByDorm.tsv"
DCovDF=CovidDataDorms(Spring,Fall)

#Reads Transformed HFG Data
MWasteWater=WasteWater(Waterfilename)%>%
  mutate(Date=as.Date(Date))%>%
  filter(!is.na(Date),!is.na(N1))%>%
  filter(Date<mdy("6/5/2021"))
```


#tab2 data
```{r}
#Reads Transformed HFG Data
HFGData=read.csv("../../UntrackedData/R_connect_HFG_TEMP/HFG_mean_data.csv", row.names = 1)%>%
    mutate(Filter=as.character(Filter),Well=as.character(Well),Date=as.Date(Date))%>%
    na.omit()

#Generating the weekends starts and end dates
#TO DO:Capture the weekend if the data intersects with it
DateRange=data.frame(Date=seq(min(HFGData$Date), max(HFGData$Date), "days"))%>%
    mutate(Days=weekdays(Date))%>%
    filter(Days %in% c("Sunday","Monday"))
if (DateRange$Days[1]=="Monday"){
    DateRange=DateRange[-1,]}
if (tail(DateRange$Days, n=1)=="Sunday"){
    DateRange=head(DateRange, -1)}
MRan=filter(DateRange,Days=="Sunday")%>%
    rename(Left=Date)
SRan=filter(DateRange,Days=="Monday")%>%
    rename(Right=Date)
DateRangeD=cbind(MRan,SRan)%>%
    select(Left,Right)
#


#minnor quality of life changes
HFGDFrame=HFGData%>%
    rename(`Filter replicates`=Filter)

#Creates consistant jittering for data
myseed=1234567890

```

```{r}
#Parts Of Tab 2 defined outside for ease of use
TopDisc=div("Pink sections are weekends")
BotDisc=div("Data source: HFG data for stats preliminary 3-18-21.xlsx from 3/18/2021 jocelyn.hemming@slh.wisc.edu email.")
BotDisc2=div("Questions? Contact Marlin Lee mrlee6@wisc.edu or Steve Goldstein sgoldstein@wisc.edu")
#Creates buttons for Plant location,Line, and scale
Tab2=tabItem(tabName = "dashboard",
            # Boxes need to be put in a row (or column)
    fluidRow(
    box(
        title = "Controls",
        selectInput(inputId = "Plant", label = ("Plant"),
                    choices = c("All",unique(HFGDFrame$Plant)),
                    multiple=F,
                    selected="Madison"),
        selectInput(inputId = "Vars2", label = ("Varibles"),
                    choices = c("N1GC","N2GC","PMMOVGC"),
                    multiple=T,
                    selected="N1GC"),
        checkboxInput(inputId = "Line2", label = ("Daily mean of 9 replicates"),
                      value=F),
        checkboxInput(inputId = "Means", label = ("Mean of qPCR replicates"),
                      value=F),
        selectInput(inputId = "scale", label = ("y scales"),
                    choices = c("log y scale","linear scale"),
                    selected="log y scale"),
        selectInput(inputId = "Outlier", label = ("Outlier"),
                    choices = c("Remove Outliers"),
                    multiple=T,
                    selected="Remove Outliers")
    ),
    box(TopDisc,br(),div(plotOutput("plot2",inline=TRUE),style="overflow-x: scroll"), br(),BotDisc,BotDisc2)
))
```

```{r}
maxShifL=-10
maxShift=10

#Parts Of Tab 1 defined outside for ease of use
TopDisc=div("")
BotDisc=div("Data source: DHS ------")
BotDisc2=div("Questions? Contact Marlin Lee mrlee6@wisc.edu or Steve Goldstein sgoldstein@wisc.edu")
#Creates buttons for Plant location,Line, and scale
Tab1=tabItem(tabName = "dashboardWIP",
            # Boxes need to be put in a row (or column)
    fluidRow(
    box(
        title = "Controls",
        selectInput(inputId = "Site", label = ("Site"),
                    choices = unique(DCovDF$Site),
                    multiple=T,
                    selected=c("UW-Sellery" ,"UW-LakeShore")),
      selectInput(inputId = "Vars", label = ("Varibles"),
                    choices = c("N1","N2","PMMoV","Cases"),
                    multiple=T,
                    selected=c("N1","Cases")),
      checkboxInput(inputId="Line",label=("Smoothed Line of Data"),value=T),
      selectInput(inputId = "scale", label = ("y scales"),
                    choices = c("log y scale","linear scale"),
                    selected="log y scale"),
      sliderInput("Offset", "Offset",min = maxShifL, max = maxShift,step=1,value=0)
      #sliderInput("Smoothed", "Data Smoothed",min = 0, max = 5,step=1,value=0)

    ),
    box(TopDisc,br(),div(plotOutput("plot1",inline=TRUE),style="overflow-x: scroll"), br(),BotDisc,BotDisc2)
))

```

```{r}
#Creates UI for dashboard
ui <- dashboardPage(
    #top left descriptor
    dashboardHeader(title = "HFG Interactive graphic"),
    #left hand side tab selector
    dashboardSidebar(sidebarMenu(
        menuItem("DashboardWIP", tabName = "dashboardWIP", icon = icon("dashboard")),
        menuItem("Dashboard", tabName = "dashboard", icon = icon("dashboard"))
    )),
    #Contents of different tabs defined above
    dashboardBody(
        tabItems(
            Tab1,
            Tab2
            ))
)
```

```{r}
#create graphic                                       
server <- function(input, output) {
    #Required for tab 1
    filtered_data_PWaste<- reactive({
          return(filter(MWasteWater, MWasteWater$Site %in% input$Site))
    })
    filtered_data_PCov<- reactive({
          return(filter(DCovDF, Site %in% input$Site))
    })
    
    minC=reactive({
      return(min(filtered_data_PWaste()$Date)+input$Offset)
      })
    
    maxC=reactive({
      return(max(filtered_data_PWaste()$Date)+input$Offset)
      })
    
    buildplot1 = function(vari){
      if(vari=="Cases"){
        DormPlot=ggplot(data=filtered_data_PCov(),aes(y=Cases,x=Date))+
          geom_jitter(alpha=.7,height=0,width=.1,size=2)+
          facet_wrap(~Site, nrow = 1)+coord_cartesian(xlim=c(minC(), maxC()))+
          theme(text = element_text(size=20),strip.text.x = element_blank(),axis.text.x = element_blank(),axis.text.y = element_text(size = 15, colour = "black"))+ rremove("xlab")
        return(DormPlot)
      }
      #set.seed(myseed)
      #!!sym() reads string as a variable of the data frame
      DormPlot=ggplot(data=filtered_data_PWaste(),aes(y=!!sym(vari),x=Date))+geom_jitter(alpha=.7,height=0,width=.1,size=2)+ylab(vari)
      #adds mean line
      DormPlot = DormPlot+facet_wrap(~Site, nrow = 1)+theme(text = element_text(size=20),strip.text.x = element_blank(),axis.text.x = element_blank(),axis.text.y = element_text(size = 15, colour = "black"))+ rremove("xlab")
      if(input$scale=="log y scale"){
        DormPlot=DormPlot+scale_y_log10()
      }
      if(input$Line==TRUE){
        DormPlot=DormPlot+geom_smooth()
      }
        return(DormPlot)
    }
    #Creates list of ggplots for ggarange
    Make_Plots1 = reactive({
        plots=lapply(input$Vars,buildplot1)
        return(plots)
    })
    #plots N1GC
    output$plot1<-renderPlot(
        width = function() 245+400*length(input$Site),
        height = function() 60+300*length(input$Vars),
        {

            plots=Make_Plots1()
            #Add plant labels
            plots[[1]]=plots[[1]] + theme(strip.text.x = element_text(size = 20, colour = "black"))
            #add x axis labels
            plots[[length(plots)]]=plots[[length(plots)]] + theme(axis.title.x = element_text(size = 20, colour = "black"),axis.text.x = element_text(size = 15, colour = "black"))
            return(ggarrange(plotlist=plots,ncol =1))
        })
    #-------------------------
    #required for tab2
    #Filters data for right plants and variables
    filtered_data_P<- reactive({
        if(input$Plant!="All")
            return(filter(HFGDFrame, HFGDFrame$Plant %in% input$Plant))
        return(HFGDFrame)
    })
    #creates data with original values
    filtered_data_N<- reactive({
        filtered_data_P()%>%
            filter(Type=="Normal")
    })
    
    #Data of the means of each day
    Data_mean_var = reactive({
        filtered_data_P()%>%
            filter(Type=="Plant Mean")
    })
    #Data of the means of each Filter
    Filter_mean_var = reactive({
        filtered_data_P()%>%
            filter(Type=="Filter Mean")
    })
    #Putting data in reactive shell for possible additions
    DF_Week = reactive({
        return(DateRangeD)
    })
    #Function Creates ggplots that gets merged into final graphic
    buildplot2 = function(vari){
        set.seed(myseed)
        #!!sym() reads string as a variable of the dataframe
        HFGDPlot=ggplot()+
            geom_jitter(data=filtered_data_N(),aes(y=!!sym(vari),x=Date,color=`Filter replicates`),alpha=.7,height=0,width=.1,size=3)+ylab(vari)
        #adds mean line
        if(input$Line2==T){
            HFGDPlot=HFGDPlot+geom_line(data=Data_mean_var(),aes(y=!!sym(vari),x=Date),size=1)
        }
        #add filter means
        if(input$Means==T){
            set.seed(myseed)
            HFGDPlot=HFGDPlot+geom_jitter(data=Filter_mean_var(),aes(y=!!sym(vari),x=Date,fill=`Filter replicates`), shape=23, size=5, height=0, width=.1)
        }
        #hides outliers
        #Does this by setting y upper bounds for later cropping
        if ("Remove Outliers" %in% input$Outlier){
            if(input$scale=="log y scale"){
                quint=quantile(pull(HFGDFrame,vari),.995)[[1]]}
            else{
                quint=quantile(pull(HFGDFrame,vari),.975)[[1]]}
        }
        else{
            quint=max(pull(HFGDFrame,vari))}
        minVal=min(HFGDFrame[vari],na.rm = T)
        #sets appropriate scale
        #also applies weekend indicators because logscale can not have -inf(or any negitive number) as the ymin
        if(input$scale=="log y scale"){
            HFGDPlot = HFGDPlot + scale_y_log10()+coord_cartesian(ylim=c(minVal, quint))
            HFGDPlot=HFGDPlot+geom_rect(data=DF_Week(), aes(xmin=Left, xmax=Right, ymin=0, ymax=Inf), fill='pink', alpha=.2)}
        else{
            HFGDPlot=HFGDPlot+coord_cartesian(ylim=c(minVal, quint))
            HFGDPlot=HFGDPlot+geom_rect(data=DF_Week(), aes(xmin=Left, xmax=Right, ymin=-Inf, ymax=Inf), fill='pink', alpha=.2)}
        #faucet the data by Plant and remove hud elliments that dont need to be in all three varible strips
        HFGDPlot = HFGDPlot+facet_wrap(~Plant, nrow = 1)+theme(text = element_text(size=20),strip.text.x = element_blank(),axis.text.x = element_blank(),axis.text.y = element_text(size = 15, colour = "black"))+ rremove("xlab")
        return(HFGDPlot)
    }
    #Creates list of ggplots for ggarange
    Make_Plots2 = reactive({
        plots=lapply(input$Vars2,buildplot2)
        return(plots)
    })
    #plots N1GC
    output$plot2<-renderPlot(
        width = function() 245+400*ifelse(input$Plant=="All",10,1),
        height = function() 60+300*length(input$Vars),
        {
            plots=Make_Plots2()
            #Add plant labels
            plots[[1]]=plots[[1]] + theme(strip.text.x = element_text(size = 20, colour = "black"))
            #add x axis labels
            plots[[length(plots)]]=plots[[length(plots)]] + theme(axis.title.x = element_text(size = 20, colour = "black"),axis.text.x = element_text(size = 15, colour = "black"))
            return(annotate_figure( left = text_grob("(GC/L)", rot = 90,size=20),ggarrange(plotlist=plots,ncol =1,common.legend = TRUE, legend = "right")))
        })
    
    
    
}
shinyApp(ui = ui, server = server)
```