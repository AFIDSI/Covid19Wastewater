---
title: "SheddingLagDistribution"
author: "Marlin"
date: "7/22/2021"
output: html_document
---

```{r set up markdown settings, echo=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

```

```{r Start enviroment, message=FALSE, warning=FALSE}
library(ggpubr)
library(dplyr)
library(forecast)
library(lmtest)
library(lubridate)
library(limma)

#Data Files and prep work
source("../../Scripts/GenPlotMaking.R")
source("../../Scripts/WasteWaterDataProccess.R")
source("../../Scripts/CassesDataProccess.R")
source("../../Scripts/HelperFunctions.R")
```


```{r DF Set Up}
PathStarter="Z:/"

LatMMSDFN  <-  paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/MMSD_Cases.csv")
LIMSFN <- paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/WATERMICRO_WW_COVID-2021-06-30 17 40.xlsx")

HFGCasesFN  <-  paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/HighFreq_CaseData_2021-05-07.csv")


LatCaseDF <- CovidDataPARSER(MMSDFN = LatMMSDFN)%>%
  filter(!is.na(Site))%>%
  select(Date,Site,Cases,Tests,Per_pos)

HFGCaseDF <- HFGCasesPARSER(FN = HFGCasesFN)%>%
  filter(!is.na(Site))%>%
  mutate(Tests=NA,Per_pos=NA)%>%
  select(Date,Site,Cases=ReportedCases,Tests,Per_pos)%>%
  mutate(Cases = ifelse(Cases==-999,2.5,Cases))%>%
  filter(Site!="Madison")

FullCase <- rbind(HFGCaseDF,LatCaseDF)

LIMSFullDF <- LIMSDataPARSER(LIMSFN)%>%
  select(Date,Site, BCoV, N1,N1Error,N2, N2Error,PMMoV,Pop,FlowRate)

CaseSum=FullCase%>%
  filter(!is.na(Cases))%>%
  group_by(Site)%>%
  summarise(NCase=n())

N1Sum=LIMSFullDF%>%
  filter(!is.na(N1))%>%
  group_by(Site)%>%
  summarise(NN1=n())

DataComp <- inner_join(CaseSum,N1Sum,by=c("Site"))%>%
  mutate(Dif=NCase-NN1,min=ifelse(NCase<NN1,NCase,NN1))
LowCaseDataPoints <- DataComp%>%
  filter(Dif<0)
```
```{r CaseSmoothing}
#return( RollPerPos(CaseDF,"Cases","Tests",Facet="Site"))
library(limma)

DFSmoothingFNC <- function(CaseDF){
  #5.028338
  scale =5.028338
  #2.332779
  shape =2.332779
  FullDayDF <- data.frame(Date=seq(min(CaseDF$Date),max(CaseDF$Date),1))
  FullDateDF <- full_join(FullDayDF,CaseDF, by = c("Date"))%>%
    fill(Cases, .direction = "down")%>%
    group_by(Site)%>%
    mutate(Cases2 = c(rep(NA,20),
                    rollapply(Cases,width=21,FUN=weighted.mean,
                          w=dgamma(1:21,scale =scale,shape =shape),
                          na.rm = TRUE)))
}

DFLoessFNC <- function(LimsDF){
    FullDayDF <- data.frame(Date=seq(min(LimsDF$Date),max(LimsDF$Date),1))
    ReadyDF <- full_join(FullDayDF,LimsDF, by = c("Date"))%>%
      fill(N1, .direction = "down")
    
    loessFit(y=log(ReadyDF$N1),
             x=ReadyDF$Date,
             span=.125,
             min.weight=0,
             max.weight=1e5,
             iterations=20)$fitted
}

  #5.028338
scale =5.028338
  #2.332779
shape =2.332779
  
plot(dgamma(1:21,scale =scale,shape =shape), 
            main="Gamma Distribution with mean = 11.73 days and SD = 7.68",
            ylab = "Weight",
            xlab = "Lag")

```


```{R TSPliting}

#library(smooth)
#sma(MergedDF[,8], h=7)

# fit = Arima(CasesTSVec, xreg=loessPred, order=c(2,1,0))
# 
# cbind("Regression Errors" = residuals(fit, type="regression"),
#       "ARIMA errors" = residuals(fit, type="innovation")) %>%
#   autoplot(facets=TRUE)
# checkresiduals(fit)
#
 

#alt y axis
#x axis labled as date
#control color so they are not so light
#2)Show original data as bar graph?
#Make it clear its Madison/Title that explains
#few people have done SLD
```

```{r Formal Work, include=FALSE}
# IndependentVec <- diff(loessPred)
# DependentVec <- diff(CasesTSVec)
# 
# ccfvalues2  <-  ccf(IndependentVec,DependentVec,type = c("correlation"),na.action = na.pass)
# ccfvalues2  <-  ccf(loessPred,CasesTSVec,type = c("correlation"),na.action = na.pass)
# 
# alldata1 <- ts.union(Pred = diff(CasesTSVec),N1Norm = diff(loessPred),
#                          N1TSVec,
#                          N1A=stats::lag(diff(loessPred),1),
#                          N1B=stats::lag(diff(loessPred),10),
#                          N1C=stats::lag(diff(loessPred)))
# 
# 
# tryit1a  <- lm(Pred~N1B, data = alldata1)
# 
# summary(tryit1a)
# #plot(tryit1a)
# acf(residuals(tryit1a))
```

```{r}
#Do for non interceptor data
 
#Transformation to stabilize scale
 
 
#1)Make overlay plot function
#a)normal comp
#b)first difference
#c)P8 version
#compare smooth vs Smooth  ccf
#show all smooth Unsmooth combos
#look for best gamma
 
 
#CCF
#broke it into 2 parts
#CCF of SLD vs raw N1
 
#ccf(CasesTSVec,)
 
#some pipeline to optimize
#What did the original paper do? are we doing the same thing
#case reported at day A
#What we want: when person A became infected
#What we expect: SLD leads Cases
#infected a week and a half ago - some people are still shedding
#if looking at cases you have 3 gammas 
#Cases ~ 2 gamma ~ infected ~ 1 gamma ~ still shedding 
 
#1) Focus on 2 or 3 plots give very clear heuristic picture. in form that does not need words
 
#2)CCF that gives metric behind heuristic
 
#3)
 #FullCase
```
 
 
```{r Ploting Fnc} 
IsFull <- function(DF){
  return(length(DF$Date)==max(DF$Date)-min(DF$Date)+1)
}

TSPloting <- function(PlotingTS,FullPlot=TRUE){
  par(mar = c(5, 4, 4, 4) + 0.3)           

  if(FullPlot){
    plot.ts(rollmean(exp(PlotingTS[[4]]), 7,align="right",fill = NA),
            col = "light blue", main="SLD compared to Loess smoothing of N1",
            ylab = "N1 (GC/L)",log = 'y')
    
    par(new = TRUE)  
    plot.ts(rollmean(PlotingTS[[3]], 7,align="right",fill = NA),
            col = "pink",        
       axes = FALSE, xlab = "", ylab = "")
    
    par(new = TRUE)  
    plot.ts(exp(PlotingTS[[2]]),
            col = "blue",        
       axes = FALSE, 
       xlab = "", 
       ylab = "",
       log = 'y')
  }else{
    plot.ts(PlotingTS[[2]], 
          col = "blue", 
          ylab = "N1 (GC/L)", 
          main="First Diffrence of SLD and Loess smoothing of N1")
  }

  par(new = TRUE)                           
  plot.ts(PlotingTS[[1]], col = "red",        
     axes = FALSE, xlab = "", ylab = "")

  axis(side = 4, at = pretty(range(PlotingTS[[1]])))   
  mtext("Cases", side = 4, line = 3)
  if(FullPlot){
    legendNames <- c("SLD Cases","7 MA Cases","Loess Smoothing","7 MA N1")
    legendColors <- c("red","pink","blue", "light blue")
  }else{
    legendNames<- c("SLD Cases","Loess Smoothing")
    legendColors<- c("red","blue")
  }
  legend("topright", legend=legendNames, col=legendColors, lty=1, cex=.75)
}


SLDGraphics <- function(SiteS){
  FilteredLIMSDF <- filter(LIMSFullDF,Site==SiteS)
  
  FullDayDF <- data.frame(Date=seq(min(FilteredLIMSDF$Date),
                                   max(FilteredLIMSDF$Date),1))
  
  ReadyDF <- full_join(FullDayDF,FilteredLIMSDF, by = c("Date"))%>%
    fill(N1, .direction = "down")%>%
    mutate(Site=SiteS)
  
  SmoothCasePlotDF <- DFSmoothingFNC(filter(FullCase,Site==SiteS))%>%
    mutate(Site=SiteS)#%>%
    #filter(!is.na(Cases2))

  MergedDF <- inner_join(SmoothCasePlotDF,ReadyDF, by=c("Date","Site"))
  #return(MergedDF)
  MergedDF$LoessN1 <- DFLoessFNC(MergedDF)
  
  #return(MergedDF)
  
  SLDCaseVec <- ts(MergedDF)[,6]
  CaseVec <- ts(MergedDF)[,3]
  loessN1Vec <- ts(MergedDF)[,15]
  logN1Vec <- log(ts(MergedDF)[,8])
  #return(loessN1Vec)
  TSPloting(list(SLDCaseVec,loessN1Vec,CaseVec,logN1Vec))
  TSPloting(list(diff(SLDCaseVec),diff(loessN1Vec)),
            FullPlot=FALSE)
  ccf(loessN1Vec,SLDCaseVec)
}
SLDGraphics("Madison")
```


