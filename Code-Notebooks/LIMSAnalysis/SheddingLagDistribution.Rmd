---
title: "SheddingLagDistribution"
author: "Marlin"
date: "7/22/2021"
output: html_document
---

```{r set up markdown settings}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

ConfigOption <- list(
  myseed=1234567890,
  XAxisLabSiz=10,
  YAxisLabSiz=15,
  GenFontSiz=20,
  alphaPoint=.7,
  PointSize=2,
  alphaWeek=.2)
```

```{r Start enviroment, message=FALSE, warning=FALSE}
library(ggpubr)
library(dplyr)
library(forecast)
library(lmtest)
library(lubridate)
library(limma)

#Data Files and prep work
source("../../Scripts/GenPlotMaking.R")
source("../../Scripts/WasteWaterDataProccess.R")
source("../../Scripts/CassesDataProccess.R")
source("../../Scripts/HelperFunctions.R")
```


```{r DF Set Up}
PathStarter="Z:/"

LatMMSDFN  <-  paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/MMSD_Cases.csv")
LIMSFN <- paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/WATERMICRO_WW_COVID-2021-06-30 17 40.xlsx")
#Z:\COVID-19_WastewaterAnalysis\data\raw

LatCaseDF <- CovidDataPARSER(MMSDFN = LatMMSDFN)%>%
  filter(!is.na(Site))%>%
  select(Date,Site,Cases,Tests,Per_pos)

LatCaseMadDF <- LatCaseDF%>%
  filter(Site == "Madison")


LIMSFullDF <- LIMSDataPARSER(LIMSFN)%>%
  select(Date,Site, BCoV, N1,N1Error,N2, N2Error,PMMoV,Pop,FlowRate)

LIMSMadDF <- LIMSFullDF%>%
  filter(Site == "Madison")
```
```{r CaseSmoothing}
#return( RollPerPos(CaseDF,"Cases","Tests",Facet="Site"))

DFSmoothingFN <- function(CaseDF){
  #5.028338
scale =5.028338
#2.332779
shape =2.332779
  CaseDF%>%
    group_by(Site)%>%
    mutate(Cases2 = c(rep(NA,29),
                    rollapply(Cases,width=30,FUN=weighted.mean,
                          w=dgamma(1:30,scale =scale,shape =shape),
                          na.rm = TRUE)))
}

SmoothCasePlotDF <- DFSmoothingFN(LatCaseMadDF)



#5.028338
scale =5.028338
#2.332779
shape =2.332779

plot(dgamma(1:30,scale =scale,shape =shape))

```


```{r Ploting}
CasePlot <- ggplot()+
  geom_rect(aes(xmin=Date-.5,xmax=Date+.5,ymin=0,ymax=Cases),color="dark gray",fill="gray", data=LatCaseMadDF)+
  geom_line(aes(x=Date,y=Cases2),data=SmoothCasePlotDF,color="red")+
  coord_cartesian(xlim = c(min(LIMSMadDF$Date),max(LIMSMadDF$Date)))+
  xlab("")+
  theme(axis.title.y = element_text(size=12))

# N1Plot <- LIMSMadDF%>%
#     ggplot()+
#     aes(x=Date,y=N1)+
#     geom_point()+
#     geom_smooth(se=FALSE,span=.1)+
#   scale_y_log10()


N1Plot <-LoessSmoothPlot(SiteS="Madison",Span=.1,min=0,max=120,weights=c("Constant","Constant"),
                          Title = F,FullLim=F,SiteLab=F,Data = LIMSMadDF) +
  coord_cartesian(xlim = c(min(LIMSMadDF$Date),max(LIMSMadDF$Date)))+
  xlab("")+
  theme(legend.position = "none",
        axis.title.y = element_text(size=12))
  
ggarrange(CasePlot,N1Plot,nrow=2)
```

