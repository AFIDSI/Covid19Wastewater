---
title: "SheddingLagDistribution"
author: "Marlin"
date: "7/22/2021"
output: html_document
---

```{r set up markdown settings}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

ConfigOption <- list(
  myseed=1234567890,
  XAxisLabSiz=10,
  YAxisLabSiz=15,
  GenFontSiz=20,
  alphaPoint=.7,
  PointSize=2,
  alphaWeek=.2)
```

```{r Start enviroment, message=FALSE, warning=FALSE}
library(ggpubr)
library(dplyr)
library(forecast)
library(lmtest)
library(lubridate)
library(limma)

#Data Files and prep work
source("../../Scripts/GenPlotMaking.R")
source("../../Scripts/WasteWaterDataProccess.R")
source("../../Scripts/CassesDataProccess.R")
source("../../Scripts/HelperFunctions.R")
```


```{r DF Set Up}
PathStarter="Z:/"

LatMMSDFN  <-  paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/MMSD_Cases.csv")
LIMSFN <- paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/WATERMICRO_WW_COVID-2021-06-30 17 40.xlsx")
#Z:\COVID-19_WastewaterAnalysis\data\raw

LatCaseDF <- CovidDataPARSER(MMSDFN = LatMMSDFN)%>%
  filter(!is.na(Site))%>%
  select(Date,Site,Cases,Tests,Per_pos)

LatCaseMadDF <- LatCaseDF%>%
  filter(Site == "Madison")


LIMSFullDF <- LIMSDataPARSER(LIMSFN)%>%
  select(Date,Site, BCoV, N1,N1Error,N2, N2Error,PMMoV,Pop,FlowRate)

LIMSMadDF <- LIMSFullDF%>%
  filter(Site == "Madison")
```
```{r CaseSmoothing}
DFSmoothingFN <- function(CaseDF){
  return( RollPerPos(CaseDF,"Cases","Tests",Facet="Site"))
}

SmoothCasePlotDF <- DFSmoothingFN(LatCaseMadDF)
```


```{r Ploting}
CasePlot <- ggplot()+
  geom_rect(aes(xmin=Date-.5,xmax=Date+.5,ymin=0,ymax=Cases),color="dark gray",fill="gray", data=LatCaseMadDF)+
  geom_line(aes(x=Date,y=Cases),data=SmoothCasePlotDF,color="red")+
  coord_cartesian(xlim = c(min(LIMSMadDF$Date),max(LIMSMadDF$Date)))+
  xlab("")+
  theme(axis.title.y = element_text(size=12))

# N1Plot <- LIMSMadDF%>%
#     ggplot()+
#     aes(x=Date,y=N1)+
#     geom_point()+
#     geom_smooth(se=FALSE,span=.1)+
#   scale_y_log10()


N1Plot <-LoessSmoothPlot(SiteS="Madison",Span=.1,min=0,max=120,weights=c("Constant","Constant"),
                          Title = F,FullLim=F,SiteLab=F,Data = LIMSMadDF) +
  coord_cartesian(xlim = c(min(LIMSMadDF$Date),max(LIMSMadDF$Date)))+
  xlab("")+
  theme(legend.position = "none",
        axis.title.y = element_text(size=12))
  
ggarrange(CasePlot,N1Plot,nrow=2)
```


```{r run first}
LoessGenerater <- function(Data,weights,Span,min,max){
  if(weights=="Constant"){
    WeightList=rep(1,dim(Data)[1])
  } else if(weights=="N/NSE"){
    WeightList=Data$Indy/Data$Dep
  }
  
  
  loessModel=loessFit(y=Data$Indy,
                         x=Data$Date,
                         weights=WeightList,
                         span=Span,
                         min.weight=min,
                         max.weight=max,
                         iterations=10)
  return(loessModel$fitted)
}



LoessSmoothPlot <- function(SiteS="Madison",
                            Data=LIMSFullDF,
                            Independent="N1",Dependent="N1Error",
                            weights=c("Constant","N/NSE"),
                            Span=.3,min=1e-5,max=1e5,
                            BoxWidth=.5,
                            HasNo=F, Title=T,FullLim=F,SiteLab=T,NoLabel=F){

  LimitLIMSDF=Data%>%
      filter(Site==SiteS)%>%
      mutate(Indy=!!sym(Independent),
             Dep=!!sym(Dependent))%>%
      filter(!is.na(Dep),
             !is.na(Indy),
             Dep>0,
             Indy>0)

    
    LimitLIMSDF$Pred1 <- LoessGenerater(LimitLIMSDF,weights=weights[[1]],Span=Span,min = min,max = max)
    LimitLIMSDF$PredSE <- LoessGenerater(LimitLIMSDF,weights=weights[[2]],Span=Span,min = min,max = max)
    LoessPlot=LimitLIMSDF%>%
      mutate(ErrorMin=Indy-Dep,ErrorMax=Indy+Dep)%>%
          mutate(ErrorMin=ifelse(ErrorMin>0,ErrorMin,0))%>%
          ggplot()+
          aes(x=Date)+
          geom_rect(aes(ymin=ErrorMin,ymax=ErrorMax,xmin=Date-BoxWidth,xmax=Date+BoxWidth),color="black",alpha=.25)+
          geom_rect(aes(ymin=Indy,ymax=Indy,xmin=Date-BoxWidth,xmax=Date+BoxWidth),color="black",alpha=.25)+
          geom_line(aes(y=Pred1,color="1"),size=1.25)+
          geom_line(aes(y=PredSE,color=paste0(Independent,"/",Dependent)),size=1.25)
    if(SiteLab){
      LoessPlot=LoessPlot+facet_wrap(~Site)
    }
    LoessPlot=LoessPlot+
          labs(title="", y=paste0(Independent," (GC/L)"),
               color="Weights Used")+
      #Header_theme(ConfigOption)+
        theme(axis.text = element_text(size = ConfigOption$XAxisLabSiz, colour = "black"),
              axis.title = element_text(size = ConfigOption$GenFontSiz, colour = "black"),
              plot.margin = unit(c(0,0,0,0), "cm"))+ 
      theme(legend.position = "bottom")
    
    #Formatting code
    
    PlaceHolder=""
    if(HasNo){
      PlaceHolder="no"
    }
    
    if(Title){
      LoessPlot=LoessPlot+
        ggtitle(paste0("Weighted loess smoothing with ",PlaceHolder," truncation 
                     loessFit(",Independent, " ~ Date, span=",Span,")"))
    }
    if(FullLim){
      XVar=LIMSFullDF$Date
      YVar=pull(LIMSFullDF,Independent)
      XLim <- c(min(XVar),max(XVar))
      YLim <- c(min(YVar[YVar!=0]),max(YVar))
      LoessPlot <- LoessPlot+
        scale_x_date(limits = XLim)+
        scale_y_log10(limits = YLim)
    }else{
      LoessPlot <- LoessPlot+
        scale_y_log10()
    }
    if(NoLabel){
      LoessPlot <- LoessPlot + 
        labs(title="",x="",y="")
        # theme(axis.title.x=element_blank(),
        #     axis.title.y=element_blank())
    }
    return(LoessPlot)
}

```