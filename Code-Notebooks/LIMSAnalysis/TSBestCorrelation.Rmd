---
title: "TSBestCorrelation"
author: "Marlin"
date: "7/22/2021"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r set up markdown settings, echo=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

```

```{r Start enviroment, message=FALSE, warning=FALSE}
library(ggpubr)
library(forecast)
library(lmtest)
library(lubridate)
library(limma)
library(zoo)
library(dplyr)

#Data Files and prep work
source("../../Scripts/GenPlotMaking.R")
source("../../Scripts/WasteWaterDataProccess.R")
source("../../Scripts/CasesDataProccess.R")
source("../../Scripts/HelperFunctions.R")

```

```{r DF Set Up, include=TRUE}
PathStarter="Z:/"

LatMMSDFN  <-  paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/MMSD_Cases.csv")
LatSpringDormFN  <-  paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/SpringSemester_CasesByDorm.TSV")
LatFallDormFN  <-  paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/FallSemester_CasesByDorm.TSV")

LIMSFN <- paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/WATERMICRO_WW_COVID-2021-06-30 17 40.xlsx")

HFGCasesFN  <-  paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/HighFreq_CaseData_2021-05-07.csv")


LatCaseDF <- CovidDataPARSER(LatSpringDormFN,LatFallDormFN,MMSDFN = LatMMSDFN)%>%
  filter(!is.na(Site))%>%
  select(Date,Site,Cases,Tests,Per_pos)

HFGCaseDF <- HFGCasesPARSER(FN = HFGCasesFN)%>%
  filter(!is.na(Site))%>%
  mutate(Tests=NA,Per_pos=NA)%>%
  select(Date,Site,Cases=ReportedCases,Tests,Per_pos)%>%
  mutate(Cases = ifelse(Cases==-999,2.5,Cases))%>%
  filter(Site!="Madison")

FullCase <- rbind(HFGCaseDF,LatCaseDF)

FullCaseRoll <- RollPerPos(FullCase,"Cases","Tests",Facet="Site",n = 14)

LIMSFullDF <- LIMSDataPARSER(LIMSFN)%>%
  select(Date,Site, BCoV, N1,N1Error,N2, N2Error,PMMoV,Pop,FlowRate)

CaseSum=FullCase%>%
  filter(!is.na(Cases))%>%
  group_by(Site)%>%
  summarise(NCase=n())

N1Sum=LIMSFullDF%>%
  filter(!is.na(N1))%>%
  group_by(Site)%>%
  summarise(NN1=n())

DataComp <- inner_join(CaseSum,N1Sum,by=c("Site"))%>%
  mutate(Dif=NCase-NN1,min=ifelse(NCase<NN1,NCase,NN1))
LowCaseDataPoints <- DataComp%>%
  filter(Dif<0)

```

```{r Madison Prep, fig.height=3,include=FALSE}
MergedDF <- BestCorDFGen("Madison")
```


```{r N1BestSmoothing}
#Bad wrm.smooth


plot(predict(PlotingOptions(7,7,2)))
plot(resid(PlotingOptions(7,7,2)))
auto.arima(resid(PlotingOptions(7,7,2)))


p=20
b=10
data=MergedDF$N1[!is.na(MergedDF$N1)]

plot(exp(predict(aroma.light::robustSmoothSpline(log(MergedDF$N1[!is.na(MergedDF$N1)])))$y))

plot(aroma.light::robustSmoothSpline(MergedDF$N1[!is.na(MergedDF$N1)]))

plot(predict(loess(N1[!is.na(MergedDF$N1)]~as.numeric(Date[!is.na(MergedDF$N1)]),data=MergedDF,span=.2)))



MergedDF2 <- MergedDF%>%
  filter(Date>mdy("10/1/2020"))

DateBase <- as.numeric(MergedDF2$Date)
ybase <- MergedDF2$N1[!is.na(MergedDF2$N1)]
y1=exp(predict(aroma.light::robustSmoothSpline(x=1:266,y=log(ybase)))$y)
y2=predict(aroma.light::robustSmoothSpline(x=1:266,y=ybase))$y
x=MergedDF2$Cases2.PreRolled[!is.na(MergedDF2$N1)]
plot(x)
par(new = TRUE)
plot(y1)
plot(diff(x,1))
par(new = TRUE)
plot(diff(y,1))

cor(x,y)
length(ybase)
length(y)
length(x)
library(aroma.light)
names(robustSmoothSpline(ybase))


y1=exp(predict(aroma.light::robustSmoothSpline(log(ybase)),1:266)$y)
y2=exp(predict(aroma.light::robustSmoothSpline(log(ybase)))$y)
x=MergedDF2$Cases2.PreRolled[!is.na(MergedDF2$N1)]
plot(x)
par(new = TRUE)
plot(y1,col="blue")
par(new = TRUE)
plot(y2,col="red")

aroma.light::robustSmoothSpline(smooth.spline(x=1:266,y=log(ybase)))

```

```{r Best Fit of N1 and SLD}
#TODO:collection date
#library("robets")
#.0131
RobMod <- c(fitted.values(robets(MergedDF$N1,
                           alpha=.0131,model="AAN"))[31:282],rep(NA,30))
MAMod <- c(zoo::rollapply(data=MergedDF$N1,
                    width=35,FUN=mean,align="right",fill=NA)[31:282],
           rep(NA,30))

LoessMod <- c(MergedDF$LoessN1[16:282],
           rep(NA,15))
CaseMod <- MergedDF$Cases2


plot(RobMod,type="l",yaxt='n', ann=FALSE)
par(new = TRUE)
plot((CaseMod),col="Red",type="l",yaxt='n', ann=FALSE)
par(new = TRUE)
plot((MAMod),
     col="Green",type="l",yaxt='n', ann=FALSE)
par(new = TRUE)
plot((zoo::rollapply(data=MergedDF$N1Filtered,
                    width=3,FUN=median,align="center",fill=NA)),
     col="Blue",type="l",yaxt='n', ann=FALSE)
par(new = TRUE)
plot((LoessMod),col="pink",type="l",yaxt='n', ann=FALSE)
legend(x="topright", legend=c("Robust ES","SLD Cases","35 day MA","3 day meadian N1","loess"),fill=c("Black","Red","Green","Blue","pink"))
#robust ES with offset 30 fits cases best

plot(diff(MergedDF$Cases2),col="Red",type="l")
par(new = TRUE)
plot(diff(RobMod),type="l")




cor(RobMod,MergedDF$Cases2,use = "na.or.complete")
LMRob=lm(MergedDF$Cases2~RobMod-1)
ArimaMod=auto.arima(MergedDF$Cases2, xreg=RobMod)
summary(LMRob)
summary(ArimaMod)
plot(resid(ArimaMod))
plot(resid(LMRob),type="l")
LMRob2=lm(diff(MergedDF$Cases2)~diff(RobMod)-1)
summary(LMRob)
summary(LMRob2)
plot(LMRob)



ccf(s.ts(RobMod3),as.ts(MergedDF$N1[1:161]),lag.max=20)
#robust es with offset 20 fits N1 best

RobMod3<- fitted.values(robets(MergedDF$N1,
                           alpha=.0131,model="AAN"))[22:282]
N1Resid <- log(MergedDF$N1[1:261]/RobMod3)

plot(y=N1Resid,x=RobMod3)


plot((fitted.values(robets((MergedDF$N1),
                           alpha=.0131,model="MAN"))))
par(new = TRUE)
plot((CaseMod),col="Red",type="l",yaxt='n', ann=FALSE)
```

```{r}


MergedDF3 <- MergedDF%>%
  #filter(Date>mdy("11/1/2020"))%>%
  select(Date,Cases2,N1,N1Error)

MergedDF3$Trend <- exp(log(c(RobMod3,rep(NA,21))))
MergedDF3$Resid <- MergedDF3$N1-MergedDF3$Trend
MergedDF3$ResidLog <- log(MergedDF3$N1/MergedDF3$Trend)
MergedDF3 <- MergedDF3%>%
  filter(!is.na(Trend),!is.nan(Trend))


MergedDF3%>%
  ggplot()+
  aes(x=Date)+
  geom_line(aes(y=N1,color="N1"))+
  geom_line(aes(y=Trend,color="Trend"))+
  ggtitle("N1 vs Trend")

MergedDF3%>%
  ggplot()+
  #aes(x=Date)+
  geom_histogram(aes(x=ResidLog))

MergedDF3%>%
  ggplot()+
  aes(x=Date)+
  geom_point(aes(y=Resid))

MergedDF3%>%
  ggplot()+
  aes(x=log(Trend))+
  geom_point(aes(y=ResidLog))


par(mfrow=c(1,2))
acf(MergedDF3$ResidLog)
pacf(MergedDF3$ResidLog)

ARMod <- arima(MergedDF3$ResidLog,order=c(1,0,0))
par(mfrow=c(1,2))
acf(resid(ARMod))
pacf(resid(ARMod))
# summary(lm(log(N1)~log(Trend)-1,data=MergedDF3))
MergedDF3$TruLogResid <- resid(ARMod)


MergedDF3%>%
  ggplot()+
  aes(x=Date)+
  geom_point(aes(y=ResidLog,color="LogResid"))+
  geom_point(aes(y=TruLogResid,color="ArimaResid"))


MergedDF3%>%
  ggplot()+
  #aes(x=Date)+
  geom_histogram(aes(x=TruLogResid))


MergedDF3%>%
  ggplot()+
  aes(x=log(Trend))+
  geom_point(aes(y=TruLogResid))


sum((MergedDF3$TruLogResid)^2)/(length(MergedDF3$TruLogResid)-1)
sum((MergedDF3$ResidLog)^2)/(length(MergedDF3$ResidLog)-1)


#0.9856061
#Validate this on HF data
LogMeans <- log(MergedDF3$N1)
LogVariances <- (3*MergedDF3$N1Error^2)/MergedDF3$N1^2
mean(LogVariances)
fishmethods::combinevar(LogMeans,LogVariances,rep(3,length(LogVariances)))
#survcomp::combine.est(LogMeans,sqrt(LogVariances/3))
#0.9210504


library(survcomp)
#survcomp::combine.est()
```




```{r Madison Prep, fig.height=3,include=FALSE}
Intercepters <- c("MMSD-P7" ,"MMSD-P2" ,               
"MMSD-P8","MMSD-P11",                
"MMSD-P18")

IntercepterDFList <- lapply(Intercepters,BestCorDFGen)
```
