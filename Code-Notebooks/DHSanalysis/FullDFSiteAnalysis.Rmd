---
title: "FullDFSiteAnalysis"
author: "Marlin"
date: "5/5/2022"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Prep Data}

#?add parm script functionality
BaseDir <- "./../../"
#Var1 <- ""

library(dplyr)
library(ggplot2)
library(limma)
library(tidyr)
library(patchwork)
#Data Files and prep work
#source("../../lib/DataPathName.R")
source("../../lib/OutlierDetectionFuncs.R")
source("../../lib/TSTrendGen.R")
source("DHSAlgo.R")
library(zoo)

#Importing the waste water data
LIMSFullDF <- read.csv("../../data/processed/workset4.csv")%>%
  mutate(date = as.Date(date))


SiteDFList <- LIMSFullDF%>%
    rename(Date=date, Site = WWTP)%>%
    group_by(Site)%>%
    #filter(n()>135)%>%
    mutate(sars_cov2_adj_load = 10^sars_cov2_adj_load_log10)%>%
    group_split()

VecModOn <- "sars_cov2_adj_load_log10"

DataMod <- SiteDFList%>%
  lapply(TrendSDOutlierFilter, "sars_cov2_adj_load", 1.25, 14, n = 5, 
           TrendFunc = LoessSmoothMod, verbose = TRUE)%>%
  lapply(LoessSmoothMod, VecModOn, "Loess", "guess")%>%
  lapply(ExpSmoothMod, VecModOn, "EXP")%>%
  lapply(sgolaySmoothMod, VecModOn, "sgolay")%>%
  bind_rows()%>%
    rename(date=Date, WWTP = Site)%>%
    mutate(RemovedOutlierCol = ifelse(FlaggedOutlier,NA,!!sym(VecModOn)))



LIMSFullDF%>%
  group_by(WWTP)%>%
  summarise(n = n())%>%
  arrange(n)
```


```{r AllSite Loop, Warning = FALSE}

LMfited <- c(
              as.formula("sars_cov2_adj_load_log10 ~ date"),
              as.formula("Loess ~ date"),
              as.formula("RemovedOutlierCol ~ date"))
              # as.formula("EXP ~ date"),
              # as.formula("sgolay ~ date")



reg_estimates = DataMod%>%
          group_by(WWTP)%>%
          group_split()%>%
          lapply(OuterLoop, LMfited, verbose = FALSE)%>%
          bind_rows()


reg_estimates <- reg_estimates%>%
          DHSClassificationFunc(PSigTest=TRUE)


```


```{r Edge Include, include = TRUE}

ConfMatrix(reg_estimates,"Catagory","Loess","sars_cov2_adj_load_log10")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


reg_estimates%>%
  group_by(Method,Catagory)%>%
  summarise(n = n())%>%
  ggplot(aes(x=Catagory,y=n))+
           geom_col(aes(fill=Method),position = "dodge")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r MergePlot}
source("../MainStory/MainStory.R")
Dim = ceiling(length(unique(reg_estimates$WWTP))/4)

BarGridSmoothRaw <- reg_estimates%>%
  FactorVecByNumPoints("WWTP","Catagory")%>%
  CreateHeatMaps(ToMerge=TRUE)
 
Gplt <- DataMod%>%
  FactorVecByNumPoints("WWTP","sars_cov2_adj_load_log10")%>%
  filter(WWTP %in% unique(reg_estimates$WWTP))%>%
  mutate(Data = "Data")%>%
  ggplot(aes(x=date))+
  geom_point(aes(y = sars_cov2_adj_load_log10), size = .5)+
  geom_point(aes(y = RemovedOutlierCol, color = "OutlierError"), size = .5)+
  #geom_line(aes(y = EXP, color = "EXP"))+
  geom_line(aes(y = Loess, color = "Loess"))+
  #geom_line(aes(y = sgolay, color = "sgolay"))+
  facet_grid(Data~WWTP)+
  scale_x_date(date_labels = "%b %y") +
  theme(
  strip.background = element_blank(),
  strip.text.x = element_blank()
)

SavePlot <- BarGridSmoothRaw/Gplt + plot_layout(heights = c(2, 1))



ggsave("ClassCompare2.PDF",plot=SavePlot,
         width = 32*Dim,height = 15,units="cm",limitsize =FALSE)

```
