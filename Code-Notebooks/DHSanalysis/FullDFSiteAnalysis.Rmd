---
title: "FullDFSiteAnalysis"
author: "Marlin"
date: "5/5/2022"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Prep Data}

#?add parm script functionality
BaseDir <- "./../../"

library(dplyr)
 library(ggplot2)
 library(limma)
 library(tidyr)
 library(patchwork)

#Data Files and prep work
#source("../../lib/DataPathName.R")
library(DSIWasteWater)
#library(zoo)

#Importing the waste water data
LIMSFullDF <- read.csv("../../data/processed/workset4.csv")%>%
  mutate(date = as.Date(date))


VecModOn <- "sars_cov2_adj_load_log10"

DataMod <- LIMSFullDF%>%
    rename(Date=date, Site = WWTP)%>%
    #filter(n()>135)%>%
    mutate(sars_cov2_adj_load = 10^sars_cov2_adj_load_log10)%>%
    group_by(Site)%>%
    group_split()%>%
    lapply(TrendSDOutlierFilter, "sars_cov2_adj_load", 1.25, 14, n = 5, 
           TrendFunc = LoessSmoothMod, verbose = FALSE)%>%
    lapply(LoessSmoothMod, VecModOn, "Loess", "guess")%>%
    lapply(ExpSmoothMod, VecModOn, "EXP")%>%
    lapply(sgolaySmoothMod, VecModOn, "sgolay")%>%
    bind_rows()%>%
    rename(date=Date, WWTP = Site)%>%
    mutate(RemovedOutlierCol = ifelse(FlaggedOutlier,NA,!!sym(VecModOn)))

```


```{r AllSite Loop, Warning = FALSE}
#RunOn <- c(sars_cov2_adj_load_log10,RemovedOutlierCol,Loess,EXP ,sgolay)


RunOn <- c("sars_cov2_adj_load_log10", "Loess", "sgolay")
reg_estimates = DHSTopLevelAnalysis(DataMod, RunOn, 
                                    "WWTP", verbose=TRUE,
                                    PSigTest=TRUE)

```


```{r Edge Include, include = TRUE}
ConfMatrix(reg_estimates,"Catagory","Loess","sars_cov2_adj_load_log10")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


reg_estimates%>%
  group_by(Method,Catagory)%>%
  summarise(n = n())%>%
  ggplot(aes(x=Catagory,y=n))+
           geom_col(aes(fill=Method),position = "dodge")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

reg_estimates%>%
  filter(is.na(Catagory))


unique(reg_estimates$Method)
```

```{r MergePlot}
VDim = length(RunOn)+1
HDim = length(unique(reg_estimates$WWTP))


SavePlot <- DHSTopLevelPlots(reg_estimates,DataMod, Method ~ WWTP,
                             "WWTP", "sars_cov2_adj_load_log10", "Loess")
  


ggsave("ClassCompare2.PDF",plot=SavePlot,
         width = 8*HDim, height = 5*VDim,units="cm",limitsize =FALSE)

```
