---
title: "FullDFSiteAnalysis"
author: "Marlin"
date: "5/5/2022"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Prep Data}

#?add parm script functionality
BaseDir <- "./../../"

library(dplyr)
library(ggplot2)
library(limma)
library(tidyr)
library(patchwork)

#Data Files and prep work
#source("../../lib/DataPathName.R")
library(DSIWasteWater)
library(zoo)

#Importing the waste water data
LIMSFullDF <- read.csv("../../data/processed/workset4.csv")%>%
  mutate(date = as.Date(date))


VecModOn <- "sars_cov2_adj_load_log10"

DataMod <- LIMSFullDF%>%
    rename(Date=date, Site = WWTP)%>%
    #filter(n()>135)%>%
    mutate(sars_cov2_adj_load = 10^sars_cov2_adj_load_log10)%>%
    group_by(Site)%>%
    group_split()%>%
    lapply(TrendSDOutlierFilter, "sars_cov2_adj_load", 1.25, 14, n = 5, 
           TrendFunc = LoessSmoothMod, verbose = TRUE)%>%
    lapply(LoessSmoothMod, VecModOn, "Loess", "guess")%>%
    lapply(ExpSmoothMod, VecModOn, "EXP")%>%
    lapply(sgolaySmoothMod, VecModOn, "sgolay")%>%
    bind_rows()%>%
    rename(date=Date, WWTP = Site)%>%
    mutate(RemovedOutlierCol = ifelse(FlaggedOutlier,NA,!!sym(VecModOn)))

```


```{r AllSite Loop, Warning = FALSE}

LMfited <- c(
               as.formula("sars_cov2_adj_load_log10 ~ date"),
               as.formula("Loess ~ date")#,
               #as.formula("RemovedOutlierCol ~ date"),
               #as.formula("EXP ~ date"),
               #as.formula("sgolay ~ date")
              )

reg_estimates = DataMod%>%
          group_by(WWTP)%>%
          group_split()%>%
          lapply(DHSOuterLoop, LMfited, verbose = TRUE)%>%
          bind_rows()%>%
          DHSClassificationFunc(PSigTest=FALSE)%>%
          rename(NoPsigCatagory = Catagory)%>%
          DHSClassificationFunc(PSigTest=TRUE)%>%
  filter(!is.na(Catagory))

#write.csv(reg_estimates, "results_table.csv", row.names=FALSE)
```


```{r Edge Include, include = TRUE}

ConfMatrix(reg_estimates,"Catagory","Loess","sars_cov2_adj_load_log10")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


reg_estimates%>%
  group_by(Method,Catagory)%>%
  summarise(n = n())%>%
  ggplot(aes(x=Catagory,y=n))+
           geom_col(aes(fill=Method),position = "dodge")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

reg_estimates%>%
  filter(is.na(Catagory))
```

```{r MergePlot}
source("../MainStory/MainStory.R")
VDim = length(LMfited)+1
HDim = length(unique(reg_estimates$WWTP))

BarGridSmoothRaw <- reg_estimates%>%
  FactorVecByNumPoints("WWTP","Catagory")%>%
  CreateHeatMaps(ToMerge=TRUE)

 
Gplt <- DataMod%>%
  FactorVecByNumPoints("WWTP","sars_cov2_adj_load_log10")%>%
  mutate(Data = "Data")%>%
  filter(WWTP %in% unique(reg_estimates$WWTP))%>%
  WastePlot("Date", "sars_cov2_adj_load_log10", "Loess", "sars_cov2_adj_load_log10", "Loess", ToMerge = TRUE)+
  facet_grid(~WWTP)+
  scale_x_date(date_labels = "%b %y")

SavePlot <- BarGridSmoothRaw/Gplt + plot_layout(heights = c(2, 1))
  


ggsave("ClassCompare2.PDF",plot=SavePlot,
         width = 8*HDim, height = 5*VDim,units="cm",limitsize =FALSE)

```
