---
title: "FullDFSiteAnalysis"
author: "Marlin"
date: "5/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Prep Data}

#?add parm script functionality
BaseDir <- "./../../"
#Var1 <- ""

library(dplyr)
library(ggplot2)
library(limma)
library(tidyr)
library(patchwork)
#Data Files and prep work
source("../../lib/DataPathName.R")#merged?
source("../../lib/DataProccess.R")
source("DHSAlgo.R")
  source("../MainStory/MainStory.R")
  library(zoo)
#Importing the waste water data
LIMSFullDF <- ParseData(LIMSWastePath(BaseDir))%>%
  mutate(N1Pure = ifelse(is.na(N1),N2,N1),
         N2Pure = ifelse(is.na(N2),N1,N2),
         logGeoNorm =  log((FlowRate/Pop),10)+(log(N1Pure,10)+log(N2Pure,10))/2)%>%
  #group_by(Site)%>%
  filter(Pop>19680	)%>%#fudge Pop
  filter(!is.infinite(logGeoNorm),!is.na(logGeoNorm))%>%
  select(Date, Site, logGeoNorm,Pop)%>%
  rename(WWTP = Site, date = Date, sars_cov2_adj_load_log10 = logGeoNorm)
  


SiteDFList <- LIMSFullDF%>%
    rename(Date=date)%>%
    split(LIMSFullDF$WWTP)
  
  DataMod <- bind_rows(lapply(SiteDFList, LoessSmoothMod, "sars_cov2_adj_load_log10","Loess", "guess"))%>%
    rename(date=Date)

```

```{r AllSite Loop, Warning = FALSE}

reg_estimates = as.data.frame(matrix(ncol=8, nrow=0))

colnames(reg_estimates) = c("WWTP", "date", "days_elapsed", "lmreg_n" , "lmreg_slope", "lmreg_sig", "modeled_percentchange","Data")

distinct_wwtps = DataMod %>%
  group_by(WWTP)%>%
  filter(n()>5)%>%
  distinct(WWTP)

for (i in 1:nrow(distinct_wwtps)){
  
  print(paste(distinct_wwtps[i,1]))
  
  ww.x = DataMod %>%
    
    filter(WWTP==paste(distinct_wwtps[i,1]))
  
  for (k in 1:(nrow(ww.x) - 4)){
    ww.x.tobind.Base <- InnerFunc(ww.x,k,4,as.formula("sars_cov2_adj_load_log10 ~ date"))%>%
      mutate(Data = "Raw")
    # Join with full set of reg estimates
    ww.x.tobind.Loess <- InnerFunc(ww.x,k,4,as.formula("Loess ~ date"))%>%
      mutate(Data = "Loess")
    # Join with full set of reg estimates
    ww.x.tobind = rbind(ww.x.tobind.Base,ww.x.tobind.Loess)
    
    reg_estimates = rbind(ww.x.tobind, reg_estimates)
  }
}

```

```{r }

#Order WTTP by number of points
reg_estimates <- FactorVecByNumPoints(reg_estimates,"WWTP","modeled_percentchange")



#Bring into own function
Catagorylabel = c("major decrease","moderate decrease","fluctuating ","moderate increase","major increase")

reg_estimates <- reg_estimates%>%
    mutate(Catagory = cut(modeled_percentchange,c(-Inf,-80,-10,10,100,Inf),
                          include.lowest=TRUE,
                          ordered_result=TRUE),
           Catagory = ifelse(lmreg_sig>.3,"no change",Catagory),
            Catagory = factor(Catagory, c(1,2,3,4,5,"no change"), 
                              labels = c( Catagorylabel, "no change"), exclude = NULL))

#
CatagoryColors <- c("#0571b0", "#92c5de", "#979797","#f4a582","#ca0020","Black")

reg_estimates%>%
  ggplot(aes(x=date,y=modeled_percentchange,color = Catagory))+
  scale_color_manual(values = CatagoryColors)+
  geom_point()

unique(reg_estimates$Catagory)
```


```{r MergePlot}

Dim = ceiling(length(unique(reg_estimates$WWTP))/4)

BarGridLoessRaw <- reg_estimates%>%
    ggplot()+
    geom_rect(aes(xmin=date-2,xmax=date+2,
                  ymin=0,
                  ymax = 10,fill = Catagory))+
    facet_grid (Data~WWTP, scales = "free")+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  scale_fill_manual(values = CatagoryColors)

  
  ggsave("Temp.PDF",plot=BarGridLoessRaw,
         width = 16*Dim,height = 10,units="cm",limitsize =FALSE)
```
  
```{r}  
Gplt <- FactorVecByNumPoints(DataMod,"WWTP","Loess")%>%
  filter(WWTP %in% unique(reg_estimates$WWTP))%>%
  mutate(Data = "Data")%>%
  ggplot(aes(x=date))+
  geom_point(aes(y = sars_cov2_adj_load_log10), size = .5)+
  geom_line(aes(y = Loess),color = "RED")+
  facet_grid(Data~WWTP)+
  theme(
  strip.background = element_blank(),
  strip.text.x = element_blank()
)

SavePlot <- BarGridLoessRaw/Gplt + plot_layout(heights = c(2, 1))

ggsave("ClassCompare.PDF",plot=SavePlot,
         width = 32*Dim,height = 15,units="cm",limitsize =FALSE)

```
