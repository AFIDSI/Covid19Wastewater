---
output:
  pdf_document: default
  html_document: default
---
```{r warning = FALSE, message = FALSE,echo = FALSE}
source("../Scripts/DataProccess.R")

HFGData="../../UntrackedData/HFG data for stats preliminary 3-18-21.xlsx"

HFGFrame=HFGInfo(HFGData)%>%
  mutate(Filter=as.character(Filter),Well=as.character(Well))%>%
  filter(!is.na(N1GC),!is.na(Filter),!is.na(Plant),!is.na(Date))%>%
  mutate(DayPlace=paste(Plant,Date),DayPlaceFilter=paste(Plant,Date,Filter))%>%
  select(DayPlace,DayPlaceFilter,N1GC)%>%
  group_by(DayPlace)%>%
  mutate(n=n())%>%
  filter(n==9)

HFGSumarized=HFGFrame%>%
  group_by(DayPlace)%>%
  mutate(N=n(),K=length(unique(DayPlaceFilter)))%>%
  mutate(Y_mean_DP=mean(log(N1GC)))%>%
  group_by(DayPlaceFilter)%>%
  mutate(Y_mean_Filter=mean(log(N1GC)))%>%
  group_by(DayPlace)%>%
  summarize(between=sum((Y_mean_Filter-Y_mean_DP)^2)/(K-1),within=sum((log(N1GC)-Y_mean_Filter)^2)/(N-K))%>%
  distinct()%>%
  mutate(Plant=strsplit(DayPlace, " ")[[1]][1])

#Example point={1,1,1,2,3,4,5,5,5}
#sample means are ={1,3,5}
#total mean = {3}
#numerator = 3 * (1-3)^2 + 

#OverallData=HFGFrame%>%
#  mutate(Y_mean=mean(log(N1GC)),N=n(),K=length(unique(DayPlaceFilter)))%>%
#  group_by(DayPlaceFilter)%>%
#  mutate(Y_mean_Filter=mean(log(N1GC)))%>%
#  ungroup()%>%
#  summarize(between=sum((Y_mean_Filter-Y_mean)^2)/(K-1),within=sum((log(N1GC)-Y_mean_Filter)^2)/(N-K))%>%
#  distinct()%>%
#  mutate(FScore=between/within)
#OverallData

#DayPlace.aov <- aov(log(N1GC) ~ DayPlaceFilter, data = HFGFrame)
#summary(DayPlace.aov)[1][[1]][4][1]


```


```{r fig.width=8, fig.height=8,echo = FALSE}

HFGSumarized%>%
  ggplot()+geom_point(aes(x=between,y=within,color=Plant))+
  geom_abline(intercept = 0, slope = 1)+
  scale_y_log10()+
  scale_x_log10()

HFGSumarized%>%
  ggplot()+geom_histogram(aes(x=between/within),bins = 30)+
  geom_vline(xintercept = 1,color="red")+
  scale_x_log10()+
  xlab("F Score")
```
```{r}
library(VCA)

HFGFrame=HFGInfo(HFGData)%>%
  filter(Plant=="Madison")%>%
  filter(!is.na(N1GC),!is.na(Filter),!is.na(Well),!is.na(Date),!is.na(Plant))%>%
  mutate(N1GC=as.numeric(N1GC),Filter=factor(Filter),Well=factor(Well),Date=factor(Date),Plant=factor(Plant))%>%
  select(N1GC,Plant,Date,Filter,Well)
levels(HFGFrame$Filter)


HFGFrame
varPlot(form=N1GC~Filter, Data=HFGFrame)


#20 9 madison

form=N1GC~Filter
form <- terms(form, simplify = TRUE)


temp=terms(form, simplify = TRUE)

nest=attr(temp, "term.labels")

nest <- sapply(nest, function(x) {
        x <- unlist(strsplit(x, ":"))
        return(x[length(x)])
})
 tab <- table(nest)
resp <- rownames(attr(form, "factors"))[1]

nest[1] != "1"


VCA:::buildList
unique(as.character(Data[, Current]))
```

```{r}
Data = HFGFrame
Nesting = nest
Current = nest[1]
resp = resp
keep.order = TRUE
useVarNam = FALSE 
Points = list(pch = 16, cex = 0.5, col = "black")
VCA:::buildList(Data,Nesting,Current,resp,keep.order,useVarNam,Points)
```
