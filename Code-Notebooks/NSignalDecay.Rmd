---
title: "NSignalDecay"
author: "Marlin"
date: "7/25/2021"
output: html_document
---
```{r, echo=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r Start enviroment, message=FALSE, warning=FALSE, echo=FALSE}
library(ggpubr)
library(tidyverse)
library(forecast)
library(lmtest)
library(lubridate)
library(lme4)
library(lmerTest)
#Data Files and prep work
source("../Scripts/GenPlotMaking.R")
source("../Scripts/WasteWaterDataProccess.R")
source("../Scripts/CassesDataProccess.R")
source("../Scripts/HelperFunctions.R")
```

```{r DF Set Up, echo=FALSE}
PathStarter="Z:/"

SigWasteFN <- paste0(PathStarter,
      "COVID-19_WastewaterAnalysis/data/raw/TimeSeriesDataforStats072321.csv")

SigDecayDF <- read.csv(SigWasteFN)%>%
  rename(collectionDate = Collection.Date,
         FilteredDate = Filtered.Date)%>%
  mutate(collectionDate = mdy(collectionDate), 
         FilteredDate = mdy(FilteredDate),
         TimePassed = FilteredDate-collectionDate,
         N1.CT = as.numeric(N1.CT))

```




The hierarchical structure of the data suggests a mixed effect model is the most appropriate way of measuring the significance of the decay rate

```{r ploting Funcs, warning=FALSE, message=FALSE}
#

MixedEffectModelSum <- function(DF,Var){
  MixedEffectModel <- lmer(as.formula(paste0("log(",Var,") ~ TimePassed +   (1|WWTP:Filter.Replicate)")),
                         data = DF)
  summary(MixedEffectModel)
}
MixedEffectModelPlot <- function(DF,Var,Title,subtitle){
  MixedEffectModel <- lmer(as.formula(paste0("log(",Var,") ~ TimePassed +   (1|WWTP:Filter.Replicate)")),
                         data = DF)

  DF2 <- DF%>%
    filter(!is.na(!!sym(Var)))
  
  Temp <- signif(summary(MixedEffectModel)$coefficients[10],4)
                                    
  DF2$Pred = exp(predict(MixedEffectModel))
  
  DF2%>%
    mutate(Filter.Replicate=substr(Filter.Replicate,4,6))%>%
     ggplot()+
     geom_jitter(aes(x=FilteredDate,y=!!sym(Var),color=Filter.Replicate,alpha=as.character(Temp)),width = .2)+
     geom_line(aes(x=FilteredDate,y=Pred,color=Filter.Replicate))+
     facet_wrap(~WWTP,nrow = 3)+
     scale_y_log10()+
    labs(y=Var,
         x="Filtered Date",
         color = "Filter Replicate",
         title=Title,
         subtitle=subtitle)+
    scale_alpha_manual(values=c(1),labels = c(Temp),name=expression(p[slope]),guide = 'legend')
}

regressions_data <- function(Var,DF){
  DF%>%
    mutate(Filter.Replicate=substr(Filter.Replicate,4,6))%>%
    group_by(WWTP,Filter.Replicate)%>%
    summarise(PVal=signif(summary(lm(!!sym(Var)~TimePassed))$coefficients[8], digits = 3))
}

#ggplot latex? subscripts p_slope
DecayPlot <- function(Var,DF,Locate=c(18729,-40,45,14)){
  GraphPlot <- DF%>%
    mutate(Filter.Replicate=substr(Filter.Replicate,4,6))%>%
    ggplot()+
    aes(x=FilteredDate,y=!!sym(Var),color = Filter.Replicate)+
    geom_label(inherit.aes=FALSE, 
          aes(x = as.Date(Locate[1]-Locate[4]*abs(as.numeric(as.factor(WWTP))-2)),
           y = Locate[2]+Locate[3]*as.numeric(as.factor(Filter.Replicate)),
           color=Filter.Replicate, 
           label=paste("p[slope]","==",  PVal)),
           size=4,
           show.legend = FALSE,
           parse = TRUE,
           data=regressions_data(Var,DF))+
    geom_jitter(width = .2)+
    geom_smooth(method = "lm", se=FALSE)+
    scale_y_log10()+
    labs(x="Filtered Date",y="N1 (GC/L)",color="Filter Replicate")+
    facet_wrap(~WWTP,nrow=3)
  return(GraphPlot)
}

```


```{r ploting N1, warning=FALSE, message=FALSE,fig.height=6}
DecayPlot("N1.GC.L",SigDecayDF)+
  ggtitle("Independent analysis for each filter rep")

MixedEffectModelPlot(SigDecayDF, Var = "N1.GC.L",Title="mixed effect model estimating common slope",subtitle="")


SigDecayDF2 <- SigDecayDF%>%
  filter(!(WWTP=="WI Rapids"&Filter.Replicate=="Rep A"))

MixedEffectModelPlot(SigDecayDF2,Var = "N1.GC.L",Title="mixed effect model estimating common slope",  subtitle="excluding apparent outlier")
```


```{r ploting N2, warning=FALSE, message=FALSE,fig.height=6}
DecayPlot("N2.GC.L",SigDecayDF)+
  ggtitle("Independent analysis for each filter rep")


MixedEffectModelPlot(SigDecayDF, Var = "N2.GC.L",Title="mixed effect model estimating common slope",subtitle="")


SigDecayDF2 <- SigDecayDF%>%
  filter(!(WWTP=="WI Rapids"&Filter.Replicate=="Rep A"))


MixedEffectModelPlot(SigDecayDF2,Var = "N2.GC.L",Title="mixed effect model estimating common slope",
                      subtitle="excluding apparent outlier")
```

```{r ploting PMMoV, warning=FALSE, message=FALSE,fig.height=6}
DecayPlot("PMMoV.GC.L",SigDecayDF)+
  ggtitle("Independent analysis for each filter rep")

MixedEffectModelPlot(SigDecayDF, Var = "PMMoV.GC.L",Title="mixed effect model estimating common slope",subtitle="")


SigDecayDF2 <- SigDecayDF%>%
  filter(!(WWTP=="WI Rapids"&Filter.Replicate=="Rep A"))


MixedEffectModelPlot(SigDecayDF2,Var = "PMMoV.GC.L",Title="mixed effect model estimating common slope",
                      subtitle="excluding apparent outlier")
```

```{r ploting BCoV, warning=FALSE, message=FALSE,fig.height=6}
DecayPlot("BCoV.percent.recovery",SigDecayDF)+
  ggtitle("Independent analysis for each filter rep")


MixedEffectModelPlot(SigDecayDF, Var = "BCoV.percent.recovery",Title="mixed effect model estimating common slope",subtitle="")


SigDecayDF2 <- SigDecayDF%>%
  filter(!(WWTP=="WI Rapids"&Filter.Replicate=="Rep A"))


MixedEffectModelPlot(SigDecayDF2,Var = "BCoV.percent.recovery",Title="mixed effect model estimating common slope",
                      subtitle="excluding apparent outlier")
```