---
title: "NSignalDecay"
author: "Marlin"
date: "7/25/2021"
output: html_document
---
```{r}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r Start enviroment, message=FALSE, warning=FALSE}
library(ggpubr)
library(tidyverse)
library(forecast)
library(lmtest)
library(lubridate)
library(lme4)
#Data Files and prep work
source("../Scripts/GenPlotMaking.R")
source("../Scripts/WasteWaterDataProccess.R")
source("../Scripts/CassesDataProccess.R")
source("../Scripts/HelperFunctions.R")
```

```{r DF Set Up}
PathStarter="Z:/"

SigWasteFN <- paste0(PathStarter,"COVID-19_WastewaterAnalysis/data/raw/TimeSeriesDataforStats072321.csv")

SigDecayDF <- read.csv(SigWasteFN)%>%
  rename(collectionDate = Collection.Date,
         FilteredDate = Filtered.Date)%>%
  mutate(collectionDate = mdy(collectionDate), 
         FilteredDate = mdy(FilteredDate),
         TimePassed = FilteredDate-collectionDate,
         N1.CT = as.numeric(N1.CT))

```
```{r data discription}

SigDecayDF%>%
  group_by(WWTP,collectionDate,Filter.Replicate)%>%
  summarise(n())

SigDecayDF%>%
  ggplot()+
  aes(x=TimePassed,y=log(N1.GC.L),color=paste(WWTP,Filter.Replicate))+
  geom_point()+
  geom_smooth(method="lm")


SigDecayDF%>%
  group_by(WWTP,Filter.Replicate,TimePassed)%>%
  summarise(N1=mean(log(N1.GC.L),na.rm=TRUE),Var=var(log(N1.GC.L),na.rm=TRUE))%>%
  ggplot()+
  aes(x=TimePassed,color=Filter.Replicate)+
  geom_rect(aes(xmin=TimePassed-.2,xmax=TimePassed+.2,
                ymin=N1-Var,ymax=N1+Var),fill=NA)+
  geom_point(aes(y=N1))+
  facet_wrap(~WWTP,nrow=3)
```
```{r, warning=FALSE}
aba <- SigDecayDF%>%
  filter(WWTP=="Kenosha",Filter.Replicate=="Rep A",
         !is.na(N1.GC.L))

aba$Pred <- predict(lm(log(N1.GC.L)~ TimePassed ,data=aba))


full_join(SigDecayDF,aba,by=c("WWTP","Filter.Replicate","TimePassed","N1.GC.L"))%>%
  ggplot()+
    aes(x=TimePassed,y=log(N1.GC.L),color=Filter.Replicate)+
    geom_jitter(width = .2)+
    geom_smooth(method = "lm", se=FALSE)+
    geom_line(aes(y=Pred))+
    facet_wrap(~WWTP,nrow=3,scales = "free_y")+
    scale_y_log10()

SigDecayDF3 <- SigDecayDF%>%
  filter(!is.na(N1.GC.L))



SigDecayDF3$Pred <- predict(lm(log(N1.GC.L)~ TimePassed + 
                                TimePassed:WWTP:Filter.Replicate+WWTP:Filter.Replicate+
                                TimePassed:WWTP+WWTP,
                                data=SigDecayDF3))

SigDecayDF3%>%
  ggplot()+
    aes(x=TimePassed,y=log(N1.GC.L))+
    geom_jitter(width = .2)+
    #geom_smooth(method = "lm", se=FALSE)+
    geom_line(aes(y=Pred))+
    facet_grid(Filter.Replicate~WWTP)
```



```{r ploting comp, warning=FALSE, message=FALSE}
summary(lm(N1.GC.L~TimePassed+WWTP,data=SigDecayDF))
summary(aov(log(N1.GC.L)~TimePassed*WWTP*Filter.Replicate,data=SigDecayDF))

#add filter rep to model
#find signif of coef
#N1 ~ Passed|
#A + BT + Noise + Noise_Plant + Noise_Rep

#sig with a ton a vars
#for PMM N1/2 %BCoV significance slope less then 0 jitter
#this plot plus significance number
#plot (geo(N1)+geo(N2))
#log(N1)+log(N2) on left side
#Rep:
#Put everything in a model 

# Difference between filter a and b - if no deg then you would expect constant 
# /some scaling first

# variance over time / 
#

DecayPlot <- function(Var){
  GraphPlot <- SigDecayDF%>%
    ggplot()+
    aes(x=TimePassed,y=!!sym(Var))+
    geom_jitter(width = .2)+
    geom_smooth(method = "lm", se=FALSE)+
    facet_grid(Filter.Replicate~WWTP)+
    scale_y_log10()
  
  Sig<- summary(lm(log(N1.GC.L)~ Filter.Replicate * WWTP * TimePassed ,data=SigDecayDF))[[4]][41]
  return(annotate_figure(GraphPlot,top = text_grob(paste("Significance:",signif(0,3)))))
}

SpearmanTest <- function(Var){
    SigDecayDF%>%
      group_by(WWTP,Filter.Replicate)%>%
      summarise(Cor=cor(log(!!sym(Var)),
                    method="spearman",
                    as.numeric(TimePassed),
                    use="complete.obs"),
                CorPvalue = cor.test(log(!!sym(Var)),
                                     method="spearman",
                               as.numeric(TimePassed),
                               use="complete.obs")[[3]])
}



DecayPlot("N1.GC.L")



#correlation need to be independent
#think about it and make it more rigorous

#look at non parametric test
#look at range for low number of points
#Order by time / values

#show direction
#hetroskdaski - fails
#truncate - stabilize variance
#almost key figure - rigorous visualization of hiarc model. give model 2
#2: variance also increaces. show conc

SpearmanTest("N1.GC.L")

SigDecayDF%>%
  group_by(WWTP,Filter.Replicate)%>%
  summarise(R2 = summary(lm(log(N1.GC.L) ~ TimePassed))$r.squared)
```

```{r}
SigDecayDF%>%
  group_by(WWTP,Filter.Replicate,TimePassed)%>%
  summarise(N1Var=var(log(N1.GC.L)))%>%
    ggplot()+
    aes(x=TimePassed,y=N1Var)+
    geom_jitter(width = .2)+
    geom_smooth(method = "lm", se=FALSE)+
    facet_wrap(~WWTP,nrow=3,scales = "free")+
    facet_grid(Filter.Replicate~WWTP)
#color ramp for time

#some weighted based on lag time

#Formal Hiar fixed = time ,=filter site dependent=N1,N2,PMMoV,BCoV
```


```{r Formal MixedEffect}
library(lmerTest)
#Replicate
#BCoV.percent.recovery Sig
#log(PMMoV.GC.L) Sig
#log(N1.GC.L) Not Sig
#log(N2.GC.L) Not Sig

MixedEffectModel <- lmer(log(N1.GC.L) ~ TimePassed + (1+TimePassed| WWTP:Filter.Replicate), 
                         data = SigDecayDF)
summary(MixedEffectModel)
anova(MixedEffectModel)

full.lmer <- lmer(
  log(N1.GC.L) ~ TimePassed + (1+TimePassed| WWTP:Filter.Replicate), 
                         data = SigDecayDF, REML = FALSE)
reduced.lmer <- lmer(log(N1.GC.L) ~ 1 + (1| WWTP:Filter.Replicate), 
                         data = SigDecayDF, REML = FALSE)
summary(anova(reduced.lmer, full.lmer))
anova(MixedEffectModel, test="F")


SigDecayDF3$Pred <- predict(MixedEffectModel)

SigDecayDF3%>%
  ggplot()+
    aes(x=TimePassed,y=log(N1.GC.L))+
    geom_jitter(width = .2)+
    geom_smooth(method = "lm", se=FALSE)+
    #geom_line(aes(y=Pred))+
    facet_grid(Filter.Replicate~WWTP)



# fit.fixed <- aov(log(N1.GC.L) ~ 
#                    TimePassed * Filter.Replicate * WWTP,
#                  data = SigDecayDF)
# summary(fit.fixed)

# pf(20.58, df1 = 2, df2 = 3, lower.tail = FALSE)
# 
# library(brms)
#  brm(log(N1.GC.L) ~ 1 + (1| WWTP:Filter.Replicate), 
#                               data   = SigDecayDF, 
#                               warmup = 1000, 
#                               iter   = 3000, 
#                               chains = 2, 
#                               inits  = "random")

```