---
params:
  BaseDir: "Z:/"
  IndVar: "N1"
  DepVar: "FirstConfirmed"
  ##BaseDir: "/Volumes/byandell/"
title: "Heuristic exploration of the relationship between cases and viral load"
author: "Marlin Lee"
date: "1/28/2022"
output: 
  bookdown::html_document2: 
    fig_width: 8
    fig_height: 4
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---


```{r set up markdown settings, echo=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE
)
```


```{r Start enviroment, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(lmtest)
library(lubridate)
library(limma)
library(tidyr)
library(plotly)
library(gridExtra)
library(data.table)
library(formattable)

#Data Files and prep work
source("../../lib/DataProccess.R")
source("../../lib/NormFuncs.R")
source("../../lib/OutlierDetectionFuncs.R")
```

```{r helpful data manipulations, include = FALSE}
SelectedIndVar <- params$IndVar#WasteWater Var Used in Analysis
SelectedDepVar <- params$DepVar#Case Var Used in Analysis
OutlierName <- paste(SelectedIndVar,"Outlier")

loessVar <- paste0("loess",SelectedIndVar)
#Custom_color_scale
PlotColors <- c("#F8766D", "#00BFC4", "#4057A2", "#999999", "#800080", "#D6544B")
PlotObjects <- c(SelectedIndVar,SelectedDepVar,"Seven Day MA Cases",OutlierName,"SLD Cases",loessVar)
ColorRule <- scale_color_manual(values = setNames(as.list(PlotColors), PlotObjects))


SecondAxisFormat <- list(#Second Axis components
  tickfont = list(size=11.7),
  titlefont=list(size=14.6),
  overlaying = "y",
  nticks = 4,
  dtick = 5e5,
  side = "right",
  title = paste(SelectedIndVar,"(GC/L)"),
  exponentformat = "e"
)


```



```{r DF Set Up, echo=FALSE}
BaseDir <- params$BaseDir#get the root of the directory where the data is stored
#All the Madison data is contained in these two files#MMSD_Cases_processed
MadisonCaseFN  <-  paste0(BaseDir, "COVID-19_WastewaterAnalysis/data/processed/MMSD_Interceptor_Cases_2_7_22.csv")
LIMSFN <- paste0(BaseDir, "COVID-19_WastewaterAnalysis/data/processed/LIMSWasteData_01-25-21_01-05-22.csv")


#Importing the Madison case data
LatCaseDF <- ParseData(MadisonCaseFN)%>% 
  mutate(SevenDayMACases = rollapply(data = !!sym(SelectedDepVar), width = 7, FUN = mean, 
                            na.rm = TRUE,fill=NA))%>%
  filter(Date>ymd("2020-9-10"))%>%
  select(Date, Site, SelectedDepVar,SevenDayMACases)
SiteData <- unique(LatCaseDF$Site)
#Importing the Madison waste water data
LIMSFullDF <- ParseData(LIMSFN)%>%
  filter(Site %in% SiteData)%>%
  mutate(N1Pure = ifelse(is.na(N1),N2,N1),
         N2Pure = ifelse(is.na(N2),N1,N2),
         GeoMeanN12 = exp((log(N1Pure)+log(N2Pure))/2))%>%
  select(Date, Site, N1, BCoV , N2 , PMMoV,
         GeoMeanN12,FlowRate,temperature,equiv_sewage_amt)

#joining the two data frames together
FullDF <- full_join(LatCaseDF,LIMSFullDF, by = c("Date","Site"))

unique(LIMSFullDF$Site)

```





# Data: The first look

The two data sets used in this analysis are the Madison case data sourced from the Wisconsin DHS and wastewater  concentration data produced by the Wisconsin State Laboratory of Hygiene. This wastewater data has entries every couple of days from `r format(min(LIMSFullDF$Date), "%d %B %Y")` to `r format(max(LIMSFullDF$Date), "%d %B %Y")`.

```{r First look, echo=FALSE}
#what does the data look like? 
FullDF%>%
  NoNa("N1")%>%
  head()%>%
  formattable()

#diff()
AVGLimsSample <- LIMSFullDF%>%
  NoNa(SelectedIndVar)%>%
  pull(Date)%>%
  sort()%>%
  diff()%>%
  mean()%>%
  as.numeric()

```

The case data has a strong weekend effect so for this section we look at a seven day smoothing of cases. The simple display of the data shows the core components of this story. First, wastewater data is noisy. And that there is a clear relationship between the two signals.

```{r BaseRelationship}
FirstImpresionFunc <- function(DF){
  FirstImpressionDF <- DF%>%
    NoNa(SelectedIndVar,SelectedDepVar)#Removing NA
  FirstImpressionGGplot = FirstImpressionDF%>%
  ggplot(aes(x=Date))+#Data depends on time
  geom_point(aes(y=!!sym(SelectedDepVar), color=SelectedDepVar,info=!!sym(SelectedDepVar)),size = 1)+
  geom_line(aes(y=MinMaxFixing(!!sym(SelectedIndVar),!!sym(SelectedDepVar)), 
                color=SelectedIndVar,
                info=!!sym(SelectedIndVar)))+#compares SelectedIndVar to Cases
  geom_line(aes(y=(SevenDayMACases), 
                color="Seven Day MA Cases",
                info=SevenDayMACases))+
  labs(y="Reported cases")+
    facet_wrap(~Site)
  return(ggplotly(FirstImpressionGGplot))
}
FirstImpresionFunc(filter(FullDF,Site=="Madison"))
FirstImpresionFunc(filter(FullDF,Site=="MMSD-P2"))
FirstImpresionFunc(filter(FullDF,Site=="MMSD-P7"))
FirstImpresionFunc(filter(FullDF,Site=="MMSD-P8"))
FirstImpresionFunc(filter(FullDF,Site=="MMSD-P11"))
FirstImpresionFunc(filter(FullDF,Site=="MMSD-P18"))

```
  

# Removing potential outliers

Looking at the wastewater measurements we observe there were some points many times larger than adjacent values hinting at them being outliers. We used the adjacent 10 values on each side and marked points 2.5 standard deviations away from the group mean as outliers.

```{r remove unusual Var data points}
OutlierRemoveFunc <- function(DF){
  ErrorMarkedDF <- DF%>%#
    mutate(FlagedOutliers = IdentifyOutliers(!!sym(SelectedIndVar),Bin = 21, Action = "Flag"),
           #Manual flagging that method misses due to boundary effect with binning
           FlagedOutliers = ifelse(Date == mdy("01/26/2021") | Date == mdy("01/27/2021"),
                                   TRUE, FlagedOutliers),
           NoOutlierVar = ifelse(FlagedOutliers, NA, !!sym(SelectedIndVar)))
  return(ErrorMarkedDF)
}
MadDF <- OutlierRemoveFunc(filter(FullDF,Site=="Madison"))
P2DF <- OutlierRemoveFunc(filter(FullDF,Site=="MMSD-P2"))
P7DF <- OutlierRemoveFunc(filter(FullDF,Site=="MMSD-P7"))
P8DF <- OutlierRemoveFunc(filter(FullDF,Site=="MMSD-P8"))
P11DF <- OutlierRemoveFunc(filter(FullDF,Site=="MMSD-P11"))
P18DF <- OutlierRemoveFunc(filter(FullDF,Site=="MMSD-P18"))

OutlierPlotFunc <- function(DF){
  #Split N1 into outlier and non outlier for next ggplot
OutLierPlotDF <- DF%>%
  mutate(!!OutlierName := ifelse(FlagedOutliers,!!sym(SelectedIndVar),NA))%>%
           mutate(!!SelectedIndVar := NoOutlierVar)

OutLierPlotObject <- OutLierPlotDF%>%
  filter(!(is.na(!!sym(SelectedIndVar))&is.na(!!sym(OutlierName))))%>%
  ggplot(aes(x=Date))+#Data depends on time 
  geom_line(aes(y=!!sym(SelectedIndVar),
                color=SelectedIndVar, 
                info = !!sym(SelectedIndVar)))+#compares Var to Cases
  geom_point(aes(y=!!sym(OutlierName),
                 color=OutlierName,
                 info = !!sym(OutlierName)))+
  ColorRule+
    facet_wrap(~Site)

#mentioned hand picked list other choices
ReturnPlot <- ggplotly(OutLierPlotObject,tooltip=c("info","Date"))%>%
    layout(yaxis = SecondAxisFormat,
           legend=list(title=list(text=''),x = 1.15, y = 0.9),
           margin = list(l = 50, r = 75, b = 50, t = 50, pad = 4))
return(ReturnPlot)
}
OutlierPlotFunc(MadDF)
OutlierPlotFunc(P2DF)
OutlierPlotFunc(P7DF)
OutlierPlotFunc(P8DF)
OutlierPlotFunc(P11DF)
OutlierPlotFunc(P18DF)



PrepOutlierFunc <- function(DF){
  #Drop Var create Var filter 
UpdatedDF <- DF%>%
  select(-sym(SelectedIndVar))%>%
  rename(!!sym(SelectedIndVar) := NoOutlierVar)
return(UpdatedDF)
}

#MadDF <- PrepOutlierFunc(MadDF)
#P2DF <- PrepOutlierFunc(P2DF)
#P7DF <- PrepOutlierFunc(P7DF)
#P8DF <- PrepOutlierFunc(P8DF)
#P11DF <- PrepOutlierFunc(P11DF)
#P18DF <- PrepOutlierFunc(P18DF)


#FullDF

DetectedMain <- MadDF%>%
  filter(FlagedOutliers)%>%
  select(Date,FlagedOutliers)

StevePlot <- FullDF%>%
  ggplot()+
  aes(x=Date)+
  geom_vline(aes(xintercept=Date),color="red",data=DetectedMain)+
  geom_point(aes(y=N1))+
  facet_wrap(~Site, scale = "free_y")

StevePlot


A <- MadDF%>%
  filter(FlagedOutliers)
B <- P2DF%>%
  filter(FlagedOutliers)
C <- P7DF%>%
  filter(FlagedOutliers)
D <- P8DF%>%
  filter(FlagedOutliers)
E <- P11DF%>%
  filter(FlagedOutliers)
fF <- P18DF%>%
  filter(FlagedOutliers)

AllErrors <- full_join(full_join(full_join(full_join(full_join(A,B),C),D),E),fF)

AllErrors

#On a given day we have 5 intercepters

OutlierPlotFunc(MadDF)
OutlierPlotFunc(P2DF)
OutlierPlotFunc(P7DF)
OutlierPlotFunc(P8DF)
OutlierPlotFunc(P11DF)
OutlierPlotFunc(P18DF)
AllErrors%>%
  ggplot()+
  aes(x=Date)+
  geom_point(aes(y=N1,color=Site),size=2)+
  geom_vline(xintercept = ymd("2021-04-26"))+
  geom_vline(xintercept = ymd("2021-11-18"))+
  facet_wrap(~Site, scale = "free_y")


AllErrors%>%
  filter(!is.na(N1))%>%
  group_by(Date)%>%
  summarize(n())






#"2021-01-26" 
#"2021-06-06"
#"2021-06-08"
#"2021-10-17"
#"2021-11-26"

"2021-04-26"
"2021-11-18"

#P2 error seen in madison: maybe?
#P7 error seen in madison: maybe?
#P8 error seen in madison: no
#P8 error seen in madison: no
#P18 error seen in madison: yes, sometimes
```



```{r loess smoothing and some intro CCF processes}

LoessPlotFunc <- function(DF,SpanConstant = .163){
  MainDF <- DF
  MainDF[[loessVar]] <- loessFit(y=(MainDF[[SelectedIndVar]]), 
                      x=MainDF$Date, #create loess fit of the data
                      span=SpanConstant, #span of .2 seems to give the best result, not rigorously chosen
                      iterations=2)$fitted#2 iterations remove some bad patterns
  
  MainDF <- MainDF%>%
    NoNa(loessVar,"SevenDayMACases")
  SLDLoessGraphic <- MainDF%>%
    ggplot(aes(x=Date))+
    geom_line(aes(y=!!sym(SelectedDepVar), color=SelectedDepVar , info = !!sym(SelectedDepVar)),alpha=.1)+
    geom_line(aes(y=MinMaxFixing(!!sym(SelectedIndVar),!!sym(SelectedDepVar)),
                color=SelectedIndVar,
                info = !!sym(SelectedIndVar)),
            alpha=.2)+
    geom_line(aes(y=SevenDayMACases,
                color="Seven Day MA Cases" , 
                info = SevenDayMACases))+
    geom_line(aes(y=MinMaxFixing(!!sym(loessVar),!!sym(SelectedDepVar),!!sym(SelectedIndVar)), 
                color=loessVar ,
                info = !!sym(loessVar)))+
    facet_wrap(~Site)+
    labs(y="Reported cases")


ReturnPlot <- ggplotly(SLDLoessGraphic,tooltip=c("info","Date"))%>%
    add_lines(x=~Date, y=MainDF[[SelectedIndVar]],
            yaxis="y2", data=MainDF, showlegend=FALSE, inherit=FALSE) %>%
    layout(yaxis2 = SecondAxisFormat,
           legend=list(title=list(text=''),x = 1.15, y = 0.9),
           margin = list(l = 50, r = 75, b = 50, t = 50, pad = 4))
return(ReturnPlot)
}


LoessPlotFunc(MadDF)
LoessPlotFunc(P2DF)
LoessPlotFunc(P7DF)
LoessPlotFunc(P8DF)
LoessPlotFunc(P11DF)
LoessPlotFunc(P18DF)
```


```{r flowstuff DataPrep}
OutlierDF <- MadDF%>%
  filter(FlagedOutliers)
FullDFMassRatio <- FullDF%>%
  filter(!is.na(N1))%>%
  mutate(SC2_mass = (3.785*1e6)*FlowRate*N1)


MissingIntercepter <- FullDFMassRatio%>%
  filter(Site!="Madison",!is.na(FlowRate)|!is.na(N1))%>%
  group_by(Date)%>%
  summarize(N = n())%>%
  filter(N!=5)


FullDFMassRatio.Mad <- FullDFMassRatio%>%
  filter(!is.na(SC2_mass))%>%
  filter(Site=="Madison")
FullDFMassRatio.Inter <- FullDFMassRatio%>%
  filter(!is.na(SC2_mass))%>%
  filter(Site!="Madison")#TempErrorMetric

TempErrorMetric <- FullDFMassRatio.Inter%>%
  group_by(Date)%>%
  summarise(InterSum = sum(SC2_mass),InterSumFlow = sum(FlowRate))%>%
  inner_join(FullDFMassRatio.Mad)%>%
  mutate(MassRatio = SC2_mass/InterSum,
         ErrorRatio = 2*(SC2_mass-InterSum)/(SC2_mass+InterSum),
         MassRatioFlow = FlowRate/InterSumFlow,
         ErrorRatioFlow = 2*(FlowRate-InterSumFlow)/(FlowRate+InterSumFlow))


FullDFMassRatio.Mad <- FullDFMassRatio%>%
  filter(!is.na(SC2_mass))%>%
  filter(Site=="Madison")%>%
  inner_join(FullDFMassRatio.Inter["Date"])
FullDFMassRatio.Inter <- FullDFMassRatio%>%
  filter(Site!="Madison")

```


```{r Stat Look}
TempErrorMetric%>%
  summarise(MeanError = mean(ErrorRatio, na.rm=TRUE),
            MeanRatio = mean(MassRatio, na.rm=TRUE),
            MedianError = median(ErrorRatio, na.rm=TRUE),
            MedianRatio = median(MassRatio, na.rm=TRUE),
            n())

ToMergeDF <- TempErrorMetric[c("Date","ErrorRatio","MassRatio","MassRatioFlow","ErrorRatioFlow")]

MadErrorRatioDF <- full_join(ToMergeDF,MadDF)%>%
  filter(!is.na(N1),!is.na(MassRatio),!is.na(MassRatio))
MadErrorRatioFilledDF <- MadErrorRatioDF%>%
  setorder(Date)%>%
  fill(ErrorRatio,MassRatio,.direction ="down")
  


MadErrorRatioDF%>%
  filter(!is.na(ErrorRatio))%>%
  group_by(FlagedOutliers)%>%
  summarise(MeanError = mean(ErrorRatio, na.rm=TRUE),
            MeanRatio = mean(MassRatio, na.rm=TRUE),
            MedianError = median(ErrorRatio, na.rm=TRUE),
            MedianRatio = median(MassRatio, na.rm=TRUE),
            n())
MadErrorRatioFilledDF%>%
  filter(!is.na(ErrorRatio))%>%
  group_by(FlagedOutliers)%>%
  summarise(MeanError = mean(ErrorRatio, na.rm=TRUE),
            MeanRatio = mean(MassRatio, na.rm=TRUE),
            MedianError = median(ErrorRatio, na.rm=TRUE),
            MedianRatio = median(MassRatio, na.rm=TRUE),
            n())


HighRatioVec <- ToMergeDF%>%
  filter(MassRatio>1.5)



MadErrorRatioFilledDF%>%
  filter(FlagedOutliers)

MadErrorRatioDF%>%
  ggplot()+
  aes(x=MassRatio,y=N1,color = FlagedOutliers)+
  geom_point(size=5,alpha=.5)+
  scale_y_log10()+
  scale_x_log10()+
  ggtitle("FlagedOutlier vs N1")

MadErrorRatioFilledDF%>%
  ggplot()+
  aes(x=MassRatio,y=N1,color = FlagedOutliers)+
  geom_point(size=5,alpha=.5)+
  scale_y_log10()+
  scale_x_log10()+
  ggtitle("FlagedOutlier vs N1 Filled Data")


t.test(ErrorRatio ~ FlagedOutliers, data = MadErrorRatioFilledDF)



#MadErrorRatioFilledDF
#MadErrorRatioDF
MadErrorRatioDF%>%
  ggplot()+
  aes(x=MassRatioFlow,y=MassRatio,color=FlagedOutliers)+
  geom_point(size=5,alpha=.5)+
  ggtitle("FlowRatio vs MassFlow")


MadErrorRatioDF%>%
  filter(MassRatioFlow==1)
```


```{r Outlier}
KeyOulierPoints <- c(ymd("2021-06-08"),
                     ymd("2021-10-17"),
                     ymd("2021-05-02"),
                     ymd("2021-01-26"))

OutLierPlotDF <- MadDF%>%
  mutate(Outlier = ifelse(FlagedOutliers,N1,NA))%>%
           mutate(N1 = NoOutlierVar)%>%
  filter(!(is.na(N1)&is.na(Outlier)))%>%
  ggplot(aes(x=Date))+#Data depends on time 
  geom_line(aes(y=N1,
                color="N1", 
                info = !!sym(SelectedIndVar)))+#compares Var to Cases
  geom_point(aes(y=Outlier,
                 color="N1 Outlier",
                 info = Outlier))+
  scale_color_manual(values=c("#F8766D","#999999")) #+
  #geom_vline(xintercept = KeyOulierPoints)+
    #geom_vline(xintercept = MissingIntercepter$Date,color="Red")+
    facet_wrap(~Site)


ggplotly(OutLierPlotDF)
#"2021-06-08","2021-10-17","2021-05-02","2021-01-26"
```

```{r Flow total}

FlowPlot <- FullDFMassRatio.Inter%>%
  filter(!is.na(FlowRate))%>%
  ggplot()+
  geom_bar(aes(x=Date,y=FlowRate,fill=Site),position="stack", stat="identity", width = 3) + 
  scale_fill_brewer(palette="Spectral") +
  scale_color_manual(values=c("#d60000", "#ffa600", "#7ed05c", "#5c9c43", "#3a56d6")) +
  theme_light() +
  geom_line(data=FullDFMassRatio.Mad,aes(x=Date,y=FlowRate),size=.5)+
  ylab("Average daily flow (MGD)") +
  geom_hline(yintercept=median(FullDFMassRatio.Mad$FlowRate), linetype = "dashed", color="black") +
  #geom_vline(xintercept = KeyOulierPoints)+
  #geom_vline(xintercept = MissingIntercepter$Date,color="Red")+
  ggtitle("Average daily flow (MMSD)")

ggplotly(FlowPlot)


FullDF%>%
  filter(Date==mdy("4-15-2021"))
```

```{r MassRatio}
MassBalencePlot <- FullDFMassRatio.Inter%>%
  filter(!is.na(FlowRate))%>%
  ggplot()+
  geom_bar(aes(x=Date,y=SC2_mass,fill=Site),position="stack", stat="identity", width = 3) + 
  scale_fill_brewer(palette="Spectral") +
  scale_color_manual(values=c("#d60000", "#ffa600", "#7ed05c", "#5c9c43", "#3a56d6")) +
  theme_light() +
  geom_point(data=FullDFMassRatio.Mad,aes(x=Date,y=SC2_mass),size=1)+
  ylab("N1/N2 gene copies per day") +
  geom_hline(yintercept=median(FullDFMassRatio.Mad$SC2_mass), color="red") +
  
  ggtitle("SARS-CoV-2, 24h Mass Loading (Madison)")
  

ggplotly(MassBalencePlot)
#4-15
```

```{r MassRatio massRatio}
MassBalencePlot2 <- FullDFMassRatio.Inter%>%
  filter(!is.na(FlowRate))%>%
  ggplot()+
  geom_bar(aes(x=Date,y=FirstConfirmed,fill=Site),position="stack", stat="identity", width = 3) + 
  scale_fill_brewer(palette="Spectral") +
  scale_color_manual(values=c("##29ffff", "#0059ff", "#812fa3", "#a363bc", "#c5a929")) +
  theme_light() +
  geom_point(data=FullDFMassRatio.Mad,aes(x=Date,y=FirstConfirmed),size=1)+
  ylab("N1/N2 gene copies per day") +
  geom_hline(yintercept=median(FullDFMassRatio.Mad$FirstConfirmed), color="red") +
  ggtitle("Cases, 24h Mass Loading (Madison)")

ggplotly(MassBalencePlot)

unique(inner_join(FullDFMassRatio.Inter,OutlierDF["Date"],by=c("Date"))$Date)
```

```{r SC2MassRatio}

#ggplotly(OutLierPlotDF)
#ggplotly(MassBalencePlot)
#ggplotly(FlowPlot)

#OutlierDF
a <- OutLierPlotDF+
  geom_vline(xintercept = AllOuliersDates,color="Red")+
  geom_vline(xintercept = OutlierDatesIntercepters)+
  #geom_vline(xintercept = MissingIntercepter$Date,color="Red")+
  theme(title = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x = element_blank())
b <- MassBalencePlot+
  geom_vline(xintercept = AllOuliersDates,color="Red")+
  geom_vline(xintercept = OutlierDatesIntercepters)+
  #geom_vline(xintercept = MissingIntercepter$Date,color="Red")+
  theme(title = element_blank(),
    axis.text.x = element_blank(), 
        axis.title.x = element_blank())
c <- FlowPlot+
  geom_vline(xintercept = OutlierDF$Date)+
  #geom_vline(xintercept = MissingIntercepter$Date,color="Red")+
  theme(title = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x = element_blank())
library(ggpubr)
ggarrange(a,b,c,nrow=3,align ="v")


#FullDFMassRatio.Inter%>%
#  filter(Date==ymd("2021-04-15"))
#MMSD-P18/P7
#2021-04-15

OutLierPlotDF
ggarrange(a,b,nrow=3,align ="v")

FullDFMassRatio.Inter
AllOuliersDates <- OutlierDF[["Date"]]
OutlierDatesIntercepters <- unique(inner_join(FullDFMassRatio.Inter,OutlierDF["Date"],by=c("Date"))$Date)
```


