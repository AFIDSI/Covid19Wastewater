---
title: "Using HFG Data to predict range of posible values"
author: "Marlin"
date: "6/2/2021"
output:
  pdf_document: default
  html_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


```{r Importing, include=FALSE}
library(ggpubr)
library(dplyr)

#Data Files and prepwork
source("../../lib/GenPlotMaking.R")
source("../../lib/WastewaterDataProccess.R")
source("../../lib/CasesDataProccess.R")
source("../../lib/HelperFunctions.R")
source("../../lib/WasteShiny/PrepData.R", local = TRUE)
#"../../../HFG data for stats corrected 071421.xlsx"
```






Clear linear relationship between N1 and its standard deviations

```{r Varience within groups}

HFGFrame%>%
  select(Date,Site,'Filter replicates',N1)%>%
  group_by(Site,Date)%>%
  summarize(mN1=exp(mean(log(N1))),vN1=var(N1))%>%
  ggplot()+geom_point(aes(x=mN1,y=sqrt(vN1),color=Site))+
  scale_y_log10()+scale_x_log10()+ggtitle("Mean vs Standard deviation of 9 points")

HFGVarNine=HFGFrame%>%
  select(Date,Site,'Filter replicates',N1)%>%
  group_by(Site,Date)%>%
  summarize(mN1=mean(N1),vN1=var(N1))%>%
  filter(!is.na(mN1),!is.na(vN1))


cor(HFGVarNine$mN1,sqrt(HFGVarNine$vN1))

HFGFrame%>%
  select(Date,Site,'Filter replicates',N1)%>%
  group_by(Site,Date,'Filter replicates')%>%
  summarize(mN1=mean(N1),vN1=var(N1))%>%
  ggplot()+geom_point(aes(x=mN1,y=sqrt(vN1),color=Site))+
  scale_y_log10()+
  scale_x_log10()+
  ggtitle("Mean vs Standard deviation of 3 points")



HFGVarThree=HFGFrame%>%
  select(Date,Site,'Filter replicates',N1)%>%
  group_by(Site,Date,'Filter replicates')%>%
  summarize(mN1=mean(N1),vN1=var(N1))


cor(HFGVarThree$mN1,sqrt(HFGVarThree$vN1),use="pairwise.complete.obs")
cor(HFGVarThree$mN1,HFGVarThree$vN1,use="pairwise.complete.obs")

# cases
# LM
# SD
# mean line
# collection, analysis
#
#
```




Generated LM from relationship

```{r validating,fig.height = 15, fig.width = 15,include=F}
T=8

HFGVar=HFGFrame%>%
  select(Date,Site,N1,Pct_BCoV)%>%
  filter(N1<10e7)%>%
  group_by(Site,Date)%>%
  summarize(mN1=mean(N1),vN1=var(N1),VBC=mean(Pct_BCoV),VBC=mean(Pct_BCoV))



LM=lm(data=HFGVar,sqrt(vN1)~mN1-1)

LM

# HFGFrame%>%
#   select(Date,Site,N1,'Filter replicates')%>%
#   mutate(lower=N1-1.860*sqrt(207167*N1)/sqrt(9))%>%
#   mutate(Upper=N1+1.860*sqrt(207167*N1)/sqrt(9))%>%
#   #mutate(contzero=lower<0&Upper>0)
#   ggplot()+
#   geom_rect(aes(fill='Filter replicates',ymin=lower,ymax=Upper,xmin=Date-.3,xmax=Date+.3),alpha=.1)+
#   geom_point(aes(x=Date,y=N1,color='Filter replicates'))+scale_y_log10()+facet_wrap(~Site)

```

```{r Extend to general data varience,fig.height = 15, fig.width = 15,include=F}
LatWasteDF%>%
  select(Date,Site,N1)%>%
  mutate(lower=N1-2*0.2196*N1)%>%
  mutate(Upper=N1+2*0.2196*N1)%>%
  #mutate(contzero=lower<0&Upper>0)
  ggplot()+
  geom_rect(aes(ymin=lower,ymax=Upper,xmin=Date-1,xmax=Date+1),fill="red",alpha=.1)+
  geom_point(aes(x=Date,y=N1))+facet_wrap(~Site)


```

using the strong relationship we can predict the standard deviation of the point to get a better understanding of the possible true values

```{r Compare madison method,fig.height = 15, fig.width = 15}
LatData=LatWasteDF%>%
  filter((Site=="Madison"))%>%
  select(Date,Site,N1)%>%
  mutate(lower=N1-2*0.2199*N1)%>%
  mutate(Upper=N1+2*0.2199*N1)
HFGData=HFGFrame%>%
  filter((Site=="Madison"))

#??lat data off shifted by one day??
N1Start=min(HFGFrame$Date)
N1End=max(HFGFrame$Date)


ggplot()+
  geom_rect(aes(ymin=lower,ymax=Upper,xmin=Date-1.3,xmax=Date-.7),fill="red",alpha=.1,data=LatData)+
  geom_point(aes(y=N1,color='Filter replicates',x=Date,shape="High Frequency"),data=HFGData)+
  geom_point(aes(y=N1,x=Date-1,shape="Longitudinal"),data=LatData,size=2.5)+
  scale_y_log10()+
  scale_x_date(limits=c(N1Start,N1End))+
  ggtitle("Waste data and predicted 2 standard deviations")

#'Filter replicates' on variance
#
```

```{r Extend,fig.height = 15, fig.width = 15}
LatData=LatWasteDF%>%
  select(Date,Site,N1)%>%
  mutate(lower=N1-2*0.2196*N1)%>%
  mutate(Upper=N1+2*0.2196*N1)

#??lat data off shifted by one day??
N1Start=min(HFGFrame$Date)
N1End=max(HFGFrame$Date)


ggplot()+
  geom_rect(aes(ymin=lower,ymax=Upper,xmin=Date-1,xmax=Date+1),fill="red",alpha=.1,data=LatData)+
  geom_point(aes(y=N1,x=Date),data=LatData,size=2.5)+
  facet_wrap(~Site)+
  scale_y_log10()+
  ggtitle("Waste data and predicted 2 standard deviations")

```

